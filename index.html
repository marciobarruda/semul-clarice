<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Prontu√°rio Eletr√¥nico ‚Ä¢ CRCL</title>
    <link
      rel="icon"
      href="https://statics.recife.pe.gov.br/images/dynamics/conecta/icons/favicon.png?w=32&h=32&fit=fill&border=2,transparent,shrink"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" rel="stylesheet" />
    <style>
      :root {
        --brand-primary: #0053a4;
        --brand-secondary: #003a73;
        --brand-highlight: #00a3ff;
        --surface: #f4f7fb;
        --surface-strong: #ffffff;
        --border-color: #d0d7e2;
        --text-strong: #1b263b;
        --text-muted: #5b6c8c;
        --form-nav-offset: clamp(1rem, 1.5vw + 0.5rem, 2.25rem);
        --form-nav-sticky-top: clamp(6rem, 2.5vw + 5rem, 7.5rem);
      }

      *, *::before, *::after {
        box-sizing: border-box;
      }

      body {
        font-family: "Public Sans", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: var(--surface);
        color: var(--text-strong);
        min-height: 100vh;
      }

      header.site-header {
        background: url("https://statics.recife.pe.gov.br/images/dynamics/automacao/header.png?w=3000")
          center/cover no-repeat;
        color: #ffffff;
        padding: 3.5rem 0 2.75rem;
      }

      header .lead {
        color: rgba(255, 255, 255, 0.82);
        max-width: 100%;
        font-size: 1rem;
        line-height: 1.65;
        text-align: justify;
      }

      .badge-open {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.95rem;
        font-weight: 600;
        padding: 0.45rem 0.9rem;
        border-radius: 999px;
        background-color: rgba(255, 255, 255, 0.14);
      }

      .user-greeting {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 1.05rem;
        font-weight: 600;
        margin-bottom: 2rem;
        padding: 1rem 1.5rem;
        border-radius: 1rem;
        background: linear-gradient(135deg, rgba(0, 83, 164, 0.09), rgba(0, 163, 255, 0.12));
        color: var(--text-strong);
        box-shadow: 0 10px 30px rgba(0, 45, 98, 0.08);
      }

      .user-greeting::before {
        content: "üëã";
        font-size: 1.4rem;
      }

      .minhas-inscricoes-grid {
        margin-top: 1rem;
      }

      .minhas-inscricao-card {
        cursor: pointer;
        transition: transform 0.18s ease, box-shadow 0.18s ease;
        border: 1px solid rgba(0, 83, 164, 0.12);
        border-radius: 4px;
      }

      .minhas-inscricao-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 30px rgba(0, 45, 98, 0.12);
      }

      .minhas-inscricao-card.is-loading {
        pointer-events: none;
        opacity: 0.7;
      }

      .minhas-inscricoes-placeholder {
        padding: 1.25rem;
        border-radius: 4px;
        background: rgba(0, 83, 164, 0.05);
        border: 1px dashed rgba(0, 83, 164, 0.2);
        color: var(--text-muted);
      }

      .resumo-inscricao-list dt {
        font-size: 0.75rem;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        color: var(--text-muted);
      }

      .resumo-inscricao-list dd {
        font-weight: 600;
        color: var(--text-strong);
      }

      .section-title {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
        font-weight: 600;
      }

      .section-title .icon-wrapper {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 0.75rem;
        background: rgba(0, 83, 164, 0.12);
        color: var(--brand-primary);
        font-size: 1.25rem;
      }

      .kpi-card {
        border-radius: 1rem;
        background: var(--surface-strong);
        border: 1px solid rgba(0, 0, 0, 0.04);
        box-shadow: 0 12px 30px rgba(24, 64, 120, 0.08);
        padding: 1.5rem;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .kpi-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 18px 40px rgba(24, 64, 120, 0.12);
      }

      .kpi-card .icon {
        width: 3rem;
        height: 3rem;
        border-radius: 0.85rem;
        background: rgba(0, 83, 164, 0.12);
        color: var(--brand-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin-bottom: 1rem;
      }

      .kpi-card .value {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.25rem;
      }

      .card-section {
        border: 1px solid var(--border-color);
        border-radius: 1rem;
        background: var(--surface-strong);
        box-shadow: 0 12px 30px rgba(24, 64, 120, 0.08);
        padding: 1.75rem;
        height: 100%;
        scroll-margin-top: calc(9rem + var(--form-nav-offset, 1.5rem));
      }

      .card-section + .card-section {
        margin-top: 1.5rem;
      }

      #registroFieldset {
        border: 0;
        margin: 0;
        padding: 0;
        min-width: auto;
      }

      .field-cpf,
      .nome-completo-field,
      .nome-social-field {
        flex: 0 0 100%;
        max-width: 100%;
      }

      .field-cpf .cpf-input {
        width: 100%;
        min-width: 14.5ch;
        max-width: 16.5ch;
      }

      .form-sections-layout {
        align-items: flex-start;
      }

      .form-section-sidebar {
        position: sticky;
        top: var(--form-nav-sticky-top);
        align-self: stretch;
      }

      .form-section-nav {
        position: sticky;
        top: var(--form-nav-sticky-top);
        z-index: 1030;
        background: rgba(244, 247, 251, 0.96);
        border: 1px solid rgba(0, 83, 164, 0.15);
        border-radius: 1rem;
        padding: 1.75rem 2rem;
        box-shadow: 0 12px 30px rgba(0, 45, 98, 0.12);
        backdrop-filter: blur(6px);
        max-height: none;
        min-height: auto;
        overflow: visible;
      }

      @media (max-width: 1199.98px) {
        .form-section-nav {
          position: static;
          max-height: none;
          min-height: 0;
          padding: 1.25rem 1.5rem;
          overflow: visible;
        }
      }

      .form-section-sidebar-toggle {
        display: none;
      }

      @media (max-width: 1199.98px) {
        .form-section-sidebar-toggle {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          gap: 0.5rem;
          font-weight: 600;
        }
      }

      .form-section-nav .nav-label {
        font-size: 0.75rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--text-muted);
        margin-bottom: 0.5rem;
        display: block;
      }

      .section-nav-list {
        display: grid;
        gap: 0.5rem;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      }

      @media (min-width: 1200px) {
        .section-nav-list {
          display: flex;
          flex-direction: column;
        }
      }

      @media (min-width: 992px) {
        .card-section .form-label {
          white-space: nowrap;
        }
      }

      .dados-saude-section .form-label {
        white-space: normal;
      }

      .section-nav-link {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.45rem 0.95rem;
        border-radius: 999px;
        text-decoration: none;
        font-weight: 500;
        font-size: 0.9rem;
        background: rgba(0, 83, 164, 0.08);
        color: var(--brand-primary);
        transition: background-color 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
        width: 100%;
        justify-content: flex-start;
      }

      .section-nav-link .bi {
        font-size: 1rem;
      }

      .section-nav-link:hover,
      .section-nav-link:focus {
        background: rgba(0, 83, 164, 0.18);
        color: var(--brand-secondary);
        box-shadow: 0 6px 16px rgba(0, 45, 98, 0.15);
      }

      .section-nav-link.active {
        background: var(--brand-primary);
        color: #ffffff;
        box-shadow: 0 8px 18px rgba(0, 45, 98, 0.2);
      }

      .subsection-card {
        border: 1px solid rgba(0, 83, 164, 0.12);
        border-radius: 0.85rem;
        background: #ffffff;
        padding: 1.5rem;
        height: 100%;
      }

      .subsection-title {
        font-size: 0.95rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--brand-primary);
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .modal-footer.sticky-actions {
        position: sticky;
        bottom: 0;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(6px);
        border-top: 1px solid rgba(0, 83, 164, 0.12);
        box-shadow: 0 -8px 20px rgba(13, 35, 70, 0.08);
        z-index: 5;
      }

      .modal-stack-muted {
        pointer-events: none;
      }

      .modal-stack-muted .modal-dialog,
      .modal-stack-muted .modal-content {
        pointer-events: none;
      }

      .modal-dialog-scrollable .modal-body {
        max-height: calc(100vh - 5rem);
        overflow-y: auto;
      }

      #registroModal .modal-dialog {
        max-width: min(1380px, 98vw);
      }

      #registroModal .modal-dialog.modal-dialog-scrollable {
        height: calc(100vh - 2rem);
      }

      #registroModal .modal-dialog.modal-dialog-scrollable .modal-content {
        max-height: 100%;
      }

      #autorModal .modal-dialog,
      #familiaModal .modal-dialog {
        max-width: min(1280px, 96vw);
      }

      #autorEnderecoCampos.is-synchronized {
        position: relative;
      }

      #autorEnderecoCampos.is-synchronized::after {
        content: "Endere√ßo sincronizado com a v√≠tima";
        position: absolute;
        top: -0.75rem;
        right: 1rem;
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--brand-primary);
        background: rgba(0, 163, 255, 0.12);
        padding: 0.25rem 0.75rem;
        border-radius: 999px;
      }

      @media (max-width: 991.98px) {
        .form-section-sidebar {
          position: static;
        }

        .form-section-nav {
          max-height: none;
          margin-bottom: 1.5rem;
          padding: 0.75rem 1rem;
        }

        .section-nav-list {
          gap: 0.75rem 0.5rem;
        }

        .section-nav-link {
          flex: 1 1 calc(50% - 0.5rem);
          justify-content: center;
        }
      }

      @media (min-width: 992px) {
        .section-nav-list {
          flex-direction: column;
          gap: 0.5rem;
        }

        .section-nav-link {
          justify-content: flex-start;
          width: 100%;
        }
      }

      .subsection-card {
        border: 1px dashed rgba(0, 83, 164, 0.25);
        border-radius: 0.85rem;
        background: rgba(0, 83, 164, 0.04);
        padding: 1.25rem;
      }

      .subsection-heading {
        font-size: 0.9rem;
        font-weight: 700;
        text-transform: uppercase;
        color: var(--brand-primary);
        letter-spacing: 0.05em;
        margin-bottom: 1rem;
      }

      .section-header {
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 0.75rem;
        margin-bottom: 1.25rem;
      }

      .prontuario-highlight {
        display: inline-flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 0.25rem;
        background: rgba(0, 83, 164, 0.08);
        border: 1px solid rgba(0, 83, 164, 0.25);
        border-radius: 0.9rem;
        padding: 0.65rem 1.1rem;
        min-width: 12rem;
      }

      .prontuario-highlight-label {
        font-size: 0.75rem;
        font-weight: 600;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--brand-secondary);
        margin: 0;
      }

      .prontuario-highlight-value {
        font-size: 1.05rem;
        font-weight: 700;
        color: var(--brand-primary);
        margin: 0;
      }

      .required::after {
        content: "*";
        color: #d32f2f;
        margin-left: 0.25rem;
      }

      .legend-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        font-size: 0.85rem;
        color: var(--brand-secondary);
        background: rgba(0, 83, 164, 0.12);
        padding: 0.35rem 0.75rem;
        border-radius: 999px;
      }

      .consulta-prontuario-group .input-group-text {
        background: rgba(0, 83, 164, 0.12);
        color: var(--brand-primary);
        border-width: 2px;
        border-color: rgba(0, 83, 164, 0.35);
      }

      .consulta-prontuario-input {
        border-width: 2px;
        border-color: rgba(0, 83, 164, 0.35);
        box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
        background: rgba(0, 83, 164, 0.04);
      }

      .consulta-prontuario-input:focus {
        border-color: var(--brand-primary);
        box-shadow: 0 0 0 0.25rem rgba(0, 83, 164, 0.2);
        background: #ffffff;
      }

      .tooltip-inner {
        text-align: left;
      }

      .readonly-field {
        background-color: #f8f9fa !important;
      }

      .text-pre-wrap {
        white-space: pre-line;
      }

      textarea.form-control {
        min-height: 10rem;
      }

      .btn-outline-primary:focus-visible,
      .form-control:focus,
      .form-select:focus,
      .form-check-input:focus {
        box-shadow: 0 0 0 0.25rem rgba(0, 83, 164, 0.25);
        border-color: var(--brand-highlight);
      }

      .border-dashed {
        border-style: dashed !important;
      }

      .banner-card {
        background: linear-gradient(135deg, rgba(120, 58, 163, 0.85), rgba(235, 129, 162, 0.9)),
          url("https://images.unsplash.com/photo-1521737604893-d14cc237f11d?auto=format&fit=crop&w=800&q=80") center/cover;
        border-radius: 1rem;
        color: #fff;
        padding: 2rem;
        min-height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        box-shadow: 0 18px 45px rgba(94, 33, 123, 0.28);
      }

      .banner-card .btn {
        align-self: flex-start;
      }

      .timeline-item {
        position: relative;
        padding-left: 1.75rem;
      }

      .timeline-item::before {
        content: "";
        position: absolute;
        left: 0.5rem;
        top: 0.35rem;
        width: 0.5rem;
        height: 0.5rem;
        background: var(--brand-highlight);
        border-radius: 50%;
      }

      .timeline-item + .timeline-item {
        margin-top: 1rem;
      }

      footer {
        color: var(--text-muted);
        padding: 2.5rem 0 2rem;
        font-size: 0.9rem;
      }

      .tab-content {
        margin-top: 2rem;
      }

      .nav-tabs .nav-link.active {
        background: var(--surface-strong);
        border-color: var(--border-color) var(--border-color) var(--surface-strong);
        color: var(--brand-primary);
        font-weight: 600;
      }

      .nav-tabs .nav-link {
        color: var(--text-muted);
        font-weight: 500;
      }

      .form-section-title {
        font-weight: 600;
        font-size: 1.1rem;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        scroll-margin-top: calc(6.5rem + var(--form-nav-offset, 1.5rem));
      }

      .form-section-title .bi {
        color: var(--brand-primary);
      }

      .floating-toolbar {
        position: sticky;
        top: 1rem;
        z-index: 1020;
      }

      .sticky-modal-footer {
        position: sticky;
        bottom: 0;
        background-color: #ffffff;
        border-top: 1px solid var(--border-color);
        box-shadow: 0 -6px 18px rgba(0, 45, 98, 0.08);
      }

      #registroModalBody {
        max-height: none;
      }

      #registroModalBody .form-section-sidebar {
        position: static;
      }

      #registroModalBody .form-section-nav {
        top: 0;
      }

      .toast-header {
        background: var(--brand-primary);
        color: #fff;
      }

      @media (max-width: 992px) {
        header.site-header {
          padding: 2.5rem 0 2rem;
        }

        .badge-open {
          width: 100%;
          justify-content: center;
        }

        .banner-card {
          margin-top: 1.5rem;
        }

        .floating-toolbar {
          position: static;
          margin-top: 1.5rem;
        }
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/imask@7.1.3/dist/imask.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/just-validate@4.3.0/dist/just-validate.production.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.11/dayjs.min.js" defer></script>
  </head>
  <body>
    <div class="toast-container position-fixed top-0 end-0 p-3" aria-live="polite" aria-atomic="true">
      <div class="toast align-items-center" id="successToast" role="status" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
          <i class="bi bi-check-circle-fill me-2"></i>
          <strong class="me-auto">Registro salvo</strong>
          <button type="button" class="btn-close btn-close-white ms-2 mb-1" data-bs-dismiss="toast" aria-label="Fechar"></button>
        </div>
        <div class="toast-body">Dados enviados com sucesso para a Rede de Enfrentamento.</div>
      </div>
    </div>

    <header class="site-header">
      <div class="container">
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-3">
          <div class="d-flex align-items-center gap-3">
            <img
              src="https://statics.recife.pe.gov.br/images/dynamics/conecta/logo_prefeitura_recife.png?w=280"
              alt="Prefeitura do Recife"
              class="img-fluid"
              style="max-width: 180px"
            />
            <div>
              <span class="badge-open text-uppercase">Secretaria da Mulher</span>
              <h1 class="h3 mb-1">Rede de Enfrentamento √† Viol√™ncia Contra a Mulher</h1>
              <p class="lead mb-0">Centro de Refer√™ncia Clarice Lispector ‚Äî acolhimento, prote√ß√£o e a√ß√µes integradas para as mulheres do Recife.</p>
            </div>
          </div>
          <div class="d-flex align-items-center gap-2 text-white">
            <button class="btn btn-outline-light btn-sm" type="button" aria-label="Central de notifica√ß√µes">
              <i class="bi bi-bell-fill"></i>
            </button>
            <button class="btn btn-outline-light btn-sm" type="button" aria-label="Acesso r√°pido ao perfil">
              <i class="bi bi-person-circle"></i>
            </button>
          </div>
        </div>
      </div>
    </header>

    <main>
      <div class="container py-5">
        <div class="user-greeting" role="status">Bem-vinda, Ana Paula ‚Äî acompanhe os casos e encaminhamentos da rede de prote√ß√£o.</div>

        <div class="d-flex flex-column flex-lg-row gap-3 mb-4 align-items-lg-center">
          <ul class="nav nav-tabs" id="portalTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="home-tab" data-bs-toggle="tab" data-bs-target="#home" type="button" role="tab" aria-controls="home" aria-selected="true">
                <i class="bi bi-house-door me-1"></i>
                Home
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="prontuarios-tab" data-bs-toggle="tab" data-bs-target="#prontuarios" type="button" role="tab" aria-controls="prontuarios" aria-selected="false">
                <i class="bi bi-folder2-open me-1"></i>
                Prontu√°rios
              </button>
            </li>
          </ul>
        </div>

        <div class="tab-content" id="portalTabsContent">
          <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
            <div class="row g-4 mb-4">
              <div class="col-12 col-md-6 col-xl-3">
                <div class="kpi-card h-100" role="group" aria-label="Total de prontu√°rios cadastrados">
                  <div class="icon"><i class="bi bi-people-fill"></i></div>
                  <div class="value" aria-live="polite">1.482</div>
                  <p class="mb-0 text-muted">Prontu√°rios cadastrados</p>
                  <small class="text-success fw-semibold"><i class="bi bi-arrow-up-right me-1"></i>+8% vs. m√™s anterior</small>
                </div>
              </div>
              <div class="col-12 col-md-6 col-xl-3">
                <div class="kpi-card h-100" role="group" aria-label="Atendimentos ativos">
                  <div class="icon"><i class="bi bi-activity"></i></div>
                  <div class="value">327</div>
                  <p class="mb-0 text-muted">Atendimentos ativos</p>
                  <small class="text-success fw-semibold"><i class="bi bi-lightning-charge-fill me-1"></i>Ativa√ß√µes em tempo real</small>
                </div>
              </div>
              <div class="col-12 col-md-6 col-xl-3">
                <div class="kpi-card h-100" role="group" aria-label="Medidas protetivas">
                  <div class="icon"><i class="bi bi-shield-lock"></i></div>
                  <div class="value">214</div>
                  <p class="mb-0 text-muted">Medidas protetivas acompanhadas</p>
                  <small class="text-muted">34 aguardando despacho</small>
                </div>
              </div>
              <div class="col-12 col-md-6 col-xl-3">
                <div class="kpi-card h-100" role="group" aria-label="Encaminhamentos">
                  <div class="icon"><i class="bi bi-signpost-2"></i></div>
                  <div class="value">96</div>
                  <p class="mb-0 text-muted">Encaminhamentos realizados</p>
                  <small class="text-danger fw-semibold"><i class="bi bi-arrow-down-right me-1"></i>-3% vs. √∫ltimo m√™s</small>
                </div>
              </div>
            </div>

            <div class="row g-4 align-items-stretch">
              <div class="col-12 col-xl-8 d-flex flex-column gap-4">
                <section class="card-section" aria-labelledby="busca-casos">
                  <div class="section-header d-flex justify-content-between align-items-center">
                    <h2 class="h5 mb-0" id="busca-casos">Busca e filtros inteligentes</h2>
                    <span class="legend-badge"><i class="bi bi-search me-1"></i>Pesquisa avan√ßada</span>
                  </div>
                  <form class="row g-3" role="search" aria-label="Buscar prontu√°rios">
                    <div class="col-12 col-md-4">
                      <label for="buscaNome" class="form-label">Nome da usu√°ria</label>
                      <input type="text" class="form-control" id="buscaNome" />
                    </div>
                    <div class="col-12 col-md-4">
                      <label for="buscaDocumento" class="form-label">CPF</label>
                      <input type="text" class="form-control" id="buscaDocumento" />
                    </div>
                    <div class="col-12 col-md-4">
                      <label for="buscaSituacao" class="form-label">Situa√ß√£o</label>
                      <select class="form-select" id="buscaSituacao">
                        <option value="">Todas</option>
                        <option>Ativo</option>
                        <option>Em an√°lise</option>
                        <option>Encerrado</option>
                      </select>
                    </div>
                    <div class="col-12 col-md-4">
                      <label for="buscaTipificacao" class="form-label">Tipifica√ß√£o</label>
                      <select class="form-select" id="buscaTipificacao">
                        <option value="">Todas</option>
                        <option>Viol√™ncia f√≠sica</option>
                        <option>Viol√™ncia psicol√≥gica</option>
                        <option>Viol√™ncia sexual</option>
                        <option>Viol√™ncia moral</option>
                        <option>Viol√™ncia patrimonial</option>
                      </select>
                    </div>
                    <div class="col-12 col-md-4">
                      <label for="buscaPeriodo" class="form-label">Per√≠odo</label>
                      <input type="month" class="form-control" id="buscaPeriodo" />
                    </div>
                    <div class="col-12 col-md-4">
                      <label for="buscaEncaminhamento" class="form-label">Encaminhamento</label>
                      <select class="form-select" id="buscaEncaminhamento">
                        <option value="">Todos</option>
                        <option>Delegacia da Mulher</option>
                        <option>CREAS</option>
                        <option>Sa√∫de</option>
                        <option>Assist√™ncia social</option>
                      </select>
                    </div>
                    <div class="col-12 d-flex justify-content-end gap-2">
                      <button class="btn btn-outline-secondary" type="reset">Limpar</button>
                      <button class="btn btn-primary" type="button">Aplicar filtros</button>
                    </div>
                  </form>
                </section>

                <section class="card-section" aria-labelledby="minhas-tarefas">
                  <div class="section-header d-flex justify-content-between align-items-center">
                    <h2 class="h5 mb-0" id="minhas-tarefas">Minhas tarefas</h2>
                    <a href="#" class="btn btn-sm btn-outline-primary">Ver agenda</a>
                  </div>
                  <div class="row g-4">
                    <div class="col-12 col-lg-6">
                      <div class="border rounded-3 p-3 h-100">
                        <h3 class="h6 d-flex align-items-center gap-2 mb-1">
                          <i class="bi bi-calendar-check text-primary"></i>
                          Retorno psicossocial
                        </h3>
                        <p class="mb-2 text-muted">Agendado para 14/05 √†s 10h ‚Äî Unidade Casa Amarela.</p>
                        <span class="badge bg-primary-subtle text-primary">Prontu√°rio #2023-541</span>
                      </div>
                    </div>
                    <div class="col-12 col-lg-6">
                      <div class="border rounded-3 p-3 h-100">
                        <h3 class="h6 d-flex align-items-center gap-2 mb-1">
                          <i class="bi bi-chat-square-text text-primary"></i>
                          Atualizar medidas protetivas
                        </h3>
                        <p class="mb-2 text-muted">Acompanhar despacho da 1¬™ Vara ‚Äî prazo em 2 dias.</p>
                        <span class="badge bg-warning-subtle text-warning">Urgente</span>
                      </div>
                    </div>
                    <div class="col-12">
                      <div class="border rounded-3 p-3">
                        <h3 class="h6 d-flex align-items-center gap-2 mb-2">
                          <i class="bi bi-people text-primary"></i>
                          Encontros da rede ‚Äî Maio
                        </h3>
                        <div class="timeline-item">
                          <strong>15/05</strong> ‚Äî Reuni√£o com Delegacia Especializada no audit√≥rio central.
                        </div>
                        <div class="timeline-item">
                          <strong>20/05</strong> ‚Äî Oficina de atualiza√ß√£o de fluxos com CREAS e Sa√∫de.
                        </div>
                      </div>
                    </div>
                  </div>
                </section>
              </div>
              <div class="col-12 col-xl-4">
                <aside class="banner-card" aria-label="Campanha SoMar">
                  <div>
                    <span class="badge bg-light text-dark mb-3">Campanha Clarice Lispector</span>
                    <h2 class="h4">Projeto SoMar ‚Äî Fortalecendo v√≠nculos e autonomia das mulheres</h2>
                    <p class="mb-0">Conhe√ßa a√ß√µes de capacita√ß√£o, acolhimento psicossocial e articula√ß√£o comunit√°ria realizadas na rede.</p>
                  </div>
                  <a class="btn btn-light btn-lg mt-4" href="#" role="button">
                    <i class="bi bi-arrow-up-right-circle me-2"></i>
                    Acessar materiais
                  </a>
                </aside>
              </div>
            </div>
          </div>

          <div class="tab-pane fade" id="prontuarios" role="tabpanel" aria-labelledby="prontuarios-tab">
            <section class="card-section mb-4" aria-labelledby="painel-prontuarios">
              <div class="section-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                <h2 class="h5 mb-0" id="painel-prontuarios">Prontu√°rios ‚Äî Consulta r√°pida</h2>
                <button class="btn btn-outline-primary btn-sm" type="button" id="btn-exportar-prontuarios">
                  <i class="bi bi-file-earmark-pdf me-1"></i>Salvar em PDF
                </button>
              </div>
              <form class="row g-3 align-items-end" id="consultaProntuariosForm" novalidate>
                <div class="col-12 col-lg-9 col-xl-10">
                  <label for="busca-prontuario" class="form-label">Buscar prontu√°rio, CPF, nome completo (ou parte dele) ou nome da m√£e</label>
                  <div class="input-group consulta-prontuario-group">
                    <span class="input-group-text" id="consultaProntuariosAddon"><i class="bi bi-search"></i></span>
                    <input type="search" class="form-control consulta-prontuario-input" id="busca-prontuario" name="consultaProntuariosTermo" aria-describedby="consultaProntuariosAddon" required />
                  </div>
                </div>
                <div class="col-12 col-lg-auto d-flex flex-wrap gap-2">
                  <button class="btn btn-primary" type="button" id="btn-buscar-prontuarios">
                    <i class="bi bi-search me-1"></i>
                    Buscar
                  </button>
                  <button class="btn btn-outline-secondary" type="button" id="btn-limpar-prontuarios">
                    <i class="bi bi-x-circle me-1"></i>
                    Limpar
                  </button>
                </div>
              </form>
              <div id="consultaProntuariosEstado" class="alert alert-info d-none mt-3" role="status"></div>
              <div id="consultaProntuariosResultados" class="table-responsive mt-3" aria-live="polite">
                <table class="table align-middle mb-0">
                  <thead>
                    <tr>
                      <th scope="col">Prontu√°rio</th>
                      <th scope="col">Nome completo</th>
                      <th scope="col">CPF</th>
                      <th scope="col">Nome da m√£e</th>
                      <th scope="col" class="text-end">A√ß√µes</th>
                    </tr>
                  </thead>
                  <tbody id="tbody-prontuarios">
                    <tr id="consultaProntuariosVazio">
                      <td colspan="5" class="text-center text-muted py-4">Nenhum resultado para exibir.</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <div class="d-flex justify-content-end mt-4">
                <button
                  type="button"
                  class="btn btn-outline-primary btn-sm d-inline-flex align-items-center gap-2"
                  id="novoRegistroBtn"
                >
                  <i class="bi bi-journal-medical"></i>
                  Novo registro
                </button>
              </div>
            </section>
          </div>
        </div>

        <section class="card-section mt-4 d-none" id="registroModal" aria-labelledby="registroModalLabel" aria-hidden="true">
          <div class="d-flex align-items-start justify-content-between flex-wrap gap-3 mb-4">
            <h2 class="h4 mb-0" id="registroModalLabel" tabindex="-1">Prontu√°rio</h2>
          </div>
          <div id="registroModalBody">
                <section id="formularioWrapper">
                  <form id="registroForm" class="needs-validation" novalidate>
                    <div id="formularioStatus" class="alert d-none align-items-center gap-2 mb-4" role="status"></div>
                    <fieldset id="registroFieldset">
                      <div class="row g-4 form-sections-layout">
                        <aside class="col-12 col-xl-3 form-section-sidebar">
                          <button
                            class="btn btn-outline-primary w-100 d-xl-none form-section-sidebar-toggle"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#formSectionNavCollapse"
                            aria-expanded="false"
                            aria-controls="formSectionNavCollapse"
                          >
                            <i class="bi bi-list"></i>
                            Navegador de se√ß√µes
                          </button>
                          <div class="collapse d-xl-block" id="formSectionNavCollapse">
                            <nav class="form-section-nav mt-3 mt-xl-0" aria-label="Navega√ß√£o entre se√ß√µes do formul√°rio">
                              <span class="nav-label">Navegador de se√ß√µes</span>
                              <div class="section-nav-list">
                                <a class="section-nav-link" href="#dados-preliminares" data-section="dados-preliminares"
                                  ><i class="bi bi-person-vcard"></i><span>Dados preliminares</span></a
                                >
                                <a class="section-nav-link" href="#dados-endereco" data-section="dados-endereco"
                                  ><i class="bi bi-geo-alt"></i><span>Endere√ßo e contatos</span></a
                                >
                                <a class="section-nav-link" href="#dados-escolaridade" data-section="dados-escolaridade"
                                  ><i class="bi bi-mortarboard"></i><span>Escolaridade</span></a
                                >
                                <a class="section-nav-link" href="#caracterizacao-violencia" data-section="caracterizacao-violencia"
                                  ><i class="bi bi-exclamation-triangle"></i><span>Caracteriza√ß√£o</span></a
                                >
                                <a class="section-nav-link" href="#dados-saude" data-section="dados-saude"
                                  ><i class="bi bi-heart-pulse"></i><span>Sa√∫de</span></a
                                >
                                <a class="section-nav-link" href="#dados-sociais" data-section="dados-sociais"
                                  ><i class="bi bi-people"></i><span>Dados sociais</span></a
                                >
                                <a class="section-nav-link" href="#dados-autor" data-section="dados-autor"
                                  ><i class="bi bi-person-exclamation"></i><span>Autor(a)</span></a
                                >
                                <a class="section-nav-link" href="#tipificacao-violencia" data-section="tipificacao-violencia"
                                  ><i class="bi bi-list-check"></i><span>Tipifica√ß√£o</span></a
                                >
                                <a class="section-nav-link" href="#evolucoes" data-section="evolucoes"
                                  ><i class="bi bi-journal-text"></i><span>Evolu√ß√µes</span></a
                                >
                                <a class="section-nav-link" href="#dados-juridicos" data-section="dados-juridicos"
                                  ><i class="bi bi-gavel"></i><span>Dados jur√≠dicos</span></a
                                >
                                <a class="section-nav-link" href="#repositorio-arquivos" data-section="repositorio-arquivos"
                                  ><i class="bi bi-folder2-open"></i><span>Arquivos</span></a
                                >
                              </div>
                            </nav>
                          </div>
                        </aside>
                        <div class="col-12 col-xl-9 col-xxl-9">
              <section class="card-section mb-4" aria-labelledby="dados-preliminares">
                <div class="section-header d-flex align-items-start justify-content-between flex-wrap gap-3">
                  <h2 class="form-section-title mb-0" id="dados-preliminares"><i class="bi bi-person-vcard"></i>Dados preliminares e de identifica√ß√£o</h2>
                  <div class="prontuario-highlight text-end" aria-live="polite">
                    <p class="prontuario-highlight-label mb-0">N¬∫ do prontu√°rio</p>
                    <p class="prontuario-highlight-value mb-0" id="numeroProntuarioDisplay">‚Äî</p>
                  </div>
                </div>
                <input type="hidden" id="numeroProntuario" name="numeroProntuario" required readonly />
                <div class="row g-4">
                  <div class="col-12">
                    <div class="subsection-card h-100">
                      <h3 class="subsection-heading">Atendimento inicial</h3>
                      <div class="row g-3">
                        <div class="col-12 col-lg-3 col-xxl-3">
                          <label for="demandante" class="form-label">Demandante</label>
                          <input type="text" class="form-control" id="demandante" name="demandante" />
                        </div>
                        <div class="col-12 col-lg-5 col-xxl-5">
                          <label for="unidadeAtendimento" class="form-label required">Unidade de atendimento</label>
                          <select id="unidadeAtendimento" name="unidadeAtendimento" class="form-select" required>
                            <option value="">Selecione</option>
                            <option>Centro de Refer√™ncia Clarice Lispector</option>
                            <option>Casa de Passagem</option>
                            <option>Casa Abrigo Sempre Viva</option>
                            <option>Outro equipamento</option>
                          </select>
                        </div>
                        <div class="col-6 col-lg-2 col-xxl-2">
                          <label for="dataAtendimento" class="form-label required">Data</label>
                          <input type="text" class="form-control" id="dataAtendimento" name="dataAtendimento" required readonly />
                        </div>
                        <div class="col-6 col-lg-2 col-xxl-2">
                          <label for="horaAtendimento" class="form-label required">Hora</label>
                          <input type="text" class="form-control" id="horaAtendimento" name="horaAtendimento" required readonly />
                        </div>
                        <div class="col-12">
                          <span class="form-label required d-block fw-semibold text-primary">Avalia√ß√£o inicial</span>
                          <div class="d-flex flex-wrap gap-3" role="group" aria-label="Avalia√ß√£o inicial">
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="avaliacaoInicial" id="avaliacaoRisco" value="Risco iminente" required />
                              <label class="form-check-label" for="avaliacaoRisco">Risco iminente</label>
                            </div>
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="avaliacaoInicial" id="avaliacaoAcompanhamento" value="Acompanhamento" required />
                              <label class="form-check-label" for="avaliacaoAcompanhamento">Acompanhamento</label>
                            </div>
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="avaliacaoInicial" id="avaliacaoOutra" value="Outra" required />
                              <label class="form-check-label" for="avaliacaoOutra">Outra</label>
                            </div>
                          </div>
                        </div>
                        <div class="col-12 col-xl-6">
                          <span class="form-label d-block fw-semibold text-primary">Atendimento</span>
                          <div class="row g-2">
                            <div class="col-12 col-sm-6">
                              <div class="form-check">
                                <input class="form-check-input atendimento-check" type="checkbox" value="Dom√©stica/Familiar" id="atendimentoDomestica" name="atendimento[]" />
                                <label class="form-check-label" for="atendimentoDomestica">Dom√©stica/Familiar</label>
                              </div>
                            </div>
                            <div class="col-12 col-sm-6">
                              <div class="form-check">
                                <input class="form-check-input atendimento-check" type="checkbox" value="Sexista" id="atendimentoSexista" name="atendimento[]" />
                                <label class="form-check-label" for="atendimentoSexista">Sexista</label>
                              </div>
                            </div>
                            <div class="col-12 col-sm-6">
                              <div class="form-check">
                                <input class="form-check-input atendimento-check" type="checkbox" value="Acolhida/Orienta√ß√£o" id="atendimentoAcolhida" name="atendimento[]" />
                                <label class="form-check-label" for="atendimentoAcolhida">Acolhida/Orienta√ß√£o</label>
                              </div>
                            </div>
                            <div class="col-12 col-sm-6">
                              <div class="form-check">
                                <input class="form-check-input atendimento-check" type="checkbox" value="Outros Munic√≠pios" id="atendimentoOutros" name="atendimento[]" />
                                <label class="form-check-label" for="atendimentoOutros">Outros Munic√≠pios</label>
                              </div>
                            </div>
                          </div>
                        </div>
                        <div class="col-12 col-xl-6">
                          <span class="form-label d-block fw-semibold text-primary">Como soube do servi√ßo</span>
                          <div class="row g-2">
                            <div class="col-12 col-sm-6">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="Parente" id="origemParente" name="origemServico[]" />
                                <label class="form-check-label" for="origemParente">Parente</label>
                              </div>
                            </div>
                            <div class="col-12 col-sm-6">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="Campanhas" id="origemCampanhas" name="origemServico[]" />
                                <label class="form-check-label" for="origemCampanhas">Campanhas</label>
                              </div>
                            </div>
                            <div class="col-12 col-sm-6">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="Amiga(o)" id="origemAmiga" name="origemServico[]" />
                                <label class="form-check-label" for="origemAmiga">Amiga(o)</label>
                              </div>
                            </div>
                            <div class="col-12 col-sm-6">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="Outras(os)" id="origemOutras" name="origemServico[]" />
                                <label class="form-check-label" for="origemOutras">Outras(os)</label>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="col-12 col-xxl-6">
                    <div class="subsection-card h-100">
                      <h3 class="subsection-heading">Documenta√ß√£o e identifica√ß√£o civil</h3>
                      <div class="row g-3">
                        <div class="col-12 field-cpf">
                          <label for="cpfUsuario" class="form-label required">CPF</label>
                          <input type="text" class="form-control cpf-input" id="cpfUsuario" name="cpfUsuario" required />
                        </div>
                        <div class="col-12 nome-completo-field">
                          <label for="nomeUsuario" class="form-label required">Nome completo</label>
                          <input type="text" class="form-control" id="nomeUsuario" name="nomeUsuario" autocomplete="name" required />
                        </div>
                        <div class="col-12 nome-social-field">
                          <label for="nomeSocial" class="form-label">Nome social</label>
                          <input type="text" class="form-control" id="nomeSocial" name="nomeSocial" />
                        </div>
                        <div class="col-12">
                          <div class="row g-3">
                            <div class="col-12 col-md-6 col-xl-8">
                              <label for="dataNascimento" class="form-label required">Data de nascimento</label>
                              <input type="text" class="form-control" id="dataNascimento" name="dataNascimento" required />
                            </div>
                            <div class="col-12 col-md-6 col-xl-4">
                              <label for="idade" class="form-label">Idade</label>
                              <input type="text" class="form-control" id="idade" name="idade" readonly />
                            </div>
                          </div>
                        </div>
                        <div class="col-12">
                          <div class="row g-3">
                            <div class="col-12 col-md-4 col-xl-4">
                              <label for="rgUsuario" class="form-label">RG</label>
                              <input type="text" class="form-control" id="rgUsuario" name="rgUsuario" />
                            </div>
                            <div class="col-12 col-md-5 col-xl-5">
                              <label for="orgaoExpedidor" class="form-label">√ìrg√£o de expedi√ß√£o</label>
                              <input type="text" class="form-control" id="orgaoExpedidor" name="orgaoExpedidor" />
                            </div>
                            <div class="col-12 col-md-3 col-xl-3">
                              <label for="ufExpedicao" class="form-label">UF</label>
                              <select id="ufExpedicao" name="ufExpedicao" class="form-select">
                                <option value="">Selecione</option>
                              </select>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="col-12 col-xxl-6">
                    <div class="subsection-card h-100">
                      <h3 class="subsection-heading">Naturalidade e estado civil</h3>
                      <div class="row g-3">
                        <div class="col-12">
                          <label for="nacionalidade" class="form-label">Nacionalidade</label>
                          <input type="text" class="form-control" id="nacionalidade" name="nacionalidade" />
                        </div>
                        <div class="col-12 col-md-6 col-lg-5">
                          <label for="ufNascimento" class="form-label">UF de nascimento</label>
                          <select id="ufNascimento" name="ufNascimento" class="form-select">
                            <option value="">Selecione</option>
                          </select>
                        </div>
                        <div class="col-12 col-md-6 col-lg-7">
                          <label for="cidadeNascimento" class="form-label">Cidade de nascimento</label>
                          <select id="cidadeNascimento" name="cidadeNascimento" class="form-select">
                            <option value="">Selecione a UF primeiro</option>
                          </select>
                        </div>
                        <div class="col-12 col-md-6 col-lg-5">
                          <label for="estadoCivil" class="form-label">Estado civil</label>
                          <select id="estadoCivil" name="estadoCivil" class="form-select">
                            <option value="">Selecione</option>
                            <option>Solteira</option>
                            <option>Casada</option>
                            <option>Uni√£o est√°vel</option>
                            <option>Separada</option>
                            <option>Divorciada</option>
                            <option>Vi√∫va</option>
                          </select>
                        </div>
                        <div class="col-12 col-md-6 col-lg-7">
                          <label for="conjuge" class="form-label">C√¥njuge/companheiro(a)</label>
                          <input type="text" class="form-control" id="conjuge" name="conjuge" />
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="col-12">
                    <div class="subsection-card h-100">
                      <h3 class="subsection-heading">Identidade social e v√≠nculos familiares</h3>
                      <div class="row g-3">
                        <div class="col-12 col-xl-3">
                          <label for="identidadeGenero" class="form-label">Identidade de g√™nero</label>
                          <select id="identidadeGenero" name="identidadeGenero" class="form-select">
                            <option value="">Selecione</option>
                            <option>Mulher cisg√™nero</option>
                            <option>Mulher trans</option>
                            <option>Travesti</option>
                            <option>N√£o-bin√°ria</option>
                            <option>Outra</option>
                            <option>Prefere n√£o informar</option>
                          </select>
                        </div>
                        <div class="col-12 col-xl-3">
                          <label for="orientacaoSexual" class="form-label">Orienta√ß√£o sexual</label>
                          <select id="orientacaoSexual" name="orientacaoSexual" class="form-select">
                            <option value="">Selecione</option>
                            <option>Heterossexual</option>
                            <option>L√©sbica</option>
                            <option>Bissexual</option>
                            <option>Assexual</option>
                            <option>Outra</option>
                            <option>Prefere n√£o informar</option>
                          </select>
                        </div>
                        <div class="col-12 col-xl-3">
                          <label for="corRaca" class="form-label">Cor/ra√ßa</label>
                          <select id="corRaca" name="corRaca" class="form-select">
                            <option value="">Selecione</option>
                            <option>Branca</option>
                            <option>Preta</option>
                            <option>Parda</option>
                            <option>Amarela</option>
                            <option>Ind√≠gena</option>
                            <option>Prefere n√£o informar</option>
                          </select>
                        </div>
                        <div class="col-12 col-xl-3">
                          <label for="religiao" class="form-label">Religi√£o</label>
                          <select id="religiao" name="religiao" class="form-select">
                            <option value="">Selecione</option>
                            <option>Cat√≥lica</option>
                            <option>Evang√©lica</option>
                            <option>Esp√≠rita</option>
                            <option>Religi√µes de matriz africana</option>
                            <option>Outra</option>
                            <option>Sem religi√£o</option>
                            <option>Prefere n√£o informar</option>
                          </select>
                        </div>
                        <div class="col-12 col-md-6">
                          <label for="nomeMae" class="form-label">Nome da m√£e</label>
                          <input type="text" class="form-control" id="nomeMae" name="nomeMae" />
                        </div>
                        <div class="col-12 col-md-6">
                          <label for="nomePai" class="form-label">Nome do pai</label>
                          <input type="text" class="form-control" id="nomePai" name="nomePai" />
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </section>

              <section class="card-section mb-4" aria-labelledby="dados-endereco">
                <h2 class="form-section-title" id="dados-endereco"><i class="bi bi-geo-alt"></i>Dados de endere√ßo e contatos</h2>
                <div class="row g-3">
                  <div class="col-12">
                    <div class="row g-3 align-items-end">
                      <div class="col-12 col-md-2 col-xl-2">
                        <label for="cep" class="form-label required">CEP</label>
                        <input type="text" class="form-control" id="cep" name="cep" required aria-describedby="cepHelp" />
                        <div id="cepHelp" class="form-text"></div>
                      </div>
                      <div class="col-12 col-md-7 col-xl-7 col-xxl-7">
                        <label for="logradouro" class="form-label required">Logradouro</label>
                        <input type="text" class="form-control" id="logradouro" name="logradouro" required />
                      </div>
                      <div class="col-12 col-md-2 col-xl-2 col-xxl-2">
                        <label for="numeroEndereco" class="form-label">N√∫mero</label>
                        <input type="text" class="form-control" id="numeroEndereco" name="numeroEndereco" />
                      </div>
                      <div class="col-12 col-md-1 col-xl-1 col-xxl-1">
                        <label for="complementoEndereco" class="form-label">Comp</label>
                        <input type="text" class="form-control" id="complementoEndereco" name="complementoEndereco" />
                      </div>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="row g-3">
                      <div class="col-12 col-md-3 col-xl-3">
                        <label for="bairro" class="form-label required">Bairro</label>
                        <input type="text" class="form-control" id="bairro" name="bairro" required />
                      </div>
                      <div class="col-12 col-md-2 col-xl-2">
                        <label for="rpa" class="form-label">RPA</label>
                        <input type="text" class="form-control" id="rpa" name="rpa" />
                      </div>
                      <div class="col-12 col-md-5 col-xl-5">
                        <label for="cidade" class="form-label required">Cidade</label>
                        <input type="text" class="form-control" id="cidade" name="cidade" required />
                      </div>
                      <div class="col-12 col-md-2 col-xl-2">
                        <label for="uf" class="form-label required">UF</label>
                        <select id="uf" name="uf" class="form-select" required>
                          <option value="">UF</option>
                        </select>
                      </div>
                    </div>
                  </div>
                  <div class="col-12">
                    <label for="pontoReferencia" class="form-label">Ponto de refer√™ncia</label>
                    <input type="text" class="form-control" id="pontoReferencia" name="pontoReferencia" />
                  </div>
                  <div class="col-12">
                    <div class="row g-3">
                      <div class="col-12 col-md-3 col-xl-3">
                        <label for="telefone" class="form-label">Telefone principal</label>
                        <input type="text" class="form-control" id="telefone" name="telefone" />
                      </div>
                      <div class="col-12 col-md-3 col-xl-3">
                        <label for="telefoneSecundario" class="form-label">Telefone alternativo</label>
                        <input type="text" class="form-control" id="telefoneSecundario" name="telefoneSecundario" />
                      </div>
                      <div class="col-12 col-md-3 col-xl-3">
                        <label for="email" class="form-label">E-mail</label>
                        <input type="email" class="form-control" id="email" name="email" />
                      </div>
                      <div class="col-12 col-md-3 col-xl-3">
                        <label for="emailConfirmacao" class="form-label">Confirma√ß√£o de e-mail</label>
                        <input type="email" class="form-control" id="emailConfirmacao" name="emailConfirmacao" aria-describedby="emailConfirmacaoHelp" />
                        <div id="emailConfirmacaoHelp" class="form-text">Informe o mesmo endere√ßo para confirma√ß√£o.</div>
                      </div>
                    </div>
                  </div>
                </div>
              </section>

              <section class="card-section mb-4" aria-labelledby="dados-escolaridade">
                <h2 class="form-section-title" id="dados-escolaridade"><i class="bi bi-mortarboard"></i>Dados de escolaridade e profissionais</h2>
                <div class="row g-4">
                  <div class="col-12 col-xl-6">
                    <div class="subsection-card h-100">
                      <h3 class="subsection-heading">Escolariza√ß√£o</h3>
                      <div class="row g-3">
                        <div class="col-12">
                          <label for="escolaridade" class="form-label required">Escolaridade</label>
                          <select id="escolaridade" name="escolaridade" class="form-select" required>
                            <option value="">Selecione</option>
                            <option>Sem instru√ß√£o</option>
                            <option>Ensino fundamental</option>
                            <option>Ensino m√©dio</option>
                            <option>Curso t√©cnico</option>
                            <option>Tecn√≥logo</option>
                            <option>Ensino superior</option>
                            <option>P√≥s-gradua√ß√£o</option>
                            <option>Mestrado</option>
                            <option>Doutorado</option>
                          </select>
                        </div>
                        <div class="col-12 col-md-6 d-none" id="situacaoEscolarGroup">
                          <label for="situacaoEscolar" class="form-label">Situa√ß√£o escolar</label>
                          <select id="situacaoEscolar" name="situacaoEscolar" class="form-select">
                            <option value="">Selecione</option>
                            <option>Conclu√≠do</option>
                            <option>Em andamento</option>
                            <option>Interrompido</option>
                          </select>
                        </div>
                        <div class="col-12 d-none" id="cursoFormacaoGroup">
                          <label for="cursoFormacao" class="form-label">Curso</label>
                          <input type="text" class="form-control" id="cursoFormacao" name="cursoFormacao" />
                        </div>
                        <div class="col-12 col-md-6 d-none" id="tipoPosGraduacaoGroup">
                          <label for="tipoPosGraduacao" class="form-label">Tipo de p√≥s-gradua√ß√£o</label>
                          <select id="tipoPosGraduacao" name="tipoPosGraduacao" class="form-select">
                            <option value="">Selecione</option>
                            <option>Especializa√ß√£o</option>
                            <option>Mestrado</option>
                            <option>Doutorado</option>
                            <option>Outra</option>
                          </select>
                        </div>
                        <div class="col-12 col-md-6 d-none" id="anoPeriodoGroup">
                          <label for="anoPeriodo" class="form-label">Ano/per√≠odo</label>
                          <input type="text" class="form-control" id="anoPeriodo" name="anoPeriodo" />
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="col-12 col-xl-6">
                    <div class="subsection-card h-100">
                      <h3 class="subsection-heading">Trabalho e renda</h3>
                      <div class="row g-3">
                        <div class="col-12">
                          <label for="situacaoOcupacional" class="form-label">Situa√ß√£o ocupacional</label>
                          <select id="situacaoOcupacional" name="situacaoOcupacional" class="form-select">
                            <option value="">Selecione</option>
                            <option>Empregada com carteira</option>
                            <option>Empregada informal</option>
                            <option>Aut√¥noma</option>
                            <option>Estudante</option>
                            <option>Dona de casa/cuidadora</option>
                            <option>Desempregada</option>
                            <option>Aposentada/Pensionista</option>
                          </select>
                        </div>
                      </div>
                      <div class="row g-3 mt-1 d-none" id="detalhesTrabalho">
                        <div class="col-12">
                          <label for="profissao" class="form-label">Ocupa√ß√£o/profiss√£o</label>
                          <input type="text" class="form-control" id="profissao" name="profissao" />
                        </div>
                        <div class="col-12 d-none" id="situacaoTrabalhoGroup">
                          <label for="situacaoTrabalho" class="form-label">Situa√ß√£o trabalhista</label>
                          <select id="situacaoTrabalho" name="situacaoTrabalho" class="form-select">
                            <option value="">Selecione</option>
                            <option>Com carteira assinada</option>
                            <option>Aut√¥noma</option>
                            <option>Microempreendedora</option>
                            <option>Desempregada</option>
                            <option>Trabalho dom√©stico</option>
                          </select>
                        </div>
                        <div class="col-12 col-md-6">
                          <label for="rendaIndividual" class="form-label">Renda individual</label>
                          <input type="text" class="form-control" id="rendaIndividual" name="rendaIndividual" />
                        </div>
                      </div>
                      <div class="mt-3">
                        <span class="form-label d-block">Interesse em capacita√ß√£o profissional</span>
                        <div class="d-flex flex-wrap gap-3" role="radiogroup" aria-label="Interesse em capacita√ß√£o profissional">
                          <div class="form-check">
                            <input class="form-check-input" type="radio" name="interesseCapacitacao" id="capacitacaoSim" value="Sim" />
                            <label class="form-check-label" for="capacitacaoSim">Sim</label>
                          </div>
                          <div class="form-check">
                            <input class="form-check-input" type="radio" name="interesseCapacitacao" id="capacitacaoNao" value="N√£o" />
                            <label class="form-check-label" for="capacitacaoNao">N√£o</label>
                          </div>
                        </div>
                      </div>
                      <div class="mt-3 d-none" id="cursosWrapper">
                        <label for="cursoCapacitacao" class="form-label required">Curso de interesse</label>
                        <div class="d-flex flex-column gap-2">
                          <input type="text" class="form-control" id="cursoCapacitacao" name="cursos[]" />
                          <div id="cursosExtras" class="d-flex flex-column gap-2"></div>
                          <button type="button" class="btn btn-sm btn-outline-primary align-self-start" id="adicionarCurso" aria-describedby="cursoHelp">
                            <i class="bi bi-plus-circle me-1"></i>Adicionar outro
                          </button>
                          <div id="cursoHelp" class="form-text">√â poss√≠vel cadastrar at√© tr√™s cursos de interesse.</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </section>

              <section class="card-section mb-4" aria-labelledby="caracterizacao-violencia">
                <h2 class="form-section-title" id="caracterizacao-violencia"><i class="bi bi-exclamation-triangle"></i>Caracteriza√ß√£o da viol√™ncia</h2>
                <div class="row g-3">
                  <div class="col-12 col-md-4">
                    <label for="tipoViolencia" class="form-label required">Tipo de viol√™ncia</label>
                    <select id="tipoViolencia" name="tipoViolencia" class="form-select" required>
                      <option value="">Selecione</option>
                      <option>Viol√™ncia f√≠sica</option>
                      <option>Viol√™ncia psicol√≥gica</option>
                      <option>Viol√™ncia sexual</option>
                      <option>Viol√™ncia moral</option>
                      <option>Viol√™ncia patrimonial</option>
                    </select>
                  </div>
                  <div class="col-12 col-md-4">
                    <label for="localViolencia" class="form-label required">Local principal</label>
                    <input type="text" class="form-control" id="localViolencia" name="localViolencia" required />
                  </div>
                  <div class="col-12 col-md-4">
                    <label for="frequencia" class="form-label">Frequ√™ncia</label>
                    <select id="frequencia" name="frequencia" class="form-select">
                      <option value="">Selecione</option>
                      <option>Recente</option>
                      <option>Recorrente</option>
                      <option>Eventual</option>
                    </select>
                  </div>
                  <div class="col-12 col-md-4">
                    <label for="dataOcorrencia" class="form-label">Data da √∫ltima ocorr√™ncia</label>
                    <input type="text" class="form-control" id="dataOcorrencia" name="dataOcorrencia" />
                  </div>
                  <div class="col-12">
                    <label for="relato" class="form-label">Relato resumido</label>
                    <textarea id="relato" name="relato" class="form-control" rows="3"></textarea>
                  </div>
                  <div class="col-12">
                    <div class="alert alert-info d-none" id="encaminhamentosAlert" role="status">
                      <strong>Encaminhamentos priorit√°rios:</strong> orientar acolhida imediata, registrar encaminhamento para rede municipal e comunicar munic√≠pio de origem quando aplic√°vel.
                    </div>
                  </div>
                </div>
              </section>

              <section class="card-section mb-4 dados-saude-section" aria-labelledby="dados-saude">
                <h2 class="form-section-title" id="dados-saude"><i class="bi bi-heart-pulse"></i>Dados de sa√∫de</h2>
                <div class="row g-4">
                  <div class="col-12 col-xl-6 col-xxl-4">
                    <div class="subsection-card h-100">
                      <h3 class="subsection-title"><i class="bi bi-person-vcard"></i>Identifica√ß√£o em sa√∫de</h3>
                      <div class="row g-3">
                        <div class="col-12">
                          <label for="numeroSus" class="form-label">N√∫mero do Cart√£o SUS</label>
                          <input
                            type="text"
                            class="form-control"
                            id="numeroSus"
                            name="numeroSus"
                          />
                        </div>
                        <div class="col-12">
                          <span class="form-label required d-block">Apresenta alguma defici√™ncia/s√≠ndrome?</span>
                          <div class="d-flex flex-wrap gap-3" role="radiogroup" aria-labelledby="dados-saude">
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="deficienciaSindrome" id="deficienciaSim" value="Sim" />
                              <label class="form-check-label" for="deficienciaSim">Sim</label>
                            </div>
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="deficienciaSindrome" id="deficienciaNao" value="N√£o" />
                              <label class="form-check-label" for="deficienciaNao">N√£o</label>
                            </div>
                          </div>
                        </div>
                        <div class="col-12 d-none" id="deficienciaQualGroup">
                          <label for="deficienciaQual" class="form-label required">Qual?</label>
                          <select id="deficienciaQual" name="deficienciaQual" class="form-select" data-choices="true">
                            <option value="">Selecione</option>
                            <option>Defici√™ncia f√≠sica</option>
                            <option>Defici√™ncia auditiva</option>
                            <option>Defici√™ncia visual</option>
                            <option>Defici√™ncia intelectual</option>
                            <option>Defici√™ncia psicossocial</option>
                            <option>Transtorno do espectro autista</option>
                            <option>Outra defici√™ncia</option>
                          </select>
                        </div>
                        <div class="col-12">
                          <span class="form-label d-block">Defici√™ncia em decorr√™ncia da viol√™ncia sofrida?</span>
                          <div class="d-flex flex-wrap gap-3" role="radiogroup">
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="deficienciaViolencia" id="deficienciaViolenciaSim" value="Sim" />
                              <label class="form-check-label" for="deficienciaViolenciaSim">Sim</label>
                            </div>
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="deficienciaViolencia" id="deficienciaViolenciaNao" value="N√£o" />
                              <label class="form-check-label" for="deficienciaViolenciaNao">N√£o</label>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="col-12 col-xl-6 col-xxl-4">
                    <div class="subsection-card h-100">
                      <h3 class="subsection-title"><i class="bi bi-emoji-smile"></i>Sa√∫de geral e mental</h3>
                      <div class="row g-3">
                        <div class="col-12">
                          <span class="form-label required d-block">Apresenta problema de sa√∫de?</span>
                          <div class="d-flex flex-wrap gap-3" role="radiogroup">
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="problemaSaude" id="problemaSaudeSim" value="Sim" />
                              <label class="form-check-label" for="problemaSaudeSim">Sim</label>
                            </div>
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="problemaSaude" id="problemaSaudeNao" value="N√£o" />
                              <label class="form-check-label" for="problemaSaudeNao">N√£o</label>
                            </div>
                          </div>
                        </div>
                        <div class="col-12 d-none" id="problemaSaudeQualGroup">
                          <label for="problemaSaudeQual" class="form-label required">Qual?</label>
                          <input
                            type="text"
                            class="form-control"
                            id="problemaSaudeQual"
                            name="problemaSaudeQual"
                           
                          />
                        </div>
                        <div class="col-12">
                          <span class="form-label required d-block">J√° foi atendido por psic√≥logo?</span>
                          <div class="d-flex flex-wrap gap-3" role="radiogroup">
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="atendimentoPsicologo" id="atendimentoPsicologoSim" value="Sim" />
                              <label class="form-check-label" for="atendimentoPsicologoSim">Sim</label>
                            </div>
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="atendimentoPsicologo" id="atendimentoPsicologoNao" value="N√£o" />
                              <label class="form-check-label" for="atendimentoPsicologoNao">N√£o</label>
                            </div>
                          </div>
                        </div>
                        <div class="col-12 d-none" id="tempoPsicologoGroup">
                          <label for="tempoPsicologo" class="form-label required">Quanto tempo?</label>
                          <input
                            type="text"
                            class="form-control"
                            id="tempoPsicologo"
                            name="tempoPsicologo"
                           
                          />
                        </div>
                        <div class="col-12">
                          <span class="form-label required d-block">J√° foi atendido por psiquiatra?</span>
                          <div class="d-flex flex-wrap gap-3" role="radiogroup">
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="atendimentoPsiquiatra" id="atendimentoPsiquiatraSim" value="Sim" />
                              <label class="form-check-label" for="atendimentoPsiquiatraSim">Sim</label>
                            </div>
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="atendimentoPsiquiatra" id="atendimentoPsiquiatraNao" value="N√£o" />
                              <label class="form-check-label" for="atendimentoPsiquiatraNao">N√£o</label>
                            </div>
                          </div>
                        </div>
                        <div class="col-12 d-none" id="tempoPsiquiatraGroup">
                          <label for="tempoPsiquiatra" class="form-label required">Quanto tempo?</label>
                          <input
                            type="text"
                            class="form-control"
                            id="tempoPsiquiatra"
                            name="tempoPsiquiatra"
                           
                          />
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="col-12 col-xl-6 col-xxl-4">
                    <div class="subsection-card h-100">
                      <h3 class="subsection-title"><i class="bi bi-capsule"></i>Medica√ß√µes e gesta√ß√£o</h3>
                      <div class="row g-3">
                        <div class="col-12">
                          <span class="form-label required d-block">Faz uso de medicamento?</span>
                          <div class="d-flex flex-wrap gap-3" role="radiogroup">
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="usoMedicamento" id="usoMedicamentoSim" value="Sim" />
                              <label class="form-check-label" for="usoMedicamentoSim">Sim</label>
                            </div>
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="usoMedicamento" id="usoMedicamentoNao" value="N√£o" />
                              <label class="form-check-label" for="usoMedicamentoNao">N√£o</label>
                            </div>
                          </div>
                        </div>
                        <div class="col-12 d-none" id="medicamentosQuaisGroup">
                          <label for="medicamentosQuais" class="form-label required">Quais?</label>
                          <input
                            type="text"
                            class="form-control"
                            id="medicamentosQuais"
                            name="medicamentosQuais"
                           
                          />
                        </div>
                        <div class="col-12">
                          <span class="form-label required d-block">Gestante?</span>
                          <div class="d-flex flex-wrap gap-3" role="radiogroup">
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="gestante" id="gestanteSim" value="Sim" />
                              <label class="form-check-label" for="gestanteSim">Sim</label>
                            </div>
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="gestante" id="gestanteNao" value="N√£o" />
                              <label class="form-check-label" for="gestanteNao">N√£o</label>
                            </div>
                          </div>
                        </div>
                        <div class="col-12 d-none" id="tempoGestacaoGroup">
                          <label for="tempoGestacao" class="form-label required">Tempo de gesta√ß√£o</label>
                          <select id="tempoGestacao" name="tempoGestacao" class="form-select" data-choices="true">
                            <option value="">Selecione</option>
                            <option>At√© 12 semanas</option>
                            <option>13 a 20 semanas</option>
                            <option>21 a 28 semanas</option>
                            <option>29 a 36 semanas</option>
                            <option>37 semanas ou mais</option>
                          </select>
                        </div>
                        <div class="col-12">
                          <span class="form-label required d-block">Decorrente de viol√™ncia, j√° sofreu algum aborto?</span>
                          <div class="d-flex flex-wrap gap-3" role="radiogroup">
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="abortoViolencia" id="abortoViolenciaSim" value="Sim" />
                              <label class="form-check-label" for="abortoViolenciaSim">Sim</label>
                            </div>
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="abortoViolencia" id="abortoViolenciaNao" value="N√£o" />
                              <label class="form-check-label" for="abortoViolenciaNao">N√£o</label>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="col-12 col-xl-6">
                    <div class="subsection-card h-100">
                      <h3 class="subsection-title"><i class="bi bi-gender-female"></i>Sa√∫de sexual e exames</h3>
                      <div class="row g-3">
                        <div class="col-12 d-none" id="preventivoGroup">
                          <span class="form-label d-block">Preventivo c√¢ncer do colo do √∫tero</span>
                          <div class="d-flex flex-wrap gap-3" role="radiogroup">
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="preventivoColo" id="preventivoColoSim" value="Sim" />
                              <label class="form-check-label" for="preventivoColoSim">Sim</label>
                            </div>
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="preventivoColo" id="preventivoColoNao" value="N√£o" />
                              <label class="form-check-label" for="preventivoColoNao">N√£o</label>
                            </div>
                          </div>
                        </div>
                        <div class="col-12 col-md-6 d-none" id="preventivoAnoGroup">
                          <label for="preventivoAno" class="form-label required">Quando (ano)?</label>
                          <input type="text" class="form-control" id="preventivoAno" name="preventivoAno" />
                        </div>
                        <div class="col-12 d-none" id="mamografiaGroup">
                          <span class="form-label d-block">Mamografia</span>
                          <div class="d-flex flex-wrap gap-3" role="radiogroup">
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="mamografia" id="mamografiaSim" value="Sim" />
                              <label class="form-check-label" for="mamografiaSim">Sim</label>
                            </div>
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="mamografia" id="mamografiaNao" value="N√£o" />
                              <label class="form-check-label" for="mamografiaNao">N√£o</label>
                            </div>
                          </div>
                        </div>
                        <div class="col-12 col-md-6 d-none" id="mamografiaAnoGroup">
                          <label for="mamografiaAno" class="form-label required">Quando (ano)?</label>
                          <input type="text" class="form-control" id="mamografiaAno" name="mamografiaAno" />
                        </div>
                        <div class="col-12 col-md-6">
                          <span class="form-label required d-block">Realizou exame de HIV?</span>
                          <div class="d-flex flex-wrap gap-3" role="radiogroup">
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="exameHiv" id="exameHivSim" value="Sim" />
                              <label class="form-check-label" for="exameHivSim">Sim</label>
                            </div>
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="exameHiv" id="exameHivNao" value="N√£o" />
                              <label class="form-check-label" for="exameHivNao">N√£o</label>
                            </div>
                          </div>
                        </div>
                        <div class="col-12 col-md-6 d-none" id="resultadoHivGroup">
                          <span class="form-label required d-block">Qual o resultado?</span>
                          <div class="d-flex flex-wrap gap-3" role="radiogroup">
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="resultadoHiv" id="resultadoHivNegativo" value="Negativo" />
                              <label class="form-check-label" for="resultadoHivNegativo">Negativo</label>
                            </div>
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="resultadoHiv" id="resultadoHivPositivo" value="Positivo" />
                              <label class="form-check-label" for="resultadoHivPositivo">Positivo</label>
                            </div>
                          </div>
                        </div>
                        <div class="col-12 col-md-6 d-none" id="contraiuAgressorGroup">
                          <span class="form-label required d-block">Contraiu com o agressor?</span>
                          <div class="d-flex flex-wrap gap-3" role="radiogroup">
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="contraiuAgressor" id="contraiuAgressorSim" value="Sim" />
                              <label class="form-check-label" for="contraiuAgressorSim">Sim</label>
                            </div>
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="contraiuAgressor" id="contraiuAgressorNao" value="N√£o" />
                              <label class="form-check-label" for="contraiuAgressorNao">N√£o</label>
                            </div>
                          </div>
                        </div>
                        <div class="col-12 col-md-6">
                          <span class="form-label required d-block">Faz acompanhamento?</span>
                          <div class="d-flex flex-wrap gap-3" role="radiogroup">
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="acompanhamentoSaudeContinuo" id="acompanhamentoSaudeContinuoSim" value="Sim" />
                              <label class="form-check-label" for="acompanhamentoSaudeContinuoSim">Sim</label>
                            </div>
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="acompanhamentoSaudeContinuo" id="acompanhamentoSaudeContinuoNao" value="N√£o" />
                              <label class="form-check-label" for="acompanhamentoSaudeContinuoNao">N√£o</label>
                            </div>
                          </div>
                        </div>
                        <div class="col-12 col-md-6 d-none" id="tempoAcompanhamentoGroup">
                          <label for="tempoAcompanhamento" class="form-label required">H√° quanto tempo faz tratamento?</label>
                          <select id="tempoAcompanhamento" name="tempoAcompanhamento" class="form-select" data-choices="true">
                            <option value="">Selecione</option>
                            <option>Menos de 6 meses</option>
                            <option>Entre 6 meses e 1 ano</option>
                            <option>Entre 1 e 2 anos</option>
                            <option>Mais de 2 anos</option>
                          </select>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="col-12 col-xl-6">
                    <div class="subsection-card h-100">
                      <h3 class="subsection-title"><i class="bi bi-droplet-half"></i>Uso de subst√¢ncias</h3>
                      <div class="row g-3">
                        <div class="col-12">
                          <span class="form-label required d-block">Faz uso de drogas l√≠citas?</span>
                          <div class="d-flex flex-wrap gap-3" role="radiogroup">
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="usoDrogasLicitas" id="usoDrogasLicitasSim" value="Sim" />
                              <label class="form-check-label" for="usoDrogasLicitasSim">Sim</label>
                            </div>
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="usoDrogasLicitas" id="usoDrogasLicitasNao" value="N√£o" />
                              <label class="form-check-label" for="usoDrogasLicitasNao">N√£o</label>
                            </div>
                          </div>
                        </div>
                        <div class="col-12 d-none" id="drogasLicitasGroup">
                          <span class="form-label required d-block">Quais?</span>
                          <div class="row g-2">
                            <div class="col-6">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="drogaLicitaTabaco" name="drogasLicitas[]" value="Tabaco" />
                                <label class="form-check-label" for="drogaLicitaTabaco">Tabaco</label>
                              </div>
                            </div>
                            <div class="col-6">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="drogaLicitaMedicamento" name="drogasLicitas[]" value="Medicamento" />
                                <label class="form-check-label" for="drogaLicitaMedicamento">Medicamento</label>
                              </div>
                            </div>
                            <div class="col-6">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="drogaLicitaAlcool" name="drogasLicitas[]" value="√Ålcool" />
                                <label class="form-check-label" for="drogaLicitaAlcool">√Ålcool</label>
                              </div>
                            </div>
                            <div class="col-6">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="drogaLicitaOutras" name="drogasLicitas[]" value="Outras" />
                                <label class="form-check-label" for="drogaLicitaOutras">Outras</label>
                              </div>
                            </div>
                            <div class="col-12 d-none" id="drogasLicitasOutrasGroup">
                              <label for="drogasLicitasOutrasTexto" class="form-label required">Outras (especifique)</label>
                              <input
                                type="text"
                                class="form-control"
                                id="drogasLicitasOutrasTexto"
                                name="drogasLicitasOutrasTexto"
                               
                              />
                            </div>
                          </div>
                        </div>
                        <div class="col-12">
                          <span class="form-label required d-block">Faz uso de drogas il√≠citas?</span>
                          <div class="d-flex flex-wrap gap-3" role="radiogroup">
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="usoDrogasIlicitas" id="usoDrogasIlicitasSim" value="Sim" />
                              <label class="form-check-label" for="usoDrogasIlicitasSim">Sim</label>
                            </div>
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="usoDrogasIlicitas" id="usoDrogasIlicitasNao" value="N√£o" />
                              <label class="form-check-label" for="usoDrogasIlicitasNao">N√£o</label>
                            </div>
                          </div>
                        </div>
                        <div class="col-12 d-none" id="drogasIlicitasGroup">
                          <span class="form-label required d-block">Quais?</span>
                          <div class="row g-2">
                            <div class="col-6">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="drogaIlicitaCocaina" name="drogasIlicitas[]" value="Coca√≠na" />
                                <label class="form-check-label" for="drogaIlicitaCocaina">Coca√≠na</label>
                              </div>
                            </div>
                            <div class="col-6">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="drogaIlicitaCrack" name="drogasIlicitas[]" value="Crack" />
                                <label class="form-check-label" for="drogaIlicitaCrack">Crack</label>
                              </div>
                            </div>
                            <div class="col-6">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="drogaIlicitaMaconha" name="drogasIlicitas[]" value="Maconha" />
                                <label class="form-check-label" for="drogaIlicitaMaconha">Maconha</label>
                              </div>
                            </div>
                            <div class="col-6">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="drogaIlicitaOutras" name="drogasIlicitas[]" value="Outras" />
                                <label class="form-check-label" for="drogaIlicitaOutras">Outras</label>
                              </div>
                            </div>
                            <div class="col-12 d-none" id="drogasIlicitasOutrasGroup">
                              <label for="drogasIlicitasOutrasTexto" class="form-label required">Outras (especifique)</label>
                              <input
                                type="text"
                                class="form-control"
                                id="drogasIlicitasOutrasTexto"
                                name="drogasIlicitasOutrasTexto"
                               
                              />
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </section>

              <section class="card-section mb-4" aria-labelledby="dados-sociais">
                <h2 class="form-section-title" id="dados-sociais"><i class="bi bi-people"></i>Dados sociais da fam√≠lia</h2>
                <div class="row g-3">
                  <div class="col-12 col-md-4">
                    <label for="beneficios" class="form-label">Benef√≠cios sociais</label>
                    <select id="beneficios" name="beneficios" class="form-select" aria-describedby="beneficiosHelp">
                      <option value="">Selecione</option>
                      <option>Bolsa Fam√≠lia</option>
                      <option>BPC</option>
                      <option>Aux√≠lio municipal</option>
                      <option>Outro</option>
                    </select>
                    <div id="beneficiosHelp" class="form-text">Selecione o principal benef√≠cio recebido.</div>
                  </div>
                  <div class="col-12 col-md-4">
                    <label for="totalFilhos" class="form-label">Total de filhos(as)</label>
                    <select id="totalFilhos" name="totalFilhos" class="form-select">
                      <option value="">Selecione</option>
                      <option>0</option>
                      <option>1</option>
                      <option>2</option>
                      <option>3</option>
                      <option>4 ou mais</option>
                    </select>
                  </div>
                  <div class="col-12 col-md-4">
                    <label for="rendaFamiliar" class="form-label">Renda familiar</label>
                    <select id="rendaFamiliar" name="rendaFamiliar" class="form-select">
                      <option value="">Selecione</option>
                      <option>At√© 1 sal√°rio m√≠nimo</option>
                      <option>De 1 a 2 sal√°rios m√≠nimos</option>
                      <option>De 2 a 3 sal√°rios m√≠nimos</option>
                      <option>Acima de 3 sal√°rios m√≠nimos</option>
                      <option>Sem renda</option>
                    </select>
                  </div>
                  <div class="col-12 col-md-4">
                    <label for="situacaoHabitacional" class="form-label">Situa√ß√£o habitacional</label>
                    <select id="situacaoHabitacional" name="situacaoHabitacional" class="form-select">
                      <option value="">Selecione</option>
                      <option>Pr√≥pria</option>
                      <option>Alugada</option>
                      <option>Cedida</option>
                      <option>Ocupa√ß√£o</option>
                      <option>Outros</option>
                    </select>
                  </div>
                  <div class="col-12 col-md-4 d-none" id="situacaoHabitacionalOutroGroup">
                    <label for="situacaoHabitacionalOutro" class="form-label">Descreva a situa√ß√£o habitacional</label>
                    <input type="text" class="form-control" id="situacaoHabitacionalOutro" name="situacaoHabitacionalOutro" />
                  </div>
                  <div class="col-12 col-md-4">
                    <label for="redeApoio" class="form-label">Rede de apoio</label>
                    <input type="text" class="form-control" id="redeApoio" name="redeApoio" />
                  </div>
                </div>
                <div class="mt-4">
                  <div class="d-flex flex-wrap align-items-center gap-3 mb-3">
                    <h3 class="h6 mb-0">Composi√ß√£o familiar (todos da resid√™ncia)</h3>
                    <button
                      type="button"
                      class="btn btn-outline-primary btn-sm ms-auto"
                      id="adicionarMembroFamilia"
                      data-bs-toggle="modal"
                      data-bs-target="#familiaModal"
                      data-modal-child-trigger="true"
                    >
                      <i class="bi bi-person-plus me-1"></i>Adicionar membro da fam√≠lia
                    </button>
                  </div>
                  <div class="table-responsive border rounded-3">
                    <table class="table table-sm align-middle mb-0">
                      <thead class="table-light">
                        <tr>
                          <th scope="col">Nome completo</th>
                          <th scope="col">Parentesco</th>
                          <th scope="col">Idade (anos)</th>
                          <th scope="col">Meses</th>
                        </tr>
                      </thead>
                      <tbody id="familiaTabelaBody">
                        <tr id="familiaVazia">
                          <td colspan="4" class="text-center text-muted">Nenhum membro informado.</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                  <div id="familiaHiddenInputs"></div>
                </div>
              </section>

              <section class="card-section mb-4" aria-labelledby="dados-autor">
                <h2 class="form-section-title" id="dados-autor"><i class="bi bi-person-exclamation"></i>Dados do(a) autor(a)</h2>
                <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3 mb-3">
                  <p class="mb-0 text-muted">
                    Registre autoras(es) relacionadas(os) ao caso para acompanhamento jur√≠dico e socioassistencial.
                  </p>
                  <button
                    type="button"
                    class="btn btn-outline-primary btn-sm ms-auto"
                    data-bs-toggle="modal"
                    data-bs-target="#autorModal"
                    data-modal-child-trigger="true"
                  >
                    <i class="bi bi-person-plus me-1"></i>Adicionar autor(a)
                  </button>
                </div>
                <div class="table-responsive">
                  <table class="table table-sm align-middle">
                    <thead class="table-light">
                      <tr>
                        <th scope="col">CPF</th>
                        <th scope="col">Nome</th>
                        <th scope="col">Grau de parentesco</th>
                      </tr>
                    </thead>
                    <tbody id="autorTabelaBody">
                      <tr id="autorVazio">
                        <td colspan="3" class="text-center text-muted">Nenhum autor(a) informado.</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                <div id="autorHiddenInputs"></div>
              </section>

                  <section class="card-section mb-4" aria-labelledby="tipificacao-violencia">
                    <h2 class="form-section-title" id="tipificacao-violencia"><i class="bi bi-list-check"></i>Tipifica√ß√£o da viol√™ncia</h2>
                    <div class="row g-4">
                      <div class="col-12">
                        <div class="subsection-card h-100">
                          <h3 class="subsection-heading">Relacionamento com o(a) autor(a)</h3>
                          <div class="row g-3">
                            <div class="col-12 col-lg-6">
                              <label for="tempoConvivencia" class="form-label">Tempo de conviv√™ncia (em anos)</label>
                              <select id="tempoConvivencia" name="tempoConvivencia" class="form-select" data-choices="true">
                                <option value="">Selecione</option>
                                <option>Menos de 1 ano</option>
                                <option>1 a 3 anos</option>
                                <option>3 a 5 anos</option>
                                <option>5 a 10 anos</option>
                                <option>Mais de 10 anos</option>
                                <option>N√£o informado</option>
                              </select>
                            </div>
                            <div class="col-12 col-lg-6">
                              <label for="tipoRelacionamento" class="form-label required">Tipo de relacionamento</label>
                              <select
                                id="tipoRelacionamento"
                                name="tipoRelacionamento"
                                class="form-select"
                                data-choices="true"
                                data-choices-search="true"
                                required
                              >
                                <option value="">Selecione</option>
                                <option>C√¥njuge/companheiro(a)</option>
                                <option>Ex-companheiro(a)</option>
                                <option>Namorado(a)</option>
                                <option>Amigo(a)</option>
                                <option>Familiar</option>
                                <option>Colega de trabalho</option>
                                <option>Vizinho(a)</option>
                                <option>Outro v√≠nculo</option>
                              </select>
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="col-12">
                        <div class="subsection-card h-100">
                          <h3 class="subsection-heading">F√≠sica</h3>
                          <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-2">
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="fisicaObjetos" name="violenciaFisica[]" value="Uso de objetos" />
                                <label class="form-check-label" for="fisicaObjetos">Uso de objetos</label>
                              </div>
                            </div>
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="fisicaSufocamento" name="violenciaFisica[]" value="Sufocamento" />
                                <label class="form-check-label" for="fisicaSufocamento">Sufocamento</label>
                              </div>
                            </div>
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="fisicaFraturas" name="violenciaFisica[]" value="Fraturas" />
                                <label class="form-check-label" for="fisicaFraturas">Fraturas</label>
                              </div>
                            </div>
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="fisicaPontapes" name="violenciaFisica[]" value="Pontap√©s" />
                                <label class="form-check-label" for="fisicaPontapes">Pontap√©s</label>
                              </div>
                            </div>
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="fisicaEspancamento" name="violenciaFisica[]" value="Espancamento" />
                                <label class="form-check-label" for="fisicaEspancamento">Espancamento</label>
                              </div>
                            </div>
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="fisicaQueimaduras" name="violenciaFisica[]" value="Queimaduras" />
                                <label class="form-check-label" for="fisicaQueimaduras">Queimaduras</label>
                              </div>
                            </div>
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="fisicaMordidas" name="violenciaFisica[]" value="Mordidas" />
                                <label class="form-check-label" for="fisicaMordidas">Mordidas</label>
                              </div>
                            </div>
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="fisicaEmpurrao" name="violenciaFisica[]" value="Empurr√£o" />
                                <label class="form-check-label" for="fisicaEmpurrao">Empurr√£o</label>
                              </div>
                            </div>
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="fisicaRasteira" name="violenciaFisica[]" value="Rasteira" />
                                <label class="form-check-label" for="fisicaRasteira">Rasteira</label>
                              </div>
                            </div>
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="fisicaTapa" name="violenciaFisica[]" value="Tapa" />
                                <label class="form-check-label" for="fisicaTapa">Tapa</label>
                              </div>
                            </div>
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="fisicaSoco" name="violenciaFisica[]" value="Soco" />
                                <label class="form-check-label" for="fisicaSoco">Soco</label>
                              </div>
                            </div>
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="fisicaTorcao" name="violenciaFisica[]" value="Tor√ß√£o" />
                                <label class="form-check-label" for="fisicaTorcao">Tor√ß√£o</label>
                              </div>
                            </div>
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="fisicaPuxaoCabelo" name="violenciaFisica[]" value="Pux√£o de cabelo" />
                                <label class="form-check-label" for="fisicaPuxaoCabelo">Pux√£o de cabelo</label>
                              </div>
                            </div>
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="fisicaTortura" name="violenciaFisica[]" value="Tortura" />
                                <label class="form-check-label" for="fisicaTortura">Tortura</label>
                              </div>
                            </div>
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="fisicaEnvenenamento" name="violenciaFisica[]" value="Envenenamento" />
                                <label class="form-check-label" for="fisicaEnvenenamento">Envenenamento</label>
                              </div>
                            </div>
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="fisicaSequestro" name="violenciaFisica[]" value="Sequestro" />
                                <label class="form-check-label" for="fisicaSequestro">Sequestro</label>
                              </div>
                            </div>
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="fisicaOutras" name="violenciaFisica[]" value="Outras" />
                                <label class="form-check-label" for="fisicaOutras">Outras</label>
                              </div>
                            </div>
                          </div>
                          <div class="row g-3 mt-1">
                            <div class="col-12 col-lg-6 d-none" id="violenciaFisicaOutrasGroup">
                              <label for="violenciaFisicaOutrasTexto" class="form-label">Detalhe outras viol√™ncias f√≠sicas</label>
                              <input
                                type="text"
                                class="form-control"
                                id="violenciaFisicaOutrasTexto"
                                name="violenciaFisicaOutrasTexto"
                              />
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="col-12">
                        <div class="subsection-card h-100">
                          <h3 class="subsection-heading">Psicol√≥gica</h3>
                          <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-2">
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="psicologicaAmeacas" name="violenciaPsicologica[]" value="Amea√ßas" />
                                <label class="form-check-label" for="psicologicaAmeacas">Amea√ßas</label>
                              </div>
                            </div>
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="psicologicaDesprezo" name="violenciaPsicologica[]" value="Desprezo ou humilha√ß√£o" />
                                <label class="form-check-label" for="psicologicaDesprezo">Desprezo/humilha√ß√£o</label>
                              </div>
                            </div>
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="psicologicaPrivacao" name="violenciaPsicologica[]" value="Priva√ß√£o de liberdade" />
                                <label class="form-check-label" for="psicologicaPrivacao">Priva√ß√£o de liberdade</label>
                              </div>
                            </div>
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="psicologicaAssedio" name="violenciaPsicologica[]" value="Ass√©dio moral" />
                                <label class="form-check-label" for="psicologicaAssedio">Ass√©dio moral</label>
                              </div>
                            </div>
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="psicologicaGritos" name="violenciaPsicologica[]" value="Gritos" />
                                <label class="form-check-label" for="psicologicaGritos">Gritos</label>
                              </div>
                            </div>
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="psicologicaPerseguicao" name="violenciaPsicologica[]" value="Persegui√ß√£o" />
                                <label class="form-check-label" for="psicologicaPerseguicao">Persegui√ß√£o</label>
                              </div>
                            </div>
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="psicologicaChantagem" name="violenciaPsicologica[]" value="Chantagem" />
                                <label class="form-check-label" for="psicologicaChantagem">Chantagem</label>
                              </div>
                            </div>
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="psicologicaXingamento" name="violenciaPsicologica[]" value="Xingamento" />
                                <label class="form-check-label" for="psicologicaXingamento">Xingamento</label>
                              </div>
                            </div>
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="psicologicaOutras" name="violenciaPsicologica[]" value="Outras" />
                                <label class="form-check-label" for="psicologicaOutras">Outras</label>
                              </div>
                            </div>
                          </div>
                          <div class="row g-3 mt-1">
                            <div class="col-12 col-lg-6 d-none" id="violenciaPsicologicaOutrasGroup">
                              <label for="violenciaPsicologicaOutrasTexto" class="form-label">Detalhe outras viol√™ncias psicol√≥gicas</label>
                              <input
                                type="text"
                                class="form-control"
                                id="violenciaPsicologicaOutrasTexto"
                                name="violenciaPsicologicaOutrasTexto"
                              />
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="col-12">
                        <div class="subsection-card h-100">
                          <h3 class="subsection-heading">Sexual</h3>
                          <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-2">
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="sexualEstupro" name="violenciaSexual[]" value="Estupro" />
                                <label class="form-check-label" for="sexualEstupro">Estupro</label>
                              </div>
                            </div>
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="sexualAssedio" name="violenciaSexual[]" value="Ass√©dio sexual" />
                                <label class="form-check-label" for="sexualAssedio">Ass√©dio sexual</label>
                              </div>
                            </div>
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="sexualImportunacao" name="violenciaSexual[]" value="Importuna√ß√£o sexual" />
                                <label class="form-check-label" for="sexualImportunacao">Importuna√ß√£o sexual</label>
                              </div>
                            </div>
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="sexualOutras" name="violenciaSexual[]" value="Outras" />
                                <label class="form-check-label" for="sexualOutras">Outras</label>
                              </div>
                            </div>
                          </div>
                          <div class="row g-3 mt-1">
                            <div class="col-12 col-lg-6 d-none" id="violenciaSexualOutrasGroup">
                              <label for="violenciaSexualOutrasTexto" class="form-label">Detalhe outras viol√™ncias sexuais</label>
                              <input
                                type="text"
                                class="form-control"
                                id="violenciaSexualOutrasTexto"
                                name="violenciaSexualOutrasTexto"
                              />
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="col-12">
                        <div class="subsection-card h-100">
                          <h3 class="subsection-heading">Patrimonial</h3>
                          <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-2">
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="patrimonialRetencao" name="violenciaPatrimonial[]" value="Reten√ß√£o" />
                                <label class="form-check-label" for="patrimonialRetencao">Reten√ß√£o</label>
                              </div>
                            </div>
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="patrimonialSubtracao" name="violenciaPatrimonial[]" value="Subtra√ß√£o" />
                                <label class="form-check-label" for="patrimonialSubtracao">Subtra√ß√£o</label>
                              </div>
                            </div>
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="patrimonialDestruicao" name="violenciaPatrimonial[]" value="Destrui√ß√£o parcial ou total" />
                                <label class="form-check-label" for="patrimonialDestruicao">Destrui√ß√£o parcial ou total</label>
                              </div>
                            </div>
                          </div>
                          <div class="mt-3">
                            <label for="discriminarBens" class="form-label">Discriminar bens</label>
                            <textarea class="form-control" id="discriminarBens" name="discriminarBens" rows="3"></textarea>
                          </div>
                        </div>
                      </div>

                      <div class="col-12">
                        <div class="subsection-card h-100">
                          <h3 class="subsection-heading">Moral</h3>
                          <div class="row row-cols-1 row-cols-md-3 g-2">
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="moralDifamacao" name="violenciaMoral[]" value="Difama√ß√£o" />
                                <label class="form-check-label" for="moralDifamacao">Difama√ß√£o</label>
                              </div>
                            </div>
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="moralInjuria" name="violenciaMoral[]" value="Inj√∫ria" />
                                <label class="form-check-label" for="moralInjuria">Inj√∫ria</label>
                              </div>
                            </div>
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="moralCalunia" name="violenciaMoral[]" value="Cal√∫nia" />
                                <label class="form-check-label" for="moralCalunia">Cal√∫nia</label>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="col-12">
                        <div class="subsection-card h-100">
                          <h3 class="subsection-heading">Tr√°fico de seres humanos</h3>
                          <div class="row row-cols-1 row-cols-md-3 g-2">
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="traficoSexual" name="traficoSeresHumanos[]" value="Fins sexuais" />
                                <label class="form-check-label" for="traficoSexual">Fins sexuais</label>
                              </div>
                            </div>
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="traficoTrabalho" name="traficoSeresHumanos[]" value="Fins de trabalho for√ßado" />
                                <label class="form-check-label" for="traficoTrabalho">Fins trabalho for√ßado</label>
                              </div>
                            </div>
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="traficoOrgaos" name="traficoSeresHumanos[]" value="Fins de retirada de √≥rg√£os" />
                                <label class="form-check-label" for="traficoOrgaos">Fins retirada de √≥rg√£os</label>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="col-12">
                        <div class="subsection-card h-100">
                          <h3 class="subsection-heading">Local da agress√£o</h3>
                          <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-2">
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="localResidencia" name="localAgressao[]" value="Resid√™ncia" />
                                <label class="form-check-label" for="localResidencia">Resid√™ncia</label>
                              </div>
                            </div>
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="localViaPublica" name="localAgressao[]" value="Via p√∫blica" />
                                <label class="form-check-label" for="localViaPublica">Via p√∫blica</label>
                              </div>
                            </div>
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="localTrabalho" name="localAgressao[]" value="Ambiente de trabalho" />
                                <label class="form-check-label" for="localTrabalho">Ambiente de trabalho</label>
                              </div>
                            </div>
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="localEscola" name="localAgressao[]" value="Escola" />
                                <label class="form-check-label" for="localEscola">Escola</label>
                              </div>
                            </div>
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="localHabitacao" name="localAgressao[]" value="Habita√ß√£o coletiva" />
                                <label class="form-check-label" for="localHabitacao">Habita√ß√£o coletiva</label>
                              </div>
                            </div>
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="localTerreno" name="localAgressao[]" value="Terreno baldio" />
                                <label class="form-check-label" for="localTerreno">Terreno baldio</label>
                              </div>
                            </div>
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="localBar" name="localAgressao[]" value="Bar ou similares" />
                                <label class="form-check-label" for="localBar">Bar ou similares</label>
                              </div>
                            </div>
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="localOutros" name="localAgressao[]" value="Outros" />
                                <label class="form-check-label" for="localOutros">Outros</label>
                              </div>
                            </div>
                          </div>
                          <div class="row g-3 mt-1">
                            <div class="col-12 col-lg-6 d-none" id="localAgressaoOutrosGroup">
                              <label for="localAgressaoOutrosTexto" class="form-label">Detalhe outros locais</label>
                              <input
                                type="text"
                                class="form-control"
                                id="localAgressaoOutrosTexto"
                                name="localAgressaoOutrosTexto"
                              />
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="col-12">
                        <div class="subsection-card h-100">
                          <h3 class="subsection-heading">Hor√°rio do ocorrido</h3>
                          <div class="row row-cols-1 row-cols-md-3 g-2">
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="radio" name="horarioOcorrido" id="horarioManha" value="Manh√£" />
                                <label class="form-check-label" for="horarioManha">Manh√£</label>
                              </div>
                            </div>
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="radio" name="horarioOcorrido" id="horarioTarde" value="Tarde" />
                                <label class="form-check-label" for="horarioTarde">Tarde</label>
                              </div>
                            </div>
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="radio" name="horarioOcorrido" id="horarioNoite" value="Noite" />
                                <label class="form-check-label" for="horarioNoite">Noite</label>
                              </div>
                            </div>
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="radio" name="horarioOcorrido" id="horarioMadrugada" value="Madrugada" />
                                <label class="form-check-label" for="horarioMadrugada">Madrugada</label>
                              </div>
                            </div>
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="radio" name="horarioOcorrido" id="horarioTodos" value="Todos os hor√°rios" />
                                <label class="form-check-label" for="horarioTodos">Todos os hor√°rios</label>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="col-12">
                        <div class="subsection-card h-100">
                          <h3 class="subsection-heading">Fatores relacionados √† viol√™ncia</h3>
                          <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-2">
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="fatorCiumes" name="fatoresRelacionados[]" value="Ci√∫mes" />
                                <label class="form-check-label" for="fatorCiumes">Ci√∫mes</label>
                              </div>
                            </div>
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="fatorDoencaMental" name="fatoresRelacionados[]" value="Doen√ßa mental" />
                                <label class="form-check-label" for="fatorDoencaMental">Doen√ßa mental</label>
                              </div>
                            </div>
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="fatorUsoDrogas" name="fatoresRelacionados[]" value="Uso de drogas" />
                                <label class="form-check-label" for="fatorUsoDrogas">Uso de drogas</label>
                              </div>
                            </div>
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="fatorDisputaBens" name="fatoresRelacionados[]" value="Disputa de bens" />
                                <label class="form-check-label" for="fatorDisputaBens">Disputa de bens</label>
                              </div>
                            </div>
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="fatorGravidez" name="fatoresRelacionados[]" value="Gravidez indesejada" />
                                <label class="form-check-label" for="fatorGravidez">Gravidez indesejada</label>
                              </div>
                            </div>
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="fatorAdulterio" name="fatoresRelacionados[]" value="Adult√©rio" />
                                <label class="form-check-label" for="fatorAdulterio">Adult√©rio</label>
                              </div>
                            </div>
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="fatorTemperamento" name="fatoresRelacionados[]" value="Temperamento agressivo" />
                                <label class="form-check-label" for="fatorTemperamento">Temperamento agressivo</label>
                              </div>
                            </div>
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="fatorCausaEconomica" name="fatoresRelacionados[]" value="Causa econ√¥mica" />
                                <label class="form-check-label" for="fatorCausaEconomica">Causa econ√¥mica</label>
                              </div>
                            </div>
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="fatorOutros" name="fatoresRelacionados[]" value="Outros" />
                                <label class="form-check-label" for="fatorOutros">Outros</label>
                              </div>
                            </div>
                          </div>
                          <div class="row g-3 mt-1">
                            <div class="col-12 col-lg-6 d-none" id="fatoresRelacionadosOutrosGroup">
                              <label for="fatoresRelacionadosOutrosTexto" class="form-label">Detalhe outros fatores</label>
                              <input
                                type="text"
                                class="form-control"
                                id="fatoresRelacionadosOutrosTexto"
                                name="fatoresRelacionadosOutrosTexto"
                              />
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="col-12">
                        <div class="subsection-card h-100">
                          <h3 class="subsection-heading">Pessoas que t√™m conhecimento das agress√µes</h3>
                          <div class="row g-3">
                            <div class="col-12 col-lg-4">
                              <div class="form-check">
                                <input class="form-check-input" type="radio" name="conhecimentoAgressao" id="conhecimentoSim" value="Sim" />
                                <label class="form-check-label" for="conhecimentoSim">Sim</label>
                              </div>
                              <div class="form-check">
                                <input class="form-check-input" type="radio" name="conhecimentoAgressao" id="conhecimentoNao" value="N√£o" />
                                <label class="form-check-label" for="conhecimentoNao">N√£o</label>
                              </div>
                            </div>
                            <div class="col-12 col-lg-8 d-none" id="conhecimentoExtras">
                              <div class="row g-3">
                                <div class="col-12">
                                  <label for="conhecimentoContato" class="form-label">Contato de refer√™ncia</label>
                                  <input type="text" class="form-control" id="conhecimentoContato" name="conhecimentoContato" />
                                </div>
                                <div class="col-12 col-md-6">
                                  <label for="conhecimentoTelefone" class="form-label">Telefone</label>
                                  <input type="text" class="form-control" id="conhecimentoTelefone" name="conhecimentoTelefone" />
                                </div>
                                <div class="col-12 col-md-6">
                                  <label for="conhecimentoGrau" class="form-label">Grau de relacionamento</label>
                                  <select id="conhecimentoGrau" name="conhecimentoGrau" class="form-select" data-choices="true" data-choices-search="true">
                                    <option value="">Selecione</option>
                                    <option>Familiar</option>
                                    <option>Vizinho(a)</option>
                                    <option>Amigo(a)</option>
                                    <option>Colega de trabalho</option>
                                    <option>Agente de sa√∫de</option>
                                    <option>Outro</option>
                                  </select>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="col-12">
                        <div class="subsection-card h-100">
                          <h3 class="subsection-heading">Solicitar senha CIODS?</h3>
                          <div class="row g-3">
                            <div class="col-12 col-lg-4">
                              <div class="form-check">
                                <input class="form-check-input" type="radio" name="solicitarCiods" id="solicitarCiodsSim" value="Sim" />
                                <label class="form-check-label" for="solicitarCiodsSim">Sim</label>
                              </div>
                              <div class="form-check">
                                <input class="form-check-input" type="radio" name="solicitarCiods" id="solicitarCiodsNao" value="N√£o" />
                                <label class="form-check-label" for="solicitarCiodsNao">N√£o</label>
                              </div>
                            </div>
                            <div class="col-12 col-lg-8 d-none" id="ciodsCampos">
                              <div class="mb-3">
                                <label for="corpoEmailCiods" class="form-label">O qual relata que...</label>
                                <textarea class="form-control" id="corpoEmailCiods" name="corpoEmailCiods" rows="4"></textarea>
                              </div>
                              <div>
                                <label for="senhaCiodsDescricao" class="form-label">Senha CIODS solicitada por e-mail</label>
                                <input
                                  type="text"
                                  class="form-control"
                                  id="senhaCiodsDescricao"
                                  name="senhaCiodsDescricao"
                                  value="Solicita√ß√£o enviada via e-mail institucional."
                                  readonly
                                />
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="col-12">
                        <div class="subsection-card h-100">
                          <h3 class="subsection-heading">Relato do caso</h3>
                          <div class="row g-3">
                            <div class="col-12">
                              <label for="relatoCaso" class="form-label required">Descreva o caso aqui</label>
                              <textarea class="form-control" id="relatoCaso" name="relatoCaso" rows="5" required></textarea>
                            </div>
                            <div class="col-12 d-flex align-items-center gap-2">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editarRelato" name="editarRelato" checked />
                                <label class="form-check-label" for="editarRelato">Editar relato</label>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </section>

              <section class="card-section mb-4" aria-labelledby="evolucoes">
                <h2 class="form-section-title" id="evolucoes"><i class="bi bi-journal-text"></i>Evolu√ß√µes</h2>
                <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
                  <p class="text-muted mb-0">Registre as evolu√ß√µes realizadas no acompanhamento t√©cnico.</p>
                  <button
                    type="button"
                    class="btn btn-primary btn-sm"
                    data-bs-toggle="modal"
                    data-bs-target="#evolucaoModal"
                    data-modal-child-trigger="true"
                  >
                    <i class="bi bi-plus-lg me-2"></i>Adicionar evolu√ß√£o
                  </button>
                </div>
                <div class="table-responsive border rounded shadow-sm">
                  <table class="table table-hover mb-0 align-middle">
                    <thead class="table-light">
                      <tr>
                        <th scope="col">Data</th>
                        <th scope="col">Unidade</th>
                        <th scope="col">Evolu√ß√£o</th>
                        <th scope="col">Profissional</th>
                        <th scope="col" class="d-none">Identificador</th>
                      </tr>
                    </thead>
                    <tbody id="evolucaoTabelaBody">
                      <tr id="evolucaoVazia">
                        <td colspan="5" class="text-center text-muted py-4">Nenhuma evolu√ß√£o registrada.</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                <div id="evolucaoHiddenInputs"></div>
              </section>

              <section class="card-section mb-4" aria-labelledby="dados-juridicos">
                <h2 class="form-section-title" id="dados-juridicos"><i class="bi bi-gavel"></i>Dados jur√≠dicos</h2>
                <div class="row g-4">
                  <div class="col-12">
                    <div class="subsection-card">
                      <h3 class="subsection-heading">Processos e registros</h3>
                      <div class="row g-3">
                        <div class="col-12 col-md-4">
                          <label for="naturezaCivel" class="form-label">C√≠vel</label>
                          <select id="naturezaCivel" name="naturezaCivel" class="form-select">
                            <option value="">Selecione</option>
                            <option>N√£o se aplica</option>
                            <option>Em andamento</option>
                            <option>Senten√ßa proferida</option>
                            <option>Arquivado</option>
                          </select>
                        </div>
                        <div class="col-12 col-md-4">
                          <label for="naturezaCriminal" class="form-label">Criminal</label>
                          <select id="naturezaCriminal" name="naturezaCriminal" class="form-select">
                            <option value="">Selecione</option>
                            <option>N√£o se aplica</option>
                            <option>Em andamento</option>
                            <option>Senten√ßa proferida</option>
                            <option>Arquivado</option>
                          </select>
                        </div>
                        <div class="col-12 col-md-4">
                          <label for="naturezaTrabalhista" class="form-label">Trabalhista</label>
                          <select id="naturezaTrabalhista" name="naturezaTrabalhista" class="form-select">
                            <option value="">Selecione</option>
                            <option>N√£o se aplica</option>
                            <option>Em andamento</option>
                            <option>Senten√ßa proferida</option>
                            <option>Arquivado</option>
                          </select>
                        </div>
                        <div class="col-12 col-md-4">
                          <label for="registroOcorrencia" class="form-label">Registro da ocorr√™ncia</label>
                          <select id="registroOcorrencia" name="registroOcorrencia" class="form-select">
                            <option value="">Selecione</option>
                            <option value="Nao">N√£o</option>
                            <option value="Registrada">Registrada</option>
                            <option value="Em andamento">Em andamento</option>
                          </select>
                        </div>
                        <div class="col-12 col-md-4 d-none" id="numeroBoGroup">
                          <label for="numeroBo" class="form-label">N¬∫ B.O.</label>
                          <input type="text" class="form-control" id="numeroBo" name="numeroBo" />
                        </div>
                        <div class="col-12 col-md-4">
                          <label for="origemProcedimento" class="form-label">Origem</label>
                          <select id="origemProcedimento" name="origemProcedimento" class="form-select">
                            <option value="">Selecione</option>
                            <option value="Delegacia">Delegacia</option>
                            <option value="Ministerio Publico">Minist√©rio P√∫blico</option>
                            <option value="Judiciario">Poder Judici√°rio</option>
                            <option value="Outros">Outros</option>
                          </select>
                        </div>
                        <div class="col-12 col-md-4 d-none" id="numeroInqueritoGroup">
                          <label for="numeroInquerito" class="form-label">N¬∫ do inqu√©rito</label>
                          <input type="text" class="form-control" id="numeroInquerito" name="numeroInquerito" />
                        </div>
                        <div class="col-12 col-md-4">
                          <label for="exameCorpoDelito" class="form-label">Exame de corpo de delito</label>
                          <select id="exameCorpoDelito" name="exameCorpoDelito" class="form-select">
                            <option value="">Selecione</option>
                            <option value="Nao">N√£o</option>
                            <option value="Sim">Sim</option>
                            <option value="Em andamento">Em andamento</option>
                          </select>
                        </div>
                        <div class="col-12 col-md-4 d-none" id="orgaoEmitenteGroup">
                          <label for="orgaoEmitente" class="form-label">√ìrg√£o emitente</label>
                          <input type="text" class="form-control" id="orgaoEmitente" name="orgaoEmitente" />
                        </div>
                        <div class="col-12 col-md-4">
                          <label for="fianca" class="form-label">Fian√ßa</label>
                          <select id="fianca" name="fianca" class="form-select">
                            <option value="">Selecione</option>
                            <option value="Nao">N√£o</option>
                            <option value="Sim">Sim</option>
                          </select>
                        </div>
                        <div class="col-12 col-md-4 d-none" id="valorFiancaGroup">
                          <label for="valorFianca" class="form-label">Valor</label>
                          <input type="text" class="form-control" id="valorFianca" name="valorFianca" />
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="col-12">
                    <div class="subsection-card">
                      <h3 class="subsection-heading">Medida protetiva de urg√™ncia</h3>
                      <div class="row g-3 align-items-center">
                        <div class="col-12 col-md-4">
                          <span class="form-label d-block">J√° solicitou medida protetiva?</span>
                          <div class="d-flex gap-3">
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="medidaSolicitada" id="medidaSolicitadaSim" value="Sim" />
                              <label class="form-check-label" for="medidaSolicitadaSim">Sim</label>
                            </div>
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="medidaSolicitada" id="medidaSolicitadaNao" value="Nao" checked />
                              <label class="form-check-label" for="medidaSolicitadaNao">N√£o</label>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="row g-3 mt-0 d-none" id="medidaUrgenciaDetalhes">
                        <div class="col-12 col-md-3">
                          <label for="dataSolicitacaoMpu" class="form-label">Data da solicita√ß√£o</label>
                          <input type="date" class="form-control" id="dataSolicitacaoMpu" name="dataSolicitacaoMpu" />
                        </div>
                        <div class="col-12 col-md-3">
                          <label for="numeroMpu" class="form-label">Numera√ß√£o MPU</label>
                          <input type="text" class="form-control" id="numeroMpu" name="numeroMpu" />
                        </div>
                        <div class="col-12 col-md-3">
                          <label for="varaMpu" class="form-label">Vara</label>
                          <input type="text" class="form-control" id="varaMpu" name="varaMpu" />
                        </div>
                        <div class="col-12 col-md-3">
                          <span class="form-label d-block">Deferidas?</span>
                          <div class="d-flex gap-3">
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="medidaDeferida" id="medidaDeferidaSim" value="Sim" />
                              <label class="form-check-label" for="medidaDeferidaSim">Sim</label>
                            </div>
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="medidaDeferida" id="medidaDeferidaNao" value="Nao" checked />
                              <label class="form-check-label" for="medidaDeferidaNao">N√£o</label>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="col-12 mt-3">
                        <label for="observacoesMpu" class="form-label">Observa√ß√µes sobre indeferimentos de MPU</label>
                        <textarea class="form-control" id="observacoesMpu" name="observacoesMpu"></textarea>
                      </div>
                    </div>
                  </div>

                  <div class="col-12 d-none" id="medidasDeferidasWrapper">
                    <div class="subsection-card">
                      <h3 class="subsection-heading">Medidas protetivas deferidas</h3>
                      <div class="row g-3">
                        <div class="col-12 col-md-4">
                          <label for="dataDeferimentoMpu" class="form-label">Data do deferimento</label>
                          <input type="date" class="form-control" id="dataDeferimentoMpu" name="dataDeferimentoMpu" />
                        </div>
                      </div>
                      <div class="row g-3 mt-0">
                        <div class="col-12">
                          <span class="form-label d-block">Medidas que obrigam o agressor</span>
                          <div class="row row-cols-1 row-cols-md-2 g-2">
                            <div class="col"><div class="form-check"><input class="form-check-input" type="checkbox" id="medidaObrigacaoI" name="medidasObrigacao[]" value="I. Suspens√£o da posse de armas" /><label class="form-check-label" for="medidaObrigacaoI">I. Suspens√£o da posse de armas</label></div></div>
                            <div class="col"><div class="form-check"><input class="form-check-input" type="checkbox" id="medidaObrigacaoII" name="medidasObrigacao[]" value="II. Afastamento do lar" /><label class="form-check-label" for="medidaObrigacaoII">II. Afastamento do lar</label></div></div>
                            <div class="col"><div class="form-check"><input class="form-check-input" type="checkbox" id="medidaObrigacaoIIIa" name="medidasObrigacao[]" value="III.a Proibi√ß√£o de aproxima√ß√£o" /><label class="form-check-label" for="medidaObrigacaoIIIa">III.a Proibi√ß√£o de determinadas condutas (aproxima√ß√£o)</label></div></div>
                            <div class="col"><div class="form-check"><input class="form-check-input" type="checkbox" id="medidaObrigacaoIIIb" name="medidasObrigacao[]" value="III.b Proibi√ß√£o de contato" /><label class="form-check-label" for="medidaObrigacaoIIIb">III.b Proibi√ß√£o de determinadas condutas (contato)</label></div></div>
                            <div class="col"><div class="form-check"><input class="form-check-input" type="checkbox" id="medidaObrigacaoIIIc" name="medidasObrigacao[]" value="III.c Proibi√ß√£o de frequentar lugares" /><label class="form-check-label" for="medidaObrigacaoIIIc">III.c Proibi√ß√£o de determinadas condutas (frequentar lugares)</label></div></div>
                            <div class="col"><div class="form-check"><input class="form-check-input" type="checkbox" id="medidaObrigacaoIV" name="medidasObrigacao[]" value="IV. Restri√ß√£o de visitas" /><label class="form-check-label" for="medidaObrigacaoIV">IV. Restri√ß√£o de visitas a dependentes</label></div></div>
                            <div class="col"><div class="form-check"><input class="form-check-input" type="checkbox" id="medidaObrigacaoV" name="medidasObrigacao[]" value="V. Presta√ß√£o de alimentos provis√≥rios" /><label class="form-check-label" for="medidaObrigacaoV">V. Presta√ß√£o de alimentos provis√≥rios</label></div></div>
                            <div class="col"><div class="form-check"><input class="form-check-input" type="checkbox" id="medidaObrigacaoVI" name="medidasObrigacao[]" value="VI. Comparecimento a programas de reeduca√ß√£o" /><label class="form-check-label" for="medidaObrigacaoVI">VI. Comparecimento a programas de reeduca√ß√£o</label></div></div>
                            <div class="col"><div class="form-check"><input class="form-check-input" type="checkbox" id="medidaObrigacaoVII" name="medidasObrigacao[]" value="VII. Acompanhamento psicossocial" /><label class="form-check-label" for="medidaObrigacaoVII">VII. Acompanhamento psicossocial</label></div></div>
                          </div>
                        </div>
                        <div class="col-12">
                          <span class="form-label d-block">Medidas de urg√™ncia √† ofendida</span>
                          <div class="row row-cols-1 row-cols-md-2 g-2">
                            <div class="col"><div class="form-check"><input class="form-check-input" type="checkbox" id="medidaOfendidaI" name="medidasOfendida[]" value="I. Encaminhamento a programa de prote√ß√£o" /><label class="form-check-label" for="medidaOfendidaI">I. Encaminhamento a programa de prote√ß√£o</label></div></div>
                            <div class="col"><div class="form-check"><input class="form-check-input" type="checkbox" id="medidaOfendidaII" name="medidasOfendida[]" value="II. Recondu√ß√£o ao domic√≠lio" /><label class="form-check-label" for="medidaOfendidaII">II. Recondu√ß√£o ao domic√≠lio</label></div></div>
                            <div class="col"><div class="form-check"><input class="form-check-input" type="checkbox" id="medidaOfendidaIII" name="medidasOfendida[]" value="III. Afastamento do lar" /><label class="form-check-label" for="medidaOfendidaIII">III. Afastamento do lar</label></div></div>
                            <div class="col"><div class="form-check"><input class="form-check-input" type="checkbox" id="medidaOfendidaIV" name="medidasOfendida[]" value="IV. Separa√ß√£o de corpos" /><label class="form-check-label" for="medidaOfendidaIV">IV. Separa√ß√£o de corpos</label></div></div>
                            <div class="col"><div class="form-check"><input class="form-check-input" type="checkbox" id="medidaOfendidaV" name="medidasOfendida[]" value="V. Matr√≠cula de dependentes" /><label class="form-check-label" for="medidaOfendidaV">V. Matr√≠cula de dependentes em escola pr√≥xima</label></div></div>
                          </div>
                        </div>
                        <div class="col-12">
                          <span class="form-label d-block">Medidas de prote√ß√£o patrimonial</span>
                          <div class="row row-cols-1 row-cols-md-2 g-2">
                            <div class="col"><div class="form-check"><input class="form-check-input" type="checkbox" id="medidaPatrimonialI" name="medidasPatrimoniais[]" value="I. Restitui√ß√£o de bens subtra√≠dos" /><label class="form-check-label" for="medidaPatrimonialI">I. Restitui√ß√£o de bens subtra√≠dos</label></div></div>
                            <div class="col"><div class="form-check"><input class="form-check-input" type="checkbox" id="medidaPatrimonialII" name="medidasPatrimoniais[]" value="II. Proibi√ß√£o de atos de compra/venda" /><label class="form-check-label" for="medidaPatrimonialII">II. Proibi√ß√£o de atos de compra/venda</label></div></div>
                            <div class="col"><div class="form-check"><input class="form-check-input" type="checkbox" id="medidaPatrimonialIII" name="medidasPatrimoniais[]" value="III. Suspens√£o de procura√ß√µes" /><label class="form-check-label" for="medidaPatrimonialIII">III. Suspens√£o de procura√ß√µes conferidas ao agressor</label></div></div>
                            <div class="col"><div class="form-check"><input class="form-check-input" type="checkbox" id="medidaPatrimonialIV" name="medidasPatrimoniais[]" value="IV. Presta√ß√£o de cau√ß√£o provis√≥ria" /><label class="form-check-label" for="medidaPatrimonialIV">IV. Presta√ß√£o de cau√ß√£o provis√≥ria</label></div></div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="col-12">
                    <div class="subsection-card">
                      <h3 class="subsection-heading">Descumprimento de medidas protetivas</h3>
                      <div class="row g-3">
                        <div class="col-12 col-md-4">
                          <span class="form-label d-block">Houve descumprimento?</span>
                          <div class="d-flex gap-3">
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="descumprimento" id="descumprimentoSim" value="Sim" />
                              <label class="form-check-label" for="descumprimentoSim">Sim</label>
                            </div>
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="descumprimento" id="descumprimentoNao" value="Nao" checked />
                              <label class="form-check-label" for="descumprimentoNao">N√£o</label>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="row g-3 mt-0 d-none" id="descumprimentoCampos">
                        <div class="col-12 col-md-4">
                          <span class="form-label d-block">Registro de B.O. de descumprimento</span>
                          <div class="d-flex gap-3">
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="descumprimentoBo" id="descumprimentoBoSim" value="Sim" />
                              <label class="form-check-label" for="descumprimentoBoSim">Sim</label>
                            </div>
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="descumprimentoBo" id="descumprimentoBoNao" value="Nao" checked />
                              <label class="form-check-label" for="descumprimentoBoNao">N√£o</label>
                            </div>
                          </div>
                        </div>
                        <div class="col-12 col-md-4 d-none" id="descumprimentoBoNumeroGroup">
                          <label for="descumprimentoNumeroBo" class="form-label">N√∫mero do B.O.</label>
                          <input type="text" class="form-control" id="descumprimentoNumeroBo" name="descumprimentoNumeroBo" />
                        </div>
                        <div class="col-12 col-md-4 d-none" id="descumprimentoBoDataGroup">
                          <label for="descumprimentoDataBo" class="form-label">Data do B.O.</label>
                          <input type="date" class="form-control" id="descumprimentoDataBo" name="descumprimentoDataBo" />
                        </div>
                      </div>
                      <div class="row g-3 mt-0">
                        <div class="col-12 col-md-4">
                          <span class="form-label d-block">H√° decis√£o mais gravosa?</span>
                          <div class="d-flex gap-3">
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="decisaoGravosa" id="decisaoGravosaSim" value="Sim" />
                              <label class="form-check-label" for="decisaoGravosaSim">Sim</label>
                            </div>
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="decisaoGravosa" id="decisaoGravosaNao" value="Nao" checked />
                              <label class="form-check-label" for="decisaoGravosaNao">N√£o</label>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="row g-3 mt-0 d-none" id="decisaoGravosaCampos">
                        <div class="col-12 col-md-4">
                          <label for="decisaoGravosaQual" class="form-label">Qual?</label>
                          <input type="text" class="form-control" id="decisaoGravosaQual" name="decisaoGravosaQual" />
                        </div>
                        <div class="col-12 col-md-4">
                          <div class="form-check mt-4">
                            <input class="form-check-input" type="checkbox" id="decisaoGravosaMonitoramento" name="decisaoGravosaExtras[]" value="Monitoramento eletr√¥nico" />
                            <label class="form-check-label" for="decisaoGravosaMonitoramento">Monitoramento eletr√¥nico</label>
                          </div>
                          <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" id="decisaoGravosaPrisao" name="decisaoGravosaExtras[]" value="Pris√£o" />
                            <label class="form-check-label" for="decisaoGravosaPrisao">Pris√£o</label>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="col-12">
                    <div class="subsection-card">
                      <h3 class="subsection-heading">A√ß√£o penal e queixa-crime</h3>
                      <div class="row g-3">
                        <div class="col-12 col-md-4">
                          <span class="form-label d-block">Existe a√ß√£o penal?</span>
                          <div class="d-flex gap-3">
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="acaoPenal" id="acaoPenalSim" value="Sim" />
                              <label class="form-check-label" for="acaoPenalSim">Sim</label>
                            </div>
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="acaoPenal" id="acaoPenalNao" value="Nao" checked />
                              <label class="form-check-label" for="acaoPenalNao">N√£o</label>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="row g-3 mt-0 d-none" id="acaoPenalCampos">
                        <div class="col-12 col-md-4">
                          <label for="acaoPenalNumero" class="form-label">N¬∫ Proc. A√ß√£o Penal</label>
                          <input type="text" class="form-control" id="acaoPenalNumero" name="acaoPenalNumero" />
                        </div>
                        <div class="col-12 col-md-4">
                          <label for="acaoPenalVara" class="form-label">Vara</label>
                          <input type="text" class="form-control" id="acaoPenalVara" name="acaoPenalVara" />
                        </div>
                      </div>
                      <div class="row g-3 mt-0">
                        <div class="col-12 col-md-4">
                          <span class="form-label d-block">Existe queixa-crime?</span>
                          <div class="d-flex gap-3">
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="queixaCrime" id="queixaCrimeSim" value="Sim" />
                              <label class="form-check-label" for="queixaCrimeSim">Sim</label>
                            </div>
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="queixaCrime" id="queixaCrimeNao" value="Nao" checked />
                              <label class="form-check-label" for="queixaCrimeNao">N√£o</label>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="row g-3 mt-0 d-none" id="queixaCrimeCampos">
                        <div class="col-12 col-md-4">
                          <label for="queixaCrimeNumero" class="form-label">N¬∫ Proc. Queixa-crime</label>
                          <input type="text" class="form-control" id="queixaCrimeNumero" name="queixaCrimeNumero" />
                        </div>
                        <div class="col-12 col-md-4">
                          <label for="queixaCrimeVara" class="form-label">Vara</label>
                          <input type="text" class="form-control" id="queixaCrimeVara" name="queixaCrimeVara" />
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="col-12">
                    <div class="subsection-card">
                      <h3 class="subsection-heading">Informa√ß√µes complementares</h3>
                      <div class="row g-3">
                        <div class="col-12 col-md-4">
                          <span class="form-label d-block">V√≠tima aceitou abrigamento?</span>
                          <div class="d-flex gap-3">
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="abrigamento" id="abrigamentoSim" value="Sim" />
                              <label class="form-check-label" for="abrigamentoSim">Sim</label>
                            </div>
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="abrigamento" id="abrigamentoNao" value="Nao" checked />
                              <label class="form-check-label" for="abrigamentoNao">N√£o</label>
                            </div>
                          </div>
                        </div>
                        <div class="col-12 col-md-4 d-none" id="dataAbrigoGroup">
                          <label for="dataAbrigo" class="form-label">Data do abrigamento</label>
                          <input type="date" class="form-control" id="dataAbrigo" name="dataAbrigo" />
                        </div>
                        <div class="col-12 col-md-4">
                          <label for="dataDesabrigamento" class="form-label">Data do desabrigamento</label>
                          <input type="date" class="form-control" id="dataDesabrigamento" name="dataDesabrigamento" />
                        </div>
                        <div class="col-12 col-md-4">
                          <span class="form-label d-block">Brigada Maria da Penha</span>
                          <div class="d-flex gap-3">
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="brigadaMaria" id="brigadaMariaSim" value="Sim" />
                              <label class="form-check-label" for="brigadaMariaSim">Sim</label>
                            </div>
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="brigadaMaria" id="brigadaMariaNao" value="Nao" checked />
                              <label class="form-check-label" for="brigadaMariaNao">N√£o</label>
                            </div>
                          </div>
                        </div>
                        <div class="col-12">
                          <label for="observacoesJuridicas" class="form-label">Observa√ß√µes</label>
                          <textarea class="form-control" id="observacoesJuridicas" name="observacoesJuridicas"></textarea>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="col-12">
                    <div class="subsection-card">
                      <h3 class="subsection-heading">Encaminhamentos</h3>
                      <p class="text-muted mb-3">Selecione os encaminhamentos externos realizados e informe complementos quando necess√°rio.</p>
                      <div class="row row-cols-1 row-cols-md-2 g-3" id="encaminhamentosExternos">
                        <div class="col">
                          <div class="form-check">
                            <input class="form-check-input encaminhamento-checkbox" type="checkbox" id="encaminhamentoNucleoAbrigamento" name="encaminhamentosExternos[]" value="N√∫cleo Abrigamento" data-complement-target="#encaminhamentoNucleoAbrigamentoDetalhe" />
                            <label class="form-check-label" for="encaminhamentoNucleoAbrigamento">N√∫cleo Abrigamento</label>
                          </div>
                          <div class="mt-2 d-none" id="encaminhamentoNucleoAbrigamentoDetalhe">
                            <label class="form-label visually-hidden" for="encaminhamentoNucleoAbrigamentoComplemento">Complemento N√∫cleo Abrigamento</label>
                            <input type="text" class="form-control" id="encaminhamentoNucleoAbrigamentoComplemento" name="encaminhamentosComplemento[N√∫cleo Abrigamento]" />
                          </div>
                        </div>
                        <div class="col">
                          <div class="form-check">
                            <input class="form-check-input encaminhamento-checkbox" type="checkbox" id="encaminhamentoCentroReferencia" name="encaminhamentosExternos[]" value="Centro de Refer√™ncia" data-complement-target="#encaminhamentoCentroReferenciaDetalhe" />
                            <label class="form-check-label" for="encaminhamentoCentroReferencia">Centro de Refer√™ncia</label>
                          </div>
                          <div class="mt-2 d-none" id="encaminhamentoCentroReferenciaDetalhe">
                            <label class="form-label visually-hidden" for="encaminhamentoCentroReferenciaComplemento">Complemento Centro de Refer√™ncia</label>
                            <input type="text" class="form-control" id="encaminhamentoCentroReferenciaComplemento" name="encaminhamentosComplemento[Centro de Refer√™ncia]" />
                          </div>
                        </div>
                        <div class="col">
                          <div class="form-check">
                            <input class="form-check-input encaminhamento-checkbox" type="checkbox" id="encaminhamentoVaraViolencia" name="encaminhamentosExternos[]" value="Vara de Viol√™ncia Dom√©stica e Familiar" data-complement-target="#encaminhamentoVaraViolenciaDetalhe" />
                            <label class="form-check-label" for="encaminhamentoVaraViolencia">Vara de Viol√™ncia Dom√©stica e Familiar</label>
                          </div>
                          <div class="mt-2 d-none" id="encaminhamentoVaraViolenciaDetalhe">
                            <label class="form-label visually-hidden" for="encaminhamentoVaraViolenciaComplemento">Complemento Vara de Viol√™ncia</label>
                            <input type="text" class="form-control" id="encaminhamentoVaraViolenciaComplemento" name="encaminhamentosComplemento[Vara de Viol√™ncia Dom√©stica e Familiar]" />
                          </div>
                        </div>
                        <div class="col">
                          <div class="form-check">
                            <input class="form-check-input encaminhamento-checkbox" type="checkbox" id="encaminhamentoDefensoria" name="encaminhamentosExternos[]" value="Defensoria Especializada" data-complement-target="#encaminhamentoDefensoriaDetalhe" />
                            <label class="form-check-label" for="encaminhamentoDefensoria">Defensoria Especializada</label>
                          </div>
                          <div class="mt-2 d-none" id="encaminhamentoDefensoriaDetalhe">
                            <label class="form-label visually-hidden" for="encaminhamentoDefensoriaComplemento">Complemento Defensoria</label>
                            <input type="text" class="form-control" id="encaminhamentoDefensoriaComplemento" name="encaminhamentosComplemento[Defensoria Especializada]" />
                          </div>
                        </div>
                        <div class="col">
                          <div class="form-check">
                            <input class="form-check-input encaminhamento-checkbox" type="checkbox" id="encaminhamentoMppe" name="encaminhamentosExternos[]" value="N√∫cleo de Apoio √† Mulher (MPPE)" data-complement-target="#encaminhamentoMppeDetalhe" />
                            <label class="form-check-label" for="encaminhamentoMppe">N√∫cleo de Apoio √† Mulher (MPPE)</label>
                          </div>
                          <div class="mt-2 d-none" id="encaminhamentoMppeDetalhe">
                            <label class="form-label visually-hidden" for="encaminhamentoMppeComplemento">Complemento MPPE</label>
                            <input type="text" class="form-control" id="encaminhamentoMppeComplemento" name="encaminhamentosComplemento[N√∫cleo de Apoio √† Mulher (MPPE)]" />
                          </div>
                        </div>
                        <div class="col">
                          <div class="form-check">
                            <input class="form-check-input encaminhamento-checkbox" type="checkbox" id="encaminhamentoDelegaciaEspecializada" name="encaminhamentosExternos[]" value="Delegacia Especializada em VDF/CFM" data-complement-target="#encaminhamentoDelegaciaEspecializadaDetalhe" />
                            <label class="form-check-label" for="encaminhamentoDelegaciaEspecializada">Delegacia Especializada em VDF/CFM</label>
                          </div>
                          <div class="mt-2 d-none" id="encaminhamentoDelegaciaEspecializadaDetalhe">
                            <label class="form-label visually-hidden" for="encaminhamentoDelegaciaEspecializadaComplemento">Complemento Delegacia Especializada</label>
                            <input type="text" class="form-control" id="encaminhamentoDelegaciaEspecializadaComplemento" name="encaminhamentosComplemento[Delegacia Especializada em VDF/CFM]" />
                          </div>
                        </div>
                        <div class="col">
                          <div class="form-check">
                            <input class="form-check-input encaminhamento-checkbox" type="checkbox" id="encaminhamentoDelegaciaInfancia" name="encaminhamentosExternos[]" value="Delegacia da Inf√¢ncia e Juventude" data-complement-target="#encaminhamentoDelegaciaInfanciaDetalhe" />
                            <label class="form-check-label" for="encaminhamentoDelegaciaInfancia">Delegacia da Inf√¢ncia e Juventude</label>
                          </div>
                          <div class="mt-2 d-none" id="encaminhamentoDelegaciaInfanciaDetalhe">
                            <label class="form-label visually-hidden" for="encaminhamentoDelegaciaInfanciaComplemento">Complemento Delegacia da Inf√¢ncia</label>
                            <input type="text" class="form-control" id="encaminhamentoDelegaciaInfanciaComplemento" name="encaminhamentosComplemento[Delegacia da Inf√¢ncia e Juventude]" />
                          </div>
                        </div>
                        <div class="col">
                          <div class="form-check">
                            <input class="form-check-input encaminhamento-checkbox" type="checkbox" id="encaminhamentoDelegaciaIdoso" name="encaminhamentosExternos[]" value="Delegacia do Idoso" data-complement-target="#encaminhamentoDelegaciaIdosoDetalhe" />
                            <label class="form-check-label" for="encaminhamentoDelegaciaIdoso">Delegacia do Idoso</label>
                          </div>
                          <div class="mt-2 d-none" id="encaminhamentoDelegaciaIdosoDetalhe">
                            <label class="form-label visually-hidden" for="encaminhamentoDelegaciaIdosoComplemento">Complemento Delegacia do Idoso</label>
                            <input type="text" class="form-control" id="encaminhamentoDelegaciaIdosoComplemento" name="encaminhamentosComplemento[Delegacia do Idoso]" />
                          </div>
                        </div>
                        <div class="col">
                          <div class="form-check">
                            <input class="form-check-input encaminhamento-checkbox" type="checkbox" id="encaminhamentoDelegaciaComum" name="encaminhamentosExternos[]" value="Delegacia de Pol√≠cia ‚Äì Crimes Comuns" data-complement-target="#encaminhamentoDelegaciaComumDetalhe" />
                            <label class="form-check-label" for="encaminhamentoDelegaciaComum">Delegacia de Pol√≠cia ‚Äì Crimes Comuns</label>
                          </div>
                          <div class="mt-2 d-none" id="encaminhamentoDelegaciaComumDetalhe">
                            <label class="form-label visually-hidden" for="encaminhamentoDelegaciaComumComplemento">Complemento Delegacia Comum</label>
                            <input type="text" class="form-control" id="encaminhamentoDelegaciaComumComplemento" name="encaminhamentosComplemento[Delegacia de Pol√≠cia ‚Äì Crimes Comuns]" />
                          </div>
                        </div>
                        <div class="col">
                          <div class="form-check">
                            <input class="form-check-input encaminhamento-checkbox" type="checkbox" id="encaminhamentoCasaJustica" name="encaminhamentosExternos[]" value="Casa da Justi√ßa e Cidadania" data-complement-target="#encaminhamentoCasaJusticaDetalhe" />
                            <label class="form-check-label" for="encaminhamentoCasaJustica">Casa da Justi√ßa e Cidadania</label>
                          </div>
                          <div class="mt-2 d-none" id="encaminhamentoCasaJusticaDetalhe">
                            <label class="form-label visually-hidden" for="encaminhamentoCasaJusticaComplemento">Complemento Casa da Justi√ßa</label>
                            <input type="text" class="form-control" id="encaminhamentoCasaJusticaComplemento" name="encaminhamentosComplemento[Casa da Justi√ßa e Cidadania]" />
                          </div>
                        </div>
                        <div class="col">
                          <div class="form-check">
                            <input class="form-check-input encaminhamento-checkbox" type="checkbox" id="encaminhamentoSaudeEspecializada" name="encaminhamentosExternos[]" value="Sa√∫de Especializada / Viol√™ncia Sexual" data-complement-target="#encaminhamentoSaudeEspecializadaDetalhe" />
                            <label class="form-check-label" for="encaminhamentoSaudeEspecializada">Sa√∫de Especializada / Viol√™ncia Sexual</label>
                          </div>
                          <div class="mt-2 d-none" id="encaminhamentoSaudeEspecializadaDetalhe">
                            <label class="form-label visually-hidden" for="encaminhamentoSaudeEspecializadaComplemento">Complemento Sa√∫de Especializada</label>
                            <input type="text" class="form-control" id="encaminhamentoSaudeEspecializadaComplemento" name="encaminhamentosComplemento[Sa√∫de Especializada / Viol√™ncia Sexual]" />
                          </div>
                        </div>
                        <div class="col">
                          <div class="form-check">
                            <input class="form-check-input encaminhamento-checkbox" type="checkbox" id="encaminhamentoRedeAssistencia" name="encaminhamentosExternos[]" value="Rede de Assist√™ncia Social" data-complement-target="#encaminhamentoRedeAssistenciaDetalhe" />
                            <label class="form-check-label" for="encaminhamentoRedeAssistencia">Rede de Assist√™ncia Social</label>
                          </div>
                          <div class="mt-2 d-none" id="encaminhamentoRedeAssistenciaDetalhe">
                            <label class="form-label visually-hidden" for="encaminhamentoRedeAssistenciaComplemento">Complemento Rede de Assist√™ncia</label>
                            <input type="text" class="form-control" id="encaminhamentoRedeAssistenciaComplemento" name="encaminhamentosComplemento[Rede de Assist√™ncia Social]" />
                          </div>
                        </div>
                        <div class="col">
                          <div class="form-check">
                            <input class="form-check-input encaminhamento-checkbox" type="checkbox" id="encaminhamentoCentroMunicipalMulher" name="encaminhamentosExternos[]" value="Centro Municipal da Mulher" data-complement-target="#encaminhamentoCentroMunicipalMulherDetalhe" />
                            <label class="form-check-label" for="encaminhamentoCentroMunicipalMulher">Centro Municipal da Mulher</label>
                          </div>
                          <div class="mt-2 d-none" id="encaminhamentoCentroMunicipalMulherDetalhe">
                            <label class="form-label visually-hidden" for="encaminhamentoCentroMunicipalMulherComplemento">Complemento Centro Municipal da Mulher</label>
                            <input type="text" class="form-control" id="encaminhamentoCentroMunicipalMulherComplemento" name="encaminhamentosComplemento[Centro Municipal da Mulher]" />
                          </div>
                        </div>
                        <div class="col">
                          <div class="form-check">
                            <input class="form-check-input encaminhamento-checkbox" type="checkbox" id="encaminhamentoCursosProfissionalizantes" name="encaminhamentosExternos[]" value="Cursos Profissionalizantes" data-complement-target="#encaminhamentoCursosProfissionalizantesDetalhe" />
                            <label class="form-check-label" for="encaminhamentoCursosProfissionalizantes">Cursos Profissionalizantes</label>
                          </div>
                          <div class="mt-2 d-none" id="encaminhamentoCursosProfissionalizantesDetalhe">
                            <label class="form-label visually-hidden" for="encaminhamentoCursosProfissionalizantesComplemento">Complemento Cursos Profissionalizantes</label>
                            <input type="text" class="form-control" id="encaminhamentoCursosProfissionalizantesComplemento" name="encaminhamentosComplemento[Cursos Profissionalizantes]" />
                          </div>
                        </div>
                        <div class="col">
                          <div class="form-check">
                            <input class="form-check-input encaminhamento-checkbox" type="checkbox" id="encaminhamentoEducacaoFormal" name="encaminhamentosExternos[]" value="Educa√ß√£o Formal" data-complement-target="#encaminhamentoEducacaoFormalDetalhe" />
                            <label class="form-check-label" for="encaminhamentoEducacaoFormal">Educa√ß√£o Formal</label>
                          </div>
                          <div class="mt-2 d-none" id="encaminhamentoEducacaoFormalDetalhe">
                            <label class="form-label visually-hidden" for="encaminhamentoEducacaoFormalComplemento">Complemento Educa√ß√£o Formal</label>
                            <input type="text" class="form-control" id="encaminhamentoEducacaoFormalComplemento" name="encaminhamentosComplemento[Educa√ß√£o Formal]" />
                          </div>
                        </div>
                        <div class="col">
                          <div class="form-check">
                            <input class="form-check-input encaminhamento-checkbox" type="checkbox" id="encaminhamentoEmpregoRenda" name="encaminhamentosExternos[]" value="Emprego e Renda" data-complement-target="#encaminhamentoEmpregoRendaDetalhe" />
                            <label class="form-check-label" for="encaminhamentoEmpregoRenda">Emprego e Renda</label>
                          </div>
                          <div class="mt-2 d-none" id="encaminhamentoEmpregoRendaDetalhe">
                            <label class="form-label visually-hidden" for="encaminhamentoEmpregoRendaComplemento">Complemento Emprego e Renda</label>
                            <input type="text" class="form-control" id="encaminhamentoEmpregoRendaComplemento" name="encaminhamentosComplemento[Emprego e Renda]" />
                          </div>
                        </div>
                        <div class="col">
                          <div class="form-check">
                            <input class="form-check-input encaminhamento-checkbox" type="checkbox" id="encaminhamentoSaudeFisicaMental" name="encaminhamentosExternos[]" value="Sa√∫de F√≠sica / Mental" data-complement-target="#encaminhamentoSaudeFisicaMentalDetalhe" />
                            <label class="form-check-label" for="encaminhamentoSaudeFisicaMental">Sa√∫de F√≠sica / Mental</label>
                          </div>
                          <div class="mt-2 d-none" id="encaminhamentoSaudeFisicaMentalDetalhe">
                            <label class="form-label visually-hidden" for="encaminhamentoSaudeFisicaMentalComplemento">Complemento Sa√∫de F√≠sica/Mental</label>
                            <input type="text" class="form-control" id="encaminhamentoSaudeFisicaMentalComplemento" name="encaminhamentosComplemento[Sa√∫de F√≠sica / Mental]" />
                          </div>
                        </div>
                        <div class="col">
                          <div class="form-check">
                            <input class="form-check-input encaminhamento-checkbox" type="checkbox" id="encaminhamentoDocumentacao" name="encaminhamentosExternos[]" value="Emiss√£o de Documenta√ß√£o B√°sica" data-complement-target="#encaminhamentoDocumentacaoDetalhe" />
                            <label class="form-check-label" for="encaminhamentoDocumentacao">Emiss√£o de Documenta√ß√£o B√°sica</label>
                          </div>
                          <div class="mt-2 d-none" id="encaminhamentoDocumentacaoDetalhe">
                            <label class="form-label visually-hidden" for="encaminhamentoDocumentacaoComplemento">Complemento Documenta√ß√£o B√°sica</label>
                            <input type="text" class="form-control" id="encaminhamentoDocumentacaoComplemento" name="encaminhamentosComplemento[Emiss√£o de Documenta√ß√£o B√°sica]" />
                          </div>
                        </div>
                        <div class="col">
                          <div class="form-check">
                            <input class="form-check-input encaminhamento-checkbox" type="checkbox" id="encaminhamentoCartorio" name="encaminhamentosExternos[]" value="Cart√≥rio Registro Civil ou Im√≥veis" data-complement-target="#encaminhamentoCartorioDetalhe" />
                            <label class="form-check-label" for="encaminhamentoCartorio">Cart√≥rio Registro Civil ou Im√≥veis</label>
                          </div>
                          <div class="mt-2 d-none" id="encaminhamentoCartorioDetalhe">
                            <label class="form-label visually-hidden" for="encaminhamentoCartorioComplemento">Complemento Cart√≥rio</label>
                            <input type="text" class="form-control" id="encaminhamentoCartorioComplemento" name="encaminhamentosComplemento[Cart√≥rio Registro Civil ou Im√≥veis]" />
                          </div>
                        </div>
                        <div class="col">
                          <div class="form-check">
                            <input class="form-check-input encaminhamento-checkbox" type="checkbox" id="encaminhamentoCnhPopular" name="encaminhamentosExternos[]" value="Emiss√£o de CNH Popular" data-complement-target="#encaminhamentoCnhPopularDetalhe" />
                            <label class="form-check-label" for="encaminhamentoCnhPopular">Emiss√£o de CNH Popular</label>
                          </div>
                          <div class="mt-2 d-none" id="encaminhamentoCnhPopularDetalhe">
                            <label class="form-label visually-hidden" for="encaminhamentoCnhPopularComplemento">Complemento CNH Popular</label>
                            <input type="text" class="form-control" id="encaminhamentoCnhPopularComplemento" name="encaminhamentosComplemento[Emiss√£o de CNH Popular]" />
                          </div>
                        </div>
                        <div class="col">
                          <div class="form-check">
                            <input class="form-check-input encaminhamento-checkbox" type="checkbox" id="encaminhamentoOutros" name="encaminhamentosExternos[]" value="Outros" data-complement-target="#encaminhamentoOutrosDetalhe" />
                            <label class="form-check-label" for="encaminhamentoOutros">Outros</label>
                          </div>
                          <div class="mt-2 d-none" id="encaminhamentoOutrosDetalhe">
                            <label class="form-label visually-hidden" for="encaminhamentoOutrosComplemento">Complemento Outros encaminhamentos</label>
                            <input type="text" class="form-control" id="encaminhamentoOutrosComplemento" name="encaminhamentosComplemento[Outros]" />
                          </div>
                        </div>
                      </div>
                      <div class="row g-3 mt-3">
                        <div class="col-12 col-md-4">
                          <label for="violenciaInstitucional" class="form-label">Viol√™ncia institucional?</label>
                          <select id="violenciaInstitucional" name="violenciaInstitucional" class="form-select">
                            <option value="">Selecione</option>
                            <option value="Nao">N√£o</option>
                            <option value="Sim">Sim</option>
                          </select>
                        </div>
                        <div class="col-12 col-md-4 d-none" id="instituicaoViolenciaGroup">
                          <label for="instituicaoViolencia" class="form-label">Qual institui√ß√£o?</label>
                          <select id="instituicaoViolencia" name="instituicaoViolencia" class="form-select">
                            <option value="">Selecione</option>
                            <option value="Delegacia">Delegacia</option>
                            <option value="Saude">Servi√ßo de sa√∫de</option>
                            <option value="Judiciario">Poder Judici√°rio</option>
                            <option value="Assistencia">Rede de assist√™ncia social</option>
                            <option value="Outros">Outros</option>
                          </select>
                        </div>
                        <div class="col-12 col-md-4 d-none" id="instituicaoViolenciaOutraGroup">
                          <label for="instituicaoViolenciaOutra" class="form-label">Outra</label>
                          <input type="text" class="form-control" id="instituicaoViolenciaOutra" name="instituicaoViolenciaOutra" />
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </section>

              <section class="card-section mb-4" aria-labelledby="repositorio-arquivos">
                <h2 class="form-section-title" id="repositorio-arquivos"><i class="bi bi-paperclip"></i>Reposit√≥rio de arquivos</h2>
                <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
                  <p class="text-muted mb-0">Anexe documentos relevantes ao prontu√°rio para consulta posterior.</p>
                  <button
                    type="button"
                    class="btn btn-primary btn-sm"
                    data-bs-toggle="modal"
                    data-bs-target="#anexoModal"
                    data-modal-child-trigger="true"
                  >
                    <i class="bi bi-upload me-2"></i>Adicionar anexo
                  </button>
                </div>
                <div class="table-responsive border rounded shadow-sm">
                  <table class="table table-hover mb-0 align-middle">
                    <thead class="table-light">
                      <tr>
                        <th scope="col">Data</th>
                        <th scope="col">Descri√ß√£o</th>
                        <th scope="col">Arquivo</th>
                        <th scope="col" class="text-center">A√ß√µes</th>
                      </tr>
                    </thead>
                    <tbody id="anexoTabelaBody">
                      <tr id="anexoVazio">
                        <td colspan="4" class="text-center text-muted py-4">Nenhum arquivo anexado.</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                <div id="anexoHiddenInputs"></div>
              </section>

                  </form>
                </section>
          </div>
          <div class="sticky-modal-footer justify-content-end gap-2 d-flex flex-wrap" id="registroModalFooter">
            <button type="button" class="btn btn-success" id="registroModalSalvarBtn">
              <i class="bi bi-save me-1"></i>Salvar
            </button>
            <button type="button" class="btn btn-danger" id="registroModalCancelarBtn">
              <i class="bi bi-arrow-counterclockwise me-1"></i>Cancelar
            </button>
            <button type="button" class="btn btn-light" id="registroModalFecharBtn">
              <i class="bi bi-x-lg me-1"></i>Fechar
            </button>
          </div>
        </section>

      </main>

    <div class="modal fade" id="unsavedChangesModal" tabindex="-1" aria-labelledby="unsavedChangesModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header border-0 pb-0">
            <h2 class="modal-title fs-5 text-danger fw-bold d-flex align-items-center gap-2" id="unsavedChangesModalLabel">
              <span aria-hidden="true">‚ö†Ô∏è</span>
              <span>Alerta</span>
            </h2>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar" data-confirm-result="false"></button>
          </div>
          <div class="modal-body pt-2">
            <p class="mb-0" data-unsaved-message>As altera√ß√µes ser√£o perdidas. Deseja continuar?</p>
          </div>
          <div class="modal-footer border-0 justify-content-end gap-2">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-confirm-result="false">N√£o</button>
            <button type="button" class="btn btn-danger" data-bs-dismiss="modal" data-confirm-result="true">Sim</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="autorModal" tabindex="-1" aria-labelledby="autorModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="modal-title fs-5" id="autorModalLabel">Adicionar autor(a)</h2>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <form id="autorModalForm">
            <div class="modal-body">
              <h3 class="h6 text-uppercase text-primary fw-semibold mb-3">Identifica√ß√£o</h3>
              <div class="row g-3">
                <div class="col-12 col-md-4">
                  <label for="autorCpf" class="form-label required">CPF</label>
                  <input type="text" class="form-control" id="autorCpf" name="autorCpf" required />
                </div>
                <div class="col-12 col-md-8">
                  <label for="autorNome" class="form-label required">Nome completo</label>
                  <input type="text" class="form-control" id="autorNome" name="autorNome" required />
                </div>
                <div class="col-12 col-md-6">
                  <label for="autorNomeSocial" class="form-label">Nome social</label>
                  <input type="text" class="form-control" id="autorNomeSocial" name="autorNomeSocial" />
                </div>
                <div class="col-12 col-md-6">
                  <label for="autorParentesco" class="form-label required">Grau de parentesco</label>
                  <select id="autorParentesco" name="autorParentesco" class="form-select" required>
                    <option value="">Selecione</option>
                    <option>C√¥njuge/companheiro(a)</option>
                    <option>Ex-companheiro(a)</option>
                    <option>Pai/M√£e</option>
                    <option>Outro familiar</option>
                    <option>Conhecido(a)</option>
                    <option>Outro</option>
                  </select>
                </div>
                <div class="col-12 col-md-4">
                  <label for="autorRg" class="form-label">RG</label>
                  <input type="text" class="form-control" id="autorRg" name="autorRg" />
                </div>
                <div class="col-12 col-md-4 d-none autor-rg-group">
                  <label for="autorOrgaoExpedicao" class="form-label">√ìrg√£o de expedi√ß√£o</label>
                  <input type="text" class="form-control" id="autorOrgaoExpedicao" name="autorOrgaoExpedicao" />
                </div>
                <div class="col-6 col-md-2 d-none autor-rg-group">
                  <label for="autorUfExpedicao" class="form-label">UF</label>
                  <select id="autorUfExpedicao" name="autorUfExpedicao" class="form-select" data-choices="true">
                    <option value="">Selecione</option>
                  </select>
                </div>
                <div class="col-6 col-md-2 d-none autor-rg-group">
                  <label for="autorDataExpedicao" class="form-label">Data de expedi√ß√£o</label>
                  <input type="date" class="form-control" id="autorDataExpedicao" name="autorDataExpedicao" />
                </div>
                <div class="col-12 col-md-4">
                  <label for="autorEstadoCivil" class="form-label required">Estado civil</label>
                  <select id="autorEstadoCivil" name="autorEstadoCivil" class="form-select" required>
                    <option value="">Selecione</option>
                    <option>Solteiro(a)</option>
                    <option>Casado(a)</option>
                    <option>Uni√£o est√°vel</option>
                    <option>Separado(a)</option>
                    <option>Divorciado(a)</option>
                    <option>Vi√∫vo(a)</option>
                    <option>Prefere n√£o informar</option>
                  </select>
                </div>
                <div class="col-12 col-md-8 d-none" id="autorConjugeGroup">
                  <label for="autorConjuge" class="form-label required">Nome do(a) c√¥njuge/companheiro(a)</label>
                  <input type="text" class="form-control" id="autorConjuge" name="autorConjuge" />
                </div>
                <div class="col-12 col-md-4">
                  <label for="autorOrientacaoSexual" class="form-label">Orienta√ß√£o sexual</label>
                  <select id="autorOrientacaoSexual" name="autorOrientacaoSexual" class="form-select">
                    <option value="">Selecione</option>
                    <option>Heterossexual</option>
                    <option>L√©sbica</option>
                    <option>Bissexual</option>
                    <option>Assexual</option>
                    <option>Outra</option>
                    <option>Prefere n√£o informar</option>
                  </select>
                </div>
                <div class="col-12 col-md-4">
                  <label for="autorCorRaca" class="form-label required">Cor/ra√ßa</label>
                  <select id="autorCorRaca" name="autorCorRaca" class="form-select" required>
                    <option value="">Selecione</option>
                    <option>Branca</option>
                    <option>Preta</option>
                    <option>Parda</option>
                    <option>Amarela</option>
                    <option>Ind√≠gena</option>
                    <option>Prefere n√£o informar</option>
                  </select>
                </div>
                <div class="col-12 col-md-4">
                  <label for="autorReligiao" class="form-label required">Religi√£o/credo</label>
                  <select id="autorReligiao" name="autorReligiao" class="form-select" required>
                    <option value="">Selecione</option>
                    <option>Cat√≥lica</option>
                    <option>Evang√©lica</option>
                    <option>Esp√≠rita</option>
                    <option>Religi√µes de matriz africana</option>
                    <option>Sem religi√£o</option>
                    <option>Outra</option>
                  </select>
                </div>
                <div class="col-12 col-md-4">
                  <label for="autorGenero" class="form-label required">G√™nero</label>
                  <select id="autorGenero" name="autorGenero" class="form-select" required>
                    <option value="">Selecione</option>
                    <option>Mulher</option>
                    <option>Homem</option>
                    <option>Outro</option>
                    <option>Prefiro n√£o informar</option>
                  </select>
                </div>
                <div class="col-12 col-md-4 d-none" id="autorIdentidadeGeneroGroup">
                  <label for="autorIdentidadeGenero" class="form-label required">Identidade de g√™nero</label>
                  <select id="autorIdentidadeGenero" name="autorIdentidadeGenero" class="form-select">
                    <option value="">Selecione</option>
                    <option>Mulher trans</option>
                    <option>Homem trans</option>
                    <option>Travesti</option>
                    <option>N√£o-bin√°ria</option>
                    <option>Outra</option>
                    <option>Prefere n√£o informar</option>
                  </select>
                </div>
                <div class="col-12 col-md-4">
                  <label for="autorConfiguracaoFamiliar" class="form-label required">Configura√ß√£o familiar</label>
                  <select id="autorConfiguracaoFamiliar" name="autorConfiguracaoFamiliar" class="form-select" required>
                    <option value="">Selecione</option>
                    <option>Nuclear</option>
                    <option>Monoparental</option>
                    <option>Extensa</option>
                    <option>Reconstitu√≠da</option>
                    <option>Outra</option>
                  </select>
                </div>
                <div class="col-12 col-md-4">
                  <label for="autorNacionalidade" class="form-label required">Nacionalidade</label>
                  <select id="autorNacionalidade" name="autorNacionalidade" class="form-select" required>
                    <option value="">Selecione</option>
                    <option>Brasileiro(a)</option>
                    <option>Naturalizado(a)</option>
                    <option>Estrangeiro(a)</option>
                  </select>
                </div>
                <div class="col-12 col-md-4 d-none" id="autorUfNascimentoGroup">
                  <label for="autorUfNascimento" class="form-label required">UF de nascimento</label>
                  <select id="autorUfNascimento" name="autorUfNascimento" class="form-select" data-choices="true">
                    <option value="">Selecione</option>
                  </select>
                </div>
                <div class="col-12 col-md-4 d-none" id="autorCidadeNascimentoGroup">
                  <label for="autorCidadeNascimento" class="form-label required">Naturalidade (cidade)</label>
                  <select id="autorCidadeNascimento" name="autorCidadeNascimento" class="form-select" data-choices="true">
                    <option value="">Selecione</option>
                  </select>
                </div>
                <div class="col-12 col-md-6">
                  <label for="autorNomeMae" class="form-label">Nome da m√£e</label>
                  <input type="text" class="form-control" id="autorNomeMae" name="autorNomeMae" />
                </div>
                <div class="col-12 col-md-6">
                  <label for="autorNomePai" class="form-label">Nome do pai</label>
                  <input type="text" class="form-control" id="autorNomePai" name="autorNomePai" />
                </div>
              </div>

              <hr class="my-4" />
              <h3 class="h6 text-uppercase text-primary fw-semibold mb-3">Endere√ßo e contatos</h3>
              <div class="form-check form-switch mb-2">
                <input class="form-check-input" type="checkbox" id="autorEnderecoIgual" name="autorEnderecoIgual" value="Sim" />
                <label class="form-check-label" for="autorEnderecoIgual">Mesmo endere√ßo da v√≠tima</label>
              </div>
              <div class="row g-3" id="autorEnderecoCampos">
                <div class="col-12 col-md-4">
                  <label for="autorCep" class="form-label">CEP</label>
                  <div class="d-flex gap-2">
                    <input type="text" class="form-control" id="autorCep" name="autorCep" />
                    <div class="form-check mt-2">
                      <input class="form-check-input" type="checkbox" id="autorSemCep" name="autorSemCep" />
                      <label class="form-check-label" for="autorSemCep">N√£o sei</label>
                    </div>
                  </div>
                  <div class="form-text" id="autorCepHelp"></div>
                </div>
                <div class="col-12 col-md-5">
                  <label for="autorLogradouro" class="form-label">Logradouro</label>
                  <input type="text" class="form-control" id="autorLogradouro" name="autorLogradouro" />
                </div>
                <div class="col-6 col-md-3">
                  <label for="autorNumero" class="form-label">N√∫mero</label>
                  <input type="text" class="form-control" id="autorNumero" name="autorNumero" />
                </div>
                <div class="col-6 col-md-4">
                  <label for="autorComplemento" class="form-label">Comp</label>
                  <input type="text" class="form-control" id="autorComplemento" name="autorComplemento" />
                </div>
                <div class="col-12 col-md-4">
                  <label for="autorBairro" class="form-label">Bairro</label>
                  <input type="text" class="form-control" id="autorBairro" name="autorBairro" />
                </div>
                <div class="col-12 col-md-3">
                  <label for="autorCidade" class="form-label">Cidade</label>
                  <input type="text" class="form-control" id="autorCidade" name="autorCidade" />
                </div>
                <div class="col-6 col-md-2">
                  <label for="autorUf" class="form-label">UF</label>
                  <select id="autorUf" name="autorUf" class="form-select" data-choices="true">
                    <option value="">Selecione</option>
                  </select>
                </div>
                <div class="col-6 col-md-3">
                  <label for="autorPontoReferencia" class="form-label">Ponto de refer√™ncia</label>
                  <input type="text" class="form-control" id="autorPontoReferencia" name="autorPontoReferencia" />
                </div>
              </div>
              <div class="row g-3 mt-1">
                <div class="col-12 col-md-4">
                  <label for="autorTelefoneFixo" class="form-label">Telefone fixo</label>
                  <input type="text" class="form-control" id="autorTelefoneFixo" name="autorTelefoneFixo" />
                </div>
                <div class="col-12 col-md-4">
                  <label for="autorTelefoneCelular" class="form-label">Telefone celular</label>
                  <input type="text" class="form-control" id="autorTelefoneCelular" name="autorTelefoneCelular" />
                </div>
                <div class="col-12 col-md-4">
                  <label for="autorEmail" class="form-label">E-mail</label>
                  <input type="email" class="form-control" id="autorEmail" name="autorEmail" />
                </div>
                <div class="col-12 col-md-4">
                  <label for="autorDataNascimento" class="form-label required">Data de nascimento</label>
                  <input type="date" class="form-control" id="autorDataNascimento" name="autorDataNascimento" required />
                </div>
                <div class="col-12 col-md-2">
                  <label for="autorIdade" class="form-label">Idade</label>
                  <input type="text" class="form-control" id="autorIdade" name="autorIdade" readonly />
                </div>
              </div>

              <hr class="my-4" />
              <h3 class="h6 text-uppercase text-primary fw-semibold mb-3">Escolaridade</h3>
              <div class="row g-3">
                <div class="col-12">
                  <label for="autorGrauEscolar" class="form-label required">Escolaridade</label>
                  <select id="autorGrauEscolar" name="autorGrauEscolar" class="form-select" required>
                    <option value="">Selecione</option>
                    <option>Sem instru√ß√£o</option>
                    <option>Ensino fundamental</option>
                    <option>Ensino m√©dio</option>
                    <option>Curso t√©cnico</option>
                    <option>Tecn√≥logo</option>
                    <option>Ensino superior</option>
                    <option>P√≥s-gradua√ß√£o</option>
                    <option>Mestrado</option>
                    <option>Doutorado</option>
                  </select>
                </div>
                <div class="col-12 col-md-6 d-none" id="autorSituacaoEscolarGroup">
                  <label for="autorSituacaoEscolar" class="form-label">Situa√ß√£o escolar</label>
                  <select id="autorSituacaoEscolar" name="autorSituacaoEscolar" class="form-select">
                    <option value="">Selecione</option>
                    <option>Conclu√≠do</option>
                    <option>Em andamento</option>
                    <option>Interrompido</option>
                  </select>
                </div>
                <div class="col-12 col-md-6 d-none" id="autorCursoFormacaoGroup">
                  <label for="autorCursoFormacao" class="form-label">Curso</label>
                  <input type="text" class="form-control" id="autorCursoFormacao" name="autorCursoFormacao" />
                </div>
                <div class="col-12 col-md-6 d-none" id="autorTipoPosGraduacaoGroup">
                  <label for="autorTipoPosGraduacao" class="form-label">Tipo de p√≥s-gradua√ß√£o</label>
                  <select id="autorTipoPosGraduacao" name="autorTipoPosGraduacao" class="form-select">
                    <option value="">Selecione</option>
                    <option>Especializa√ß√£o</option>
                    <option>Mestrado</option>
                    <option>Doutorado</option>
                    <option>Outra</option>
                  </select>
                </div>
                <div class="col-12 col-md-6 d-none" id="autorAnoPeriodoGroup">
                  <label for="autorAnoPeriodo" class="form-label">Ano/per√≠odo</label>
                  <input type="text" class="form-control" id="autorAnoPeriodo" name="autorAnoPeriodo" />
                </div>
              </div>

              <hr class="my-4" />
              <h3 class="h6 text-uppercase text-primary fw-semibold mb-3">Dados profissionais</h3>
              <div class="row g-3">
                <div class="col-12 col-md-6">
                  <label for="autorLocalTrabalho" class="form-label">Local de trabalho</label>
                  <input type="text" class="form-control" id="autorLocalTrabalho" name="autorLocalTrabalho" />
                </div>
                <div class="col-12 col-md-6">
                  <label for="autorEnderecoTrabalho" class="form-label">Endere√ßo do trabalho</label>
                  <input type="text" class="form-control" id="autorEnderecoTrabalho" name="autorEnderecoTrabalho" />
                </div>
                <div class="col-12 col-md-4">
                  <label for="autorTelefoneTrabalho" class="form-label">Telefone</label>
                  <input type="text" class="form-control" id="autorTelefoneTrabalho" name="autorTelefoneTrabalho" />
                </div>
                <div class="col-12 col-md-4">
                  <label for="autorReferenciaTrabalho" class="form-label">Ponto de refer√™ncia</label>
                  <input type="text" class="form-control" id="autorReferenciaTrabalho" name="autorReferenciaTrabalho" />
                </div>
                <div class="col-12 col-md-4">
                  <label for="autorSituacaoOcupacao" class="form-label required">Situa√ß√£o de ocupa√ß√£o</label>
                  <select id="autorSituacaoOcupacao" name="autorSituacaoOcupacao" class="form-select" required>
                    <option value="">Selecione</option>
                    <option>Empregado(a) com carteira</option>
                    <option>Empregado(a) sem carteira</option>
                    <option>Servidor(a) p√∫blico(a)</option>
                    <option>Aut√¥nomo(a)</option>
                    <option>Desempregado(a)</option>
                    <option>Estudante</option>
                    <option>Aposentado(a)</option>
                    <option>Do lar</option>
                    <option>Outra</option>
                  </select>
                </div>
                <div class="col-12 col-md-6 d-none" id="autorOcupacaoGroup">
                  <label for="autorOcupacao" class="form-label required">Ocupa√ß√£o / Profiss√£o</label>
                  <input type="text" class="form-control" id="autorOcupacao" name="autorOcupacao" />
                </div>
                <div class="col-12 col-md-6">
                  <span class="form-label d-block">Profissional de seguran√ßa p√∫blica?</span>
                  <div class="d-flex gap-3">
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="autorSegurancaPublica" id="autorSegurancaPublicaSim" value="Sim" />
                      <label class="form-check-label" for="autorSegurancaPublicaSim">Sim</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="autorSegurancaPublica" id="autorSegurancaPublicaNao" value="N√£o" checked />
                      <label class="form-check-label" for="autorSegurancaPublicaNao">N√£o</label>
                    </div>
                  </div>
                </div>
                <div class="col-12 col-md-6 d-none" id="autorSegurancaDetalhes">
                  <label for="autorSegurancaQual" class="form-label required">Qual?</label>
                  <input type="text" class="form-control mb-2" id="autorSegurancaQual" name="autorSegurancaQual" />
                  <label for="autorForcaInstitucional" class="form-label required">For√ßa institucional</label>
                  <input type="text" class="form-control" id="autorForcaInstitucional" name="autorForcaInstitucional" />
                </div>
                <div class="col-12 col-md-6">
                  <label for="autorRendaIndividual" class="form-label required">Renda individual</label>
                  <select id="autorRendaIndividual" name="autorRendaIndividual" class="form-select" required>
                    <option value="">Selecione</option>
                    <option>At√© 1 sal√°rio m√≠nimo</option>
                    <option>1 a 2 sal√°rios m√≠nimos</option>
                    <option>2 a 3 sal√°rios m√≠nimos</option>
                    <option>3 a 5 sal√°rios m√≠nimos</option>
                    <option>Acima de 5 sal√°rios m√≠nimos</option>
                    <option>Sem renda</option>
                  </select>
                </div>
              </div>

              <hr class="my-4" />
              <h3 class="h6 text-uppercase text-primary fw-semibold mb-3">Sa√∫de f√≠sica</h3>
              <div class="row g-3">
                <div class="col-12 col-lg-6">
                  <span class="form-label d-block">Faz uso de drogas l√≠citas?</span>
                  <div class="d-flex flex-wrap gap-3" id="autorDrogasLicitasGroup">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="autorDrogaLicitaTabaco" name="autorDrogasLicitas[]" value="Tabaco" />
                      <label class="form-check-label" for="autorDrogaLicitaTabaco">Tabaco</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="autorDrogaLicitaAlcool" name="autorDrogasLicitas[]" value="√Ålcool" />
                      <label class="form-check-label" for="autorDrogaLicitaAlcool">√Ålcool</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="autorDrogaLicitaMedicamento" name="autorDrogasLicitas[]" value="Medicamento" />
                      <label class="form-check-label" for="autorDrogaLicitaMedicamento">Medicamento</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="autorDrogaLicitaOutra" name="autorDrogasLicitas[]" value="Outra" />
                      <label class="form-check-label" for="autorDrogaLicitaOutra">Outra</label>
                    </div>
                  </div>
                  <div class="mt-2 d-none" id="autorDrogasLicitasOutraGroup">
                    <label for="autorDrogasLicitasOutra" class="form-label required">Qual?</label>
                    <input type="text" class="form-control" id="autorDrogasLicitasOutra" name="autorDrogasLicitasOutra" />
                  </div>
                </div>
                <div class="col-12 col-lg-6">
                  <span class="form-label d-block">Faz uso de drogas il√≠citas?</span>
                  <div class="d-flex flex-wrap gap-3" id="autorDrogasIlicitasGroup">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="autorDrogaIlicitaMaconha" name="autorDrogasIlicitas[]" value="Maconha" />
                      <label class="form-check-label" for="autorDrogaIlicitaMaconha">Maconha</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="autorDrogaIlicitaCocaina" name="autorDrogasIlicitas[]" value="Coca√≠na" />
                      <label class="form-check-label" for="autorDrogaIlicitaCocaina">Coca√≠na</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="autorDrogaIlicitaCrack" name="autorDrogasIlicitas[]" value="Crack" />
                      <label class="form-check-label" for="autorDrogaIlicitaCrack">Crack</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="autorDrogaIlicitaOutra" name="autorDrogasIlicitas[]" value="Outra" />
                      <label class="form-check-label" for="autorDrogaIlicitaOutra">Outra</label>
                    </div>
                  </div>
                  <div class="mt-2 d-none" id="autorDrogasIlicitasOutraGroup">
                    <label for="autorDrogasIlicitasOutra" class="form-label required">Qual?</label>
                    <input type="text" class="form-control" id="autorDrogasIlicitasOutra" name="autorDrogasIlicitasOutra" />
                  </div>
                </div>
              </div>

              <hr class="my-4" />
              <h3 class="h6 text-uppercase text-primary fw-semibold mb-3">Aspecto criminal</h3>
              <div class="row g-3">
                <div class="col-12 col-md-6">
                  <span class="form-label d-block">Possui arma?</span>
                  <div class="d-flex gap-3">
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="autorPossuiArma" id="autorPossuiArmaSim" value="Sim" />
                      <label class="form-check-label" for="autorPossuiArmaSim">Sim</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="autorPossuiArma" id="autorPossuiArmaNao" value="N√£o" checked />
                      <label class="form-check-label" for="autorPossuiArmaNao">N√£o</label>
                    </div>
                  </div>
                  <div class="mt-2 d-none" id="autorTipoArmaGroup">
                    <label for="autorTipoArma" class="form-label required">Tipo de arma</label>
                    <input type="text" class="form-control" id="autorTipoArma" name="autorTipoArma" />
                  </div>
                </div>
                <div class="col-12 col-md-6">
                  <span class="form-label d-block">Envolvimento com criminalidade?</span>
                  <div class="d-flex gap-3">
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="autorCriminalidade" id="autorCriminalidadeSim" value="Sim" />
                      <label class="form-check-label" for="autorCriminalidadeSim">Sim</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="autorCriminalidade" id="autorCriminalidadeNao" value="N√£o" checked />
                      <label class="form-check-label" for="autorCriminalidadeNao">N√£o</label>
                    </div>
                  </div>
                  <div class="mt-2 d-none" id="autorCriminalidadeQualGroup">
                    <label for="autorCriminalidadeQual" class="form-label required">Qual?</label>
                    <input type="text" class="form-control" id="autorCriminalidadeQual" name="autorCriminalidadeQual" />
                  </div>
                </div>
                <div class="col-12 col-md-6">
                  <span class="form-label d-block">Possui passagem pela pol√≠cia?</span>
                  <div class="d-flex gap-3">
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="autorPassagemPolicia" id="autorPassagemPoliciaSim" value="Sim" />
                      <label class="form-check-label" for="autorPassagemPoliciaSim">Sim</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="autorPassagemPolicia" id="autorPassagemPoliciaNao" value="N√£o" checked />
                      <label class="form-check-label" for="autorPassagemPoliciaNao">N√£o</label>
                    </div>
                  </div>
                  <div class="row g-2 mt-2 d-none" id="autorPassagemDetalhes">
                    <div class="col-12 col-md-6">
                      <label for="autorPassagemRegime" class="form-label required">Tipo de regime</label>
                      <input type="text" class="form-control" id="autorPassagemRegime" name="autorPassagemRegime" />
                    </div>
                    <div class="col-12 col-md-6">
                      <label for="autorPassagemDelito" class="form-label required">Qual delito?</label>
                      <input type="text" class="form-control" id="autorPassagemDelito" name="autorPassagemDelito" />
                    </div>
                  </div>
                </div>
                <div class="col-12 col-md-6">
                  <span class="form-label d-block">Viol√™ncia contra outrem/familiares/crian√ßas</span>
                  <div class="d-flex gap-3">
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="autorViolenciaOutrem" id="autorViolenciaOutremSim" value="Sim" />
                      <label class="form-check-label" for="autorViolenciaOutremSim">Sim</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="autorViolenciaOutrem" id="autorViolenciaOutremNao" value="N√£o" checked />
                      <label class="form-check-label" for="autorViolenciaOutremNao">N√£o</label>
                    </div>
                  </div>
                </div>
                <div class="col-12">
                  <span class="form-label d-block">Medidas protetivas</span>
                  <div class="d-flex flex-wrap gap-3" role="radiogroup">
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="autorMedidasProtetivas" id="autorMedidaMulher" value="Mulher" />
                      <label class="form-check-label" for="autorMedidaMulher">Mulher</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="autorMedidasProtetivas" id="autorMedidaFilhos" value="Filhos" />
                      <label class="form-check-label" for="autorMedidaFilhos">Filhos</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="autorMedidasProtetivas" id="autorMedidaOutros" value="Outros membros" />
                      <label class="form-check-label" for="autorMedidaOutros">Outros membros</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="autorMedidasProtetivas" id="autorMedidaNenhuma" value="Nenhuma" checked />
                      <label class="form-check-label" for="autorMedidaNenhuma">Nenhuma</label>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer sticky-actions">
              <button type="submit" class="btn btn-success">Salvar</button>
              <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cancelar</button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="modal fade" id="familiaModal" tabindex="-1" aria-labelledby="familiaModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="modal-title fs-5" id="familiaModalLabel">Adicionar membro da fam√≠lia</h2>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <form id="familiaModalForm">
            <div class="modal-body">
              <div class="row g-3">
                <div class="col-12">
                  <label for="familiaNome" class="form-label required">Nome completo</label>
                  <input type="text" class="form-control" id="familiaNome" name="familiaNome" required />
                </div>
                <div class="col-12 col-md-4">
                  <label for="familiaDataNascimento" class="form-label required">Data de nascimento</label>
                  <input type="date" class="form-control" id="familiaDataNascimento" name="familiaDataNascimento" required />
                </div>
                <div class="col-12 col-md-4">
                  <label for="familiaIdadeAnos" class="form-label required">Idade (anos)</label>
                  <input type="text" class="form-control" id="familiaIdadeAnos" name="familiaIdadeAnos" readonly required />
                  <input type="hidden" id="familiaIdadeMeses" name="familiaIdadeMeses" />
                </div>
                <div class="col-12 col-md-4">
                  <label for="familiaParentesco" class="form-label required">Parentesco</label>
                  <select id="familiaParentesco" name="familiaParentesco" class="form-select" required>
                    <option value="">Selecione</option>
                    <option>C√¥njuge/companheiro(a)</option>
                    <option>Filho(a)</option>
                    <option>Pai</option>
                    <option>M√£e</option>
                    <option>Irm√£o(√£)</option>
                    <option>Av√¥/Av√≥</option>
                    <option>Outro</option>
                  </select>
                </div>
                <div class="col-12 col-md-4">
                  <label for="familiaEscolaridade" class="form-label required">Escolaridade</label>
                  <select id="familiaEscolaridade" name="familiaEscolaridade" class="form-select" required>
                    <option value="">Selecione</option>
                    <option>Educa√ß√£o infantil</option>
                    <option>Ensino fundamental</option>
                    <option>Ensino m√©dio</option>
                    <option>Ensino t√©cnico</option>
                    <option>Ensino superior</option>
                    <option>P√≥s-gradua√ß√£o</option>
                  </select>
                </div>
                <div class="col-12 col-md-4">
                  <label for="familiaRedeEnsino" class="form-label required">Rede de ensino</label>
                  <select id="familiaRedeEnsino" name="familiaRedeEnsino" class="form-select" required>
                    <option value="">Selecione</option>
                    <option>P√∫blica</option>
                    <option>Privada</option>
                    <option>N√£o frequenta</option>
                  </select>
                </div>
                <div class="col-12 col-md-4">
                  <label for="familiaDeficienciaMotora" class="form-label required">Defici√™ncia motora</label>
                  <select id="familiaDeficienciaMotora" name="familiaDeficienciaMotora" class="form-select" required>
                    <option value="">Selecione</option>
                    <option>Sim</option>
                    <option>N√£o</option>
                  </select>
                </div>
                <div class="col-12 col-md-4">
                  <label for="familiaDeficienciaAuditiva" class="form-label required">Defici√™ncia auditiva</label>
                  <select id="familiaDeficienciaAuditiva" name="familiaDeficienciaAuditiva" class="form-select" required>
                    <option value="">Selecione</option>
                    <option>Sim</option>
                    <option>N√£o</option>
                  </select>
                </div>
                <div class="col-12 col-md-4">
                  <label for="familiaDeficienciaVisual" class="form-label required">Defici√™ncia visual</label>
                  <select id="familiaDeficienciaVisual" name="familiaDeficienciaVisual" class="form-select" required>
                    <option value="">Selecione</option>
                    <option>Sim</option>
                    <option>N√£o</option>
                  </select>
                </div>
                <div class="col-12 col-md-4">
                  <label for="familiaDeficienciaMental" class="form-label required">Defici√™ncia mental</label>
                  <select id="familiaDeficienciaMental" name="familiaDeficienciaMental" class="form-select" required>
                    <option value="">Selecione</option>
                    <option>Sim</option>
                    <option>N√£o</option>
                  </select>
                </div>
                <div class="col-12 col-md-4">
                  <label for="familiaBeneficiarioPrograma" class="form-label required">Benefici√°rio de programa social</label>
                  <select id="familiaBeneficiarioPrograma" name="familiaBeneficiarioPrograma" class="form-select" required>
                    <option value="">Selecione</option>
                    <option>Sim</option>
                    <option>N√£o</option>
                  </select>
                </div>
                <div class="col-12 col-md-4">
                  <label for="familiaBeneficiarioBpc" class="form-label required">Benefici√°rio BPC</label>
                  <select id="familiaBeneficiarioBpc" name="familiaBeneficiarioBpc" class="form-select" required>
                    <option value="">Selecione</option>
                    <option>Sim</option>
                    <option>N√£o</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="modal-footer sticky-actions">
              <button type="submit" class="btn btn-success">Salvar</button>
              <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cancelar</button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="modal fade" id="evolucaoModal" tabindex="-1" aria-labelledby="evolucaoModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="modal-title fs-5" id="evolucaoModalLabel">Adicionar evolu√ß√£o</h2>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <form id="evolucaoModalForm">
            <div class="modal-body">
              <div class="row g-3">
                <div class="col-12 col-md-4">
                  <label for="evolucaoData" class="form-label required">Data</label>
                  <input type="date" class="form-control" id="evolucaoData" name="evolucaoData" required readonly />
                </div>
                <div class="col-12">
                  <label for="evolucaoDescricao" class="form-label required">Evolu√ß√£o</label>
                  <textarea class="form-control" id="evolucaoDescricao" name="evolucaoDescricao" required></textarea>
                </div>
              </div>
            </div>
            <div class="modal-footer sticky-actions">
              <button type="submit" class="btn btn-success">Salvar</button>
              <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cancelar</button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="modal fade" id="anexoModal" tabindex="-1" aria-labelledby="anexoModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="modal-title fs-5" id="anexoModalLabel">Adicionar anexo</h2>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <form id="anexoModalForm">
            <div class="modal-body">
              <div class="alert d-none mb-3" id="anexoModalFeedback" role="alert"></div>
              <div class="row g-3">
                <div class="col-12 col-md-4">
                  <label for="anexoData" class="form-label required">Data</label>
                  <input type="date" class="form-control" id="anexoData" name="anexoData" required readonly />
                </div>
                <div class="col-12">
                  <label for="anexoDescricao" class="form-label required">Descri√ß√£o</label>
                  <input type="text" class="form-control" id="anexoDescricao" name="anexoDescricao" required />
                </div>
                <div class="col-12">
                  <label for="anexoArquivo" class="form-label required">Arquivo</label>
                  <input type="file" class="form-control" id="anexoArquivo" name="anexoArquivo" required />
                </div>
              </div>
            </div>
            <div class="modal-footer sticky-actions">
              <button type="submit" class="btn btn-success">Salvar</button>
              <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cancelar</button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="modal fade" id="visualizarAnexoModal" tabindex="-1" aria-labelledby="visualizarAnexoLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="modal-title fs-5" id="visualizarAnexoLabel">Visualizar anexo</h2>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body">
            <p id="visualizarAnexoDescricao" class="fw-semibold mb-3"></p>
            <div class="border rounded overflow-hidden bg-light-subtle">
              <iframe
                id="visualizarAnexoFrame"
                title="Pr√©-visualiza√ß√£o do anexo"
                class="w-100 border-0 d-none"
                style="min-height: 60vh"
                loading="lazy"
              ></iframe>
              <div id="visualizarAnexoSemPreview" class="p-4 text-center text-muted">
                Pr√©-visualiza√ß√£o n√£o dispon√≠vel para este arquivo. Utilize o download para acessar o conte√∫do.
              </div>
            </div>
          </div>
          <div class="modal-footer sticky-actions">
            <a
              id="downloadAnexoBtn"
              class="btn btn-success disabled"
              href="#"
              target="_blank"
              rel="noopener"
              aria-disabled="true"
            >
              Download
            </a>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
          </div>
        </div>
      </div>
    </div>

    <footer class="border-top bg-white">
      <div class="container">
        <div class="row g-3 align-items-center">
          <div class="col-12 col-lg-8">
            <p class="mb-0">Secretaria da Mulher ‚Äî Centro de Refer√™ncia Clarice Lispector. Rede de Enfrentamento √† Viol√™ncia Contra a Mulher do Recife.</p>
          </div>
          <div class="col-12 col-lg-4 text-lg-end">
            <p class="mb-0">Contato: redeclarice@recife.pe.gov.br ‚Ä¢ (81) 0000-0000</p>
          </div>
        </div>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.1/dist/jspdf.plugin.autotable.min.js"></script>
    <script>
      (function () {
        const modalStackManager = (() => {
          const stack = [];
          const baseModalZ = 1050;
          const baseBackdropZ = 1040;
          const zStep = 30;
          const focusableSelectors = [
            'button:not([disabled]):not([tabindex="-1"])',
            'a[href]:not([tabindex="-1"])',
            'input:not([type="hidden"]):not([disabled]):not([tabindex="-1"])',
            'select:not([disabled]):not([tabindex="-1"])',
            'textarea:not([disabled]):not([tabindex="-1"])',
            '[tabindex]:not([tabindex="-1"]):not([disabled])'
          ].join(', ');

          const isElement = (value) =>
            value instanceof Element ||
            (typeof HTMLDocument !== 'undefined' && value instanceof HTMLDocument);

          const findEntryIndex = (modalEl) => stack.findIndex((entry) => entry.el === modalEl);

          const focusEntry = (entry) => {
            if (!entry || !entry.el) return;
            const modalEl = entry.el;
            const focusTarget =
              modalEl.querySelector('[data-modal-initial-focus]') || modalEl.querySelector(focusableSelectors);
            if (focusTarget && typeof focusTarget.focus === 'function') {
              focusTarget.focus({ preventScroll: true });
            } else if (typeof modalEl.focus === 'function') {
              modalEl.focus({ preventScroll: true });
            }
          };

          const setInteractivity = (modalEl, interactive) => {
            if (!modalEl) return;
            modalEl.classList.toggle('modal-stack-muted', !interactive);
            if ('inert' in modalEl) {
              modalEl.inert = !interactive;
            }
            if (!interactive) {
              modalEl.setAttribute('aria-hidden', 'true');
            } else {
              modalEl.removeAttribute('aria-hidden');
            }
          };

          const updateZOrder = () => {
            stack.forEach((entry, index) => {
              const depth = index;
              const modalEl = entry.el;
              const backdropEl = entry.backdrop;
              const isTop = index === stack.length - 1;
              modalEl.style.zIndex = baseModalZ + depth * zStep;
              modalEl.setAttribute('data-modal-stack-depth', depth.toString());
              if (backdropEl) {
                backdropEl.style.zIndex = baseBackdropZ + depth * zStep;
                backdropEl.setAttribute('data-modal-stack-depth', depth.toString());
                backdropEl.style.pointerEvents = isTop ? 'auto' : 'none';
              }
              setInteractivity(modalEl, isTop);
            });
          };

          const assignBackdrop = (entry) => {
            if (!entry) return;
            const backdrops = Array.from(document.querySelectorAll('.modal-backdrop'));
            for (let i = backdrops.length - 1; i >= 0; i -= 1) {
              const candidate = backdrops[i];
              const alreadyAssigned = stack.some((item) => item.backdrop === candidate);
              if (!alreadyAssigned) {
                entry.backdrop = candidate;
                break;
              }
            }
            updateZOrder();
          };

          const handleShow = (event) => {
            const modalEl = event.target;
            if (!(modalEl instanceof HTMLElement)) return;
            const existingIndex = findEntryIndex(modalEl);
            if (existingIndex !== -1) {
              stack.splice(existingIndex, 1);
            }
            const triggerEl = event.relatedTarget instanceof HTMLElement ? event.relatedTarget : document.activeElement;
            const entry = {
              el: modalEl,
              trigger: triggerEl instanceof HTMLElement ? triggerEl : null,
              backdrop: null,
              allowEscape: modalEl.getAttribute('data-bs-keyboard') !== 'false',
              suppressHideOnce: false,
              pendingChild: null,
              pendingTrigger: null
            };
            stack.push(entry);
            updateZOrder();
          };

          const handleShown = (event) => {
            const modalEl = event.target;
            if (!(modalEl instanceof HTMLElement)) return;
            const index = findEntryIndex(modalEl);
            if (index === -1) return;
            const entry = stack[index];
            assignBackdrop(entry);
            if (index > 0) {
              const parentEntry = stack[index - 1];
              if (parentEntry) {
                parentEntry.pendingChild = modalEl;
                parentEntry.pendingTrigger = entry.trigger || parentEntry.pendingTrigger;
              }
            }
            if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
              const instance = bootstrap.Modal.getInstance(modalEl);
              if (instance && instance._config) {
                entry.allowEscape = !!instance._config.keyboard;
              }
            }
            requestAnimationFrame(() => focusEntry(entry));
          };

          const handleHide = (event) => {
            const modalEl = event.target;
            if (!(modalEl instanceof HTMLElement)) return;
            const index = findEntryIndex(modalEl);
            if (index === -1) return;
            const isTop = index === stack.length - 1;
            const entry = stack[index];
            if (entry && entry.suppressHideOnce) {
              entry.suppressHideOnce = false;
              event.preventDefault();
              event.stopImmediatePropagation();
              const topEntry = stack[stack.length - 1];
              requestAnimationFrame(() => focusEntry(topEntry || entry));
              return;
            }
            if (!isTop) {
              event.preventDefault();
              event.stopImmediatePropagation();
              const topEntry = stack[stack.length - 1];
              if (topEntry) {
                requestAnimationFrame(() => focusEntry(topEntry));
              }
            }
          };

          const handleHidden = (event) => {
            const modalEl = event.target;
            if (!(modalEl instanceof HTMLElement)) return;
            const index = findEntryIndex(modalEl);
            if (index === -1) return;
            const [entry] = stack.splice(index, 1);
            if (entry.backdrop) {
              entry.backdrop.style.removeProperty('z-index');
              entry.backdrop.style.pointerEvents = '';
              entry.backdrop.removeAttribute('data-modal-stack-depth');
              entry.backdrop = null;
            }
            modalEl.style.removeProperty('z-index');
            modalEl.removeAttribute('data-modal-stack-depth');
            modalEl.classList.remove('modal-stack-muted');
            if ('inert' in modalEl) {
              modalEl.inert = false;
            }
            modalEl.removeAttribute('aria-hidden');
            updateZOrder();
            const focusTarget = entry.trigger;
            entry.pendingChild = null;
            entry.pendingTrigger = null;
            const nextTop = stack[stack.length - 1];
            setTimeout(() => {
              if (
                focusTarget &&
                isElement(focusTarget) &&
                typeof focusTarget.focus === 'function' &&
                document.contains(focusTarget)
              ) {
                focusTarget.focus({ preventScroll: true });
              } else if (nextTop) {
                focusEntry(nextTop);
              }
            }, 50);
          };

          const handleFocusIn = (event) => {
            if (!stack.length) return;
            const topEntry = stack[stack.length - 1];
            if (!topEntry || !topEntry.el) return;
            const modalEl = topEntry.el;
            if (modalEl.contains(event.target)) {
              return;
            }
            event.stopPropagation();
            requestAnimationFrame(() => focusEntry(topEntry));
          };

          const handleKeyDown = (event) => {
            if (event.key !== 'Escape' || !stack.length) return;
            const topEntry = stack[stack.length - 1];
            if (!topEntry || !topEntry.el) return;
            event.stopPropagation();
            if (!topEntry.allowEscape) {
              event.preventDefault();
              return;
            }
            event.preventDefault();
            if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
              const instance = bootstrap.Modal.getInstance(topEntry.el) || bootstrap.Modal.getOrCreateInstance(topEntry.el);
              if (instance) {
                instance.hide();
              }
            }
          };

          document.addEventListener('show.bs.modal', handleShow, true);
          document.addEventListener('shown.bs.modal', handleShown, true);
          document.addEventListener('hide.bs.modal', handleHide, true);
          document.addEventListener('hidden.bs.modal', handleHidden, true);
          document.addEventListener('focusin', handleFocusIn, true);
          document.addEventListener('keydown', handleKeyDown, true);

          return {
            focusTopModal: () => {
              const topEntry = stack[stack.length - 1] || null;
              if (topEntry) {
                focusEntry(topEntry);
              }
            },
            stackSize: () => stack.length,
            prepareForNestedModal: (triggerEl, childModalEl) => {
              if (!triggerEl || !childModalEl) return;
              const parentEntry = stack[stack.length - 1];
              if (!parentEntry || parentEntry.el === childModalEl) {
                return;
              }
              parentEntry.suppressHideOnce = true;
              parentEntry.pendingChild = childModalEl;
              parentEntry.pendingTrigger = triggerEl instanceof HTMLElement ? triggerEl : null;
            }
          };
        })();

        if (typeof window !== 'undefined') {
          window.modalStackManager = modalStackManager;
        }

        const resolveModalElementFromTrigger = (trigger) => {
          if (!trigger) return null;
          const selector =
            trigger.getAttribute('data-bs-target') ||
            trigger.getAttribute('data-target') ||
            trigger.getAttribute('href') ||
            '';
          if (!selector || selector === '#') {
            return null;
          }
          try {
            return document.querySelector(selector);
          } catch (error) {
            return null;
          }
        };

        document.addEventListener(
          'click',
          (event) => {
            if (
              !window.modalStackManager ||
              typeof window.modalStackManager.prepareForNestedModal !== 'function'
            ) {
              return;
            }
            const trigger =
              event.target instanceof HTMLElement
                ? event.target.closest('[data-modal-child-trigger="true"]')
                : null;
            if (!trigger) return;
            const modalEl = resolveModalElementFromTrigger(trigger);
            if (!modalEl) return;
            window.modalStackManager.prepareForNestedModal(trigger, modalEl);
          },
          true
        );

        const initPortal = () => {
        const tabTriggerList = [].slice.call(document.querySelectorAll('#portalTabs button[data-bs-toggle="tab"]'));
        tabTriggerList.forEach((tabTriggerEl) => {
          tabTriggerEl.addEventListener('shown.bs.tab', (event) => {
            event.target.classList.add('active');
          });
        });

        const sectionNavLinks = document.querySelectorAll('.section-nav-link');
        if (sectionNavLinks.length) {
          const canObserve = 'IntersectionObserver' in window;
          let observer = null;
          const setActiveLink = (target) => {
            sectionNavLinks.forEach((link) => {
              const isActive = link === target;
              link.classList.toggle('active', isActive);
              if (isActive) {
                link.setAttribute('aria-current', 'true');
              } else {
                link.removeAttribute('aria-current');
              }
            });
          };
          if (canObserve) {
            observer = new IntersectionObserver(
              (entries) => {
                entries.forEach((entry) => {
                  if (entry.isIntersecting) {
                    const id = entry.target.dataset.sectionId || entry.target.id;
                    const targetLink = Array.from(sectionNavLinks).find((link) => link.dataset.section === id);
                    if (targetLink) {
                      setActiveLink(targetLink);
                    }
                  }
                });
              },
              { rootMargin: '-55% 0px -35% 0px', threshold: 0.25 }
            );
          }

          let defaultLink = null;
          sectionNavLinks.forEach((link, index) => {
            const id = link.dataset.section;
            if (!id) return;
            const heading = document.getElementById(id);
            if (!heading) return;
            const section = heading.closest('section') || heading;
            section.dataset.sectionId = id;
            if (observer) {
              observer.observe(section);
            }
            link.addEventListener('click', (event) => {
              event.preventDefault();
              heading.scrollIntoView({ behavior: 'smooth', block: 'start' });
              setActiveLink(link);
              if (heading instanceof HTMLElement) {
                heading.setAttribute('tabindex', '-1');
                heading.focus({ preventScroll: true });
                heading.addEventListener(
                  'blur',
                  () => {
                    heading.removeAttribute('tabindex');
                  },
                  { once: true }
                );
              }
            });
            if (index === 0) {
              defaultLink = link;
            }
          });

          if (defaultLink) {
            setActiveLink(defaultLink);
          }
        }

        const formatarCpf = (valor) => {
          if (!valor) return '‚Äî';
          const somenteDigitos = valor.replace(/\D+/g, '');
          if (somenteDigitos.length !== 11) {
            return valor;
          }
          return somenteDigitos.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
        };

        const choicesInstances = new Map();
        if (window.Choices) {
          document.querySelectorAll('select[data-choices="true"]').forEach((select) => {
            const instance = new Choices(select, {
              shouldSort: false,
              allowHTML: false,
              itemSelectText: '',
              searchPlaceholderValue: 'Buscar...',
              placeholder: true,
              placeholderValue: 'Selecione',
            });
            choicesInstances.set(select.id, instance);
          });
        }

        const resetSelect = (element) => {
          if (!element) return;
          const instance = choicesInstances.get(element.id);
          if (instance) {
            instance.removeActiveItems();
            try {
              instance.setChoiceByValue('');
            } catch (error) {
              /* noop */
            }
          } else {
            element.value = '';
          }
        };

        const setSelectValue = (element, value) => {
          if (!element) return;
          const instance = choicesInstances.get(element.id);
          if (instance) {
            instance.removeActiveItems();
            if (value) {
              const possuiOpcao = Array.from(element.options).some((option) => option.value === value);
              if (!possuiOpcao) {
                const novaOpcao = new Option(value, value, true, true);
                element.appendChild(novaOpcao);
              }
            }
            try {
              instance.setChoiceByValue(value || '');
            } catch (error) {
              const opcoes = Array.from(element.options).map((option) => ({
                value: option.value,
                label: option.textContent,
                selected: option.value === value,
              }));
              instance.setChoices(opcoes, 'value', 'label', true);
            }
          } else {
            element.value = value;
          }
        };

        const clearGroupInputs = (group) => {
          if (!group) return;
          const inputs = group.querySelectorAll('input, select, textarea');
          inputs.forEach((input) => {
            if (input.hasAttribute('readonly')) {
              return;
            }
            if (input.type === 'radio' || input.type === 'checkbox') {
              input.checked = false;
            } else if (input.tagName === 'SELECT') {
              resetSelect(input);
            } else {
              input.value = '';
            }
          });
        };

        let sincronizarEnderecoAutorSeMarcado = () => {};

        const toggleGroup = (group, show) => {
          if (!group) return;
          group.classList.toggle('d-none', !show);
          if (!show) {
            clearGroupInputs(group);
          }
        };

        const getCheckedValue = (name) => {
          const selected = document.querySelector(`input[name="${name}"]:checked`);
          return selected ? selected.value : null;
        };

        const deficienciaQualGroup = document.getElementById('deficienciaQualGroup');
        const deficienciaRadios = document.querySelectorAll('input[name="deficienciaSindrome"]');
        const deficienciaViolenciaRadios = document.querySelectorAll('input[name="deficienciaViolencia"]');
        const updateDeficiencia = () => {
          const valor = getCheckedValue('deficienciaSindrome');
          const mostrarQual = valor === 'Sim';
          toggleGroup(deficienciaQualGroup, mostrarQual);
          deficienciaViolenciaRadios.forEach((radio) => {
            const habilitar = valor === 'Sim';
            radio.disabled = !habilitar;
            if (!habilitar) {
              radio.checked = false;
            }
          });
        };
        deficienciaRadios.forEach((radio) => radio.addEventListener('change', updateDeficiencia));

        const problemaSaudeQualGroup = document.getElementById('problemaSaudeQualGroup');
        const problemaSaudeRadios = document.querySelectorAll('input[name="problemaSaude"]');
        const updateProblemaSaude = () => {
          toggleGroup(problemaSaudeQualGroup, getCheckedValue('problemaSaude') === 'Sim');
        };
        problemaSaudeRadios.forEach((radio) => radio.addEventListener('change', updateProblemaSaude));

        const tempoPsicologoGroup = document.getElementById('tempoPsicologoGroup');
        const psicologoRadios = document.querySelectorAll('input[name="atendimentoPsicologo"]');
        const updatePsicologo = () => {
          toggleGroup(tempoPsicologoGroup, getCheckedValue('atendimentoPsicologo') === 'Sim');
        };
        psicologoRadios.forEach((radio) => radio.addEventListener('change', updatePsicologo));

        const tempoPsiquiatraGroup = document.getElementById('tempoPsiquiatraGroup');
        const psiquiatraRadios = document.querySelectorAll('input[name="atendimentoPsiquiatra"]');
        const updatePsiquiatra = () => {
          toggleGroup(tempoPsiquiatraGroup, getCheckedValue('atendimentoPsiquiatra') === 'Sim');
        };
        psiquiatraRadios.forEach((radio) => radio.addEventListener('change', updatePsiquiatra));

        const medicamentosQuaisGroup = document.getElementById('medicamentosQuaisGroup');
        const medicamentosRadios = document.querySelectorAll('input[name="usoMedicamento"]');
        const updateMedicamentos = () => {
          toggleGroup(medicamentosQuaisGroup, getCheckedValue('usoMedicamento') === 'Sim');
        };
        medicamentosRadios.forEach((radio) => radio.addEventListener('change', updateMedicamentos));

        const drogasLicitasGroup = document.getElementById('drogasLicitasGroup');
        const drogasLicitasRadios = document.querySelectorAll('input[name="usoDrogasLicitas"]');
        const drogasLicitasOutrasGroup = document.getElementById('drogasLicitasOutrasGroup');
        const drogaLicitaOutrasCheckbox = document.getElementById('drogaLicitaOutras');
        const updateDrogasLicitas = () => {
          const mostrar = getCheckedValue('usoDrogasLicitas') === 'Sim';
          toggleGroup(drogasLicitasGroup, mostrar);
          if (!mostrar) {
            toggleGroup(drogasLicitasOutrasGroup, false);
          }
        };
        drogasLicitasRadios.forEach((radio) => radio.addEventListener('change', updateDrogasLicitas));
        if (drogaLicitaOutrasCheckbox) {
          drogaLicitaOutrasCheckbox.addEventListener('change', () => {
            toggleGroup(drogasLicitasOutrasGroup, drogaLicitaOutrasCheckbox.checked);
          });
        }

        const drogasIlicitasGroup = document.getElementById('drogasIlicitasGroup');
        const drogasIlicitasRadios = document.querySelectorAll('input[name="usoDrogasIlicitas"]');
        const drogasIlicitasOutrasGroup = document.getElementById('drogasIlicitasOutrasGroup');
        const drogaIlicitaOutrasCheckbox = document.getElementById('drogaIlicitaOutras');
        const updateDrogasIlicitas = () => {
          const mostrar = getCheckedValue('usoDrogasIlicitas') === 'Sim';
          toggleGroup(drogasIlicitasGroup, mostrar);
          if (!mostrar) {
            toggleGroup(drogasIlicitasOutrasGroup, false);
          }
        };
        drogasIlicitasRadios.forEach((radio) => radio.addEventListener('change', updateDrogasIlicitas));
        if (drogaIlicitaOutrasCheckbox) {
          drogaIlicitaOutrasCheckbox.addEventListener('change', () => {
            toggleGroup(drogasIlicitasOutrasGroup, drogaIlicitaOutrasCheckbox.checked);
          });
        }

        const tempoGestacaoGroup = document.getElementById('tempoGestacaoGroup');
        const gestanteRadios = document.querySelectorAll('input[name="gestante"]');
        const updateGestante = () => {
          toggleGroup(tempoGestacaoGroup, getCheckedValue('gestante') === 'Sim');
        };
        gestanteRadios.forEach((radio) => radio.addEventListener('change', updateGestante));

        const identidadeGeneroSelect = document.getElementById('identidadeGenero');
        const preventivoGroup = document.getElementById('preventivoGroup');
        const preventivoAnoGroup = document.getElementById('preventivoAnoGroup');
        const preventivoRadios = document.querySelectorAll('input[name="preventivoColo"]');
        const mamografiaGroup = document.getElementById('mamografiaGroup');
        const mamografiaAnoGroup = document.getElementById('mamografiaAnoGroup');
        const mamografiaRadios = document.querySelectorAll('input[name="mamografia"]');
        const isPerfilFeminino = () => {
          if (!identidadeGeneroSelect) return false;
          const valor = identidadeGeneroSelect.value;
          return ['Mulher cisg√™nero', 'Mulher trans', 'Travesti'].includes(valor);
        };
        const atualizarExamesFemininos = () => {
          const feminino = isPerfilFeminino();
          toggleGroup(preventivoGroup, feminino);
          toggleGroup(mamografiaGroup, feminino);
          if (!feminino) {
            toggleGroup(preventivoAnoGroup, false);
            toggleGroup(mamografiaAnoGroup, false);
          }
        };
        const updatePreventivoAno = () => {
          toggleGroup(preventivoAnoGroup, getCheckedValue('preventivoColo') === 'Sim');
        };
        const updateMamografiaAno = () => {
          toggleGroup(mamografiaAnoGroup, getCheckedValue('mamografia') === 'Sim');
        };
        preventivoRadios.forEach((radio) => radio.addEventListener('change', updatePreventivoAno));
        mamografiaRadios.forEach((radio) => radio.addEventListener('change', updateMamografiaAno));
        if (identidadeGeneroSelect) {
          identidadeGeneroSelect.addEventListener('change', atualizarExamesFemininos);
        }

        const resultadoHivGroup = document.getElementById('resultadoHivGroup');
        const exameHivRadios = document.querySelectorAll('input[name="exameHiv"]');
        const contraiuAgressorGroup = document.getElementById('contraiuAgressorGroup');
        const resultadoHivRadios = document.querySelectorAll('input[name="resultadoHiv"]');
        const updateResultadoHiv = () => {
          const mostrar = getCheckedValue('exameHiv') === 'Sim';
          toggleGroup(resultadoHivGroup, mostrar);
          if (!mostrar) {
            toggleGroup(contraiuAgressorGroup, false);
          }
        };
        const updateContraiuAgressor = () => {
          toggleGroup(contraiuAgressorGroup, getCheckedValue('resultadoHiv') === 'Positivo');
        };
        exameHivRadios.forEach((radio) => radio.addEventListener('change', updateResultadoHiv));
        resultadoHivRadios.forEach((radio) => radio.addEventListener('change', updateContraiuAgressor));

        const tempoAcompanhamentoGroup = document.getElementById('tempoAcompanhamentoGroup');
        const acompanhamentoRadios = document.querySelectorAll('input[name="acompanhamentoSaudeContinuo"]');
        const updateAcompanhamento = () => {
          toggleGroup(tempoAcompanhamentoGroup, getCheckedValue('acompanhamentoSaudeContinuo') === 'Sim');
        };
        acompanhamentoRadios.forEach((radio) => radio.addEventListener('change', updateAcompanhamento));

        updateDeficiencia();
        updateProblemaSaude();
        updatePsicologo();
        updatePsiquiatra();
        updateMedicamentos();
        updateDrogasLicitas();
        if (drogaLicitaOutrasCheckbox) {
          toggleGroup(
            drogasLicitasOutrasGroup,
            getCheckedValue('usoDrogasLicitas') === 'Sim' && drogaLicitaOutrasCheckbox.checked
          );
        }
        updateDrogasIlicitas();
        if (drogaIlicitaOutrasCheckbox) {
          toggleGroup(
            drogasIlicitasOutrasGroup,
            getCheckedValue('usoDrogasIlicitas') === 'Sim' && drogaIlicitaOutrasCheckbox.checked
          );
        }
        updateGestante();
        if (identidadeGeneroSelect) {
          atualizarExamesFemininos();
        }
        updatePreventivoAno();
        updateMamografiaAno();
        updateResultadoHiv();
        updateContraiuAgressor();
        updateAcompanhamento();

        const estados = ['AC', 'AL', 'AP', 'AM', 'BA', 'CE', 'DF', 'ES', 'GO', 'MA', 'MT', 'MS', 'MG', 'PA', 'PB', 'PR', 'PE', 'PI', 'RJ', 'RN', 'RS', 'RO', 'RR', 'SC', 'SP', 'SE', 'TO'];
        const citiesByState = {
          PE: ['Recife', 'Olinda', 'Caruaru', 'Jaboat√£o dos Guararapes', 'Petrolina'],
          PB: ['Jo√£o Pessoa', 'Campina Grande', 'Patos', 'Sousa'],
          AL: ['Macei√≥', 'Arapiraca', 'Palmeira dos √çndios'],
          CE: ['Fortaleza', 'Juazeiro do Norte', 'Sobral'],
          BA: ['Salvador', 'Feira de Santana', 'Vit√≥ria da Conquista'],
          SP: ['S√£o Paulo', 'Campinas', 'Santos'],
          RJ: ['Rio de Janeiro', 'Niter√≥i', 'Campos dos Goytacazes'],
        };

        const preencherEstados = (ids = []) => {
          ids
            .map((id) => document.getElementById(id))
            .filter(Boolean)
            .forEach((select) => {
              const valoresExistentes = new Set(Array.from(select.options).map((opt) => opt.value));
              estados.forEach((estado) => {
                if (!valoresExistentes.has(estado)) {
                  const option = document.createElement('option');
                  option.value = estado;
                  option.textContent = estado;
                  select.appendChild(option);
                }
              });
            });
        };

        preencherEstados(['uf', 'ufNascimento', 'ufExpedicao', 'autorUf', 'autorUfNascimento', 'autorUfExpedicao']);

        const configurarCidadeDependente = (ufId, cidadeId) => {
          const ufSelect = document.getElementById(ufId);
          const cidadeSelect = document.getElementById(cidadeId);
          if (!ufSelect || !cidadeSelect) return;

          const atualizar = () => {
            const ufSelecionada = ufSelect.value;
            cidadeSelect.innerHTML = '';
            const placeholder = document.createElement('option');
            placeholder.value = '';
            placeholder.textContent = ufSelecionada ? 'Selecione' : 'Selecione a UF primeiro';
            cidadeSelect.appendChild(placeholder);
            if (ufSelecionada && citiesByState[ufSelecionada]) {
              citiesByState[ufSelecionada].forEach((cidade) => {
                const option = document.createElement('option');
                option.value = cidade;
                option.textContent = cidade;
                cidadeSelect.appendChild(option);
              });
            }
          };

          atualizar();
          ufSelect.addEventListener('change', atualizar);
        };

        const cidadeNascimentoSelect = document.getElementById('cidadeNascimento');
        configurarCidadeDependente('ufNascimento', 'cidadeNascimento');
        configurarCidadeDependente('autorUfNascimento', 'autorCidadeNascimento');

        const dataNascimentoInput = document.getElementById('dataNascimento');
        const cpfUsuarioInput = document.getElementById('cpfUsuario');
        const nomeUsuarioInput = document.getElementById('nomeUsuario');
        const rgUsuarioInput = document.getElementById('rgUsuario');
        const orgaoExpedidorInput = document.getElementById('orgaoExpedidor');
        const ufExpedicaoSelect = document.getElementById('ufExpedicao');
        const nacionalidadeInput = document.getElementById('nacionalidade');
        const ufNascimentoSelect = document.getElementById('ufNascimento');
        const nomeMaeInput = document.getElementById('nomeMae');
        const nomePaiInput = document.getElementById('nomePai');
        const idadeInput = document.getElementById('idade');

        const obterMirrorId = (element) => `${element.id || element.name || 'readonly'}-mirror`;

        const setElementReadOnly = (element, locked) => {
          if (!element) return;
          const tag = element.tagName ? element.tagName.toLowerCase() : '';
          if (tag === 'select') {
            const mirrorId = obterMirrorId(element);
            if (locked) {
              let mirror = document.getElementById(mirrorId);
              if (!mirror && element.name) {
                mirror = document.createElement('input');
                mirror.type = 'hidden';
                mirror.id = mirrorId;
                mirror.name = element.name;
                element.insertAdjacentElement('afterend', mirror);
              }
              if (mirror) {
                mirror.value = element.value;
              }
              element.disabled = true;
              element.setAttribute('aria-readonly', 'true');
              element.classList.add('readonly-field');
              element.dataset.readonlyMirrorId = mirrorId;
            } else {
              element.disabled = false;
              element.removeAttribute('aria-readonly');
              element.classList.remove('readonly-field');
              const mirrorId = element.dataset.readonlyMirrorId || obterMirrorId(element);
              const mirror = document.getElementById(mirrorId);
              if (mirror) {
                mirror.remove();
              }
              delete element.dataset.readonlyMirrorId;
            }
            return;
          }

          if (locked) {
            element.setAttribute('readonly', 'readonly');
            element.setAttribute('aria-readonly', 'true');
            element.classList.add('readonly-field');
          } else {
            element.removeAttribute('readonly');
            element.removeAttribute('aria-readonly');
            element.classList.remove('readonly-field');
          }
        };

        const toggleIdentificacaoReadOnly = (mode = 'create') => {
          const normalized = typeof mode === 'string' ? mode : mode ? 'view' : 'create';
          const shouldUnlock = normalized === 'create';
          const isViewMode = normalized === 'view';
          const lockWhenFilled = normalized === 'edit';
          const campos = [
            cpfUsuarioInput,
            nomeUsuarioInput,
            dataNascimentoInput,
            rgUsuarioInput,
            orgaoExpedidorInput,
            ufExpedicaoSelect,
            nacionalidadeInput,
            ufNascimentoSelect,
            cidadeNascimentoSelect,
            nomeMaeInput,
            nomePaiInput,
          ];

          campos.forEach((campo) => {
            if (!campo) return;
            if (shouldUnlock) {
              setElementReadOnly(campo, false);
              return;
            }
            if (isViewMode) {
              setElementReadOnly(campo, true);
              return;
            }
            const temValor = campo.value && campo.value.toString().trim().length > 0;
            setElementReadOnly(campo, lockWhenFilled && temValor);
          });
        };
        const calcularIdade = () => {
          if (!dataNascimentoInput || !idadeInput) return;
          const valor = dataNascimentoInput.value.trim();
          if (!valor || valor.length < 8) {
            idadeInput.value = '';
            return;
          }
          const partes = valor.split('/');
          if (partes.length !== 3) {
            idadeInput.value = '';
            return;
          }
          const [dia, mes, ano] = partes;
          const iso = `${ano}-${mes}-${dia}`;
          const dataNasc = dayjs(iso);
          if (!dataNasc.isValid()) {
            idadeInput.value = '';
            return;
          }
          const idade = dayjs().diff(dataNasc, 'year');
          idadeInput.value = Number.isFinite(idade) ? `${idade} anos` : '';
        };
        if (dataNascimentoInput) {
          dataNascimentoInput.addEventListener('input', calcularIdade);
          dataNascimentoInput.addEventListener('change', calcularIdade);
          dataNascimentoInput.addEventListener('blur', calcularIdade);
        }

        const configurarBuscaCep = ({
          cepId,
          logradouroId,
          bairroId,
          cidadeId,
          ufId,
          helpId,
        }) => {
          const cepInput = document.getElementById(cepId);
          if (!cepInput) return null;
          const logradouroInput = logradouroId ? document.getElementById(logradouroId) : null;
          const bairroInput = bairroId ? document.getElementById(bairroId) : null;
          const cidadeInput = cidadeId ? document.getElementById(cidadeId) : null;
          const ufInput = ufId ? document.getElementById(ufId) : null;
          const helpElement = helpId ? document.getElementById(helpId) : null;

          const limparEndereco = () => {
            if (logradouroInput) logradouroInput.value = '';
            if (bairroInput) bairroInput.value = '';
            if (cidadeInput) cidadeInput.value = '';
            if (ufInput) resetSelect(ufInput);
            sincronizarEnderecoAutorSeMarcado();
          };

          const atualizarAjuda = (mensagem = '') => {
            if (helpElement) {
              helpElement.textContent = mensagem;
            }
          };

          cepInput.addEventListener('blur', async () => {
            const cepNumeros = cepInput.value.replace(/\D/g, '');
            if (cepNumeros.length !== 8) {
              atualizarAjuda('Digite um CEP v√°lido com 8 d√≠gitos.');
              limparEndereco();
              return;
            }
            atualizarAjuda('Consultando CEP na Brasil API...');
            try {
              const response = await fetch(`https://brasilapi.com.br/api/cep/v1/${cepNumeros}`);
              if (!response.ok) {
                throw new Error('CEP n√£o encontrado');
              }
              const data = await response.json();
              if (logradouroInput) logradouroInput.value = data.street || '';
              if (bairroInput) bairroInput.value = data.neighborhood || '';
              if (cidadeInput) cidadeInput.value = data.city || '';
              if (ufInput) setSelectValue(ufInput, data.state || '');
              atualizarAjuda('');
              sincronizarEnderecoAutorSeMarcado();
            } catch (error) {
              limparEndereco();
              atualizarAjuda('N√£o foi poss√≠vel localizar o CEP. Preencha os dados manualmente.');
            }
          });

          return { limparEndereco, atualizarAjuda };
        };

        const enderecoPrincipal = configurarBuscaCep({
          cepId: 'cep',
          logradouroId: 'logradouro',
          bairroId: 'bairro',
          cidadeId: 'cidade',
          ufId: 'uf',
          helpId: 'cepHelp',
        });

        const enderecoAutor = configurarBuscaCep({
          cepId: 'autorCep',
          logradouroId: 'autorLogradouro',
          bairroId: 'autorBairro',
          cidadeId: 'autorCidade',
          ufId: 'autorUf',
          helpId: 'autorCepHelp',
        });

        const atendimentoChecks = document.querySelectorAll('.atendimento-check');
        const encaminhamentosAlert = document.getElementById('encaminhamentosAlert');
        const atualizarEncaminhamentos = () => {
          if (!encaminhamentosAlert) return;
          const deveExibir = Array.from(atendimentoChecks).some((check) =>
            check.checked && (check.value === 'Acolhida/Orienta√ß√£o' || check.value === 'Outros Munic√≠pios')
          );
          encaminhamentosAlert.classList.toggle('d-none', !deveExibir);
        };
        atendimentoChecks.forEach((check) => {
          check.addEventListener('change', atualizarEncaminhamentos);
        });

        const fisicaOutrasCheckbox = document.getElementById('fisicaOutras');
        const violenciaFisicaOutrasGroup = document.getElementById('violenciaFisicaOutrasGroup');
        const updateViolenciaFisicaOutras = () => {
          toggleGroup(violenciaFisicaOutrasGroup, fisicaOutrasCheckbox && fisicaOutrasCheckbox.checked);
        };
        if (fisicaOutrasCheckbox) {
          fisicaOutrasCheckbox.addEventListener('change', updateViolenciaFisicaOutras);
        }

        const psicologicaOutrasCheckbox = document.getElementById('psicologicaOutras');
        const violenciaPsicologicaOutrasGroup = document.getElementById('violenciaPsicologicaOutrasGroup');
        const updateViolenciaPsicologicaOutras = () => {
          toggleGroup(
            violenciaPsicologicaOutrasGroup,
            psicologicaOutrasCheckbox && psicologicaOutrasCheckbox.checked
          );
        };
        if (psicologicaOutrasCheckbox) {
          psicologicaOutrasCheckbox.addEventListener('change', updateViolenciaPsicologicaOutras);
        }

        const sexualOutrasCheckbox = document.getElementById('sexualOutras');
        const violenciaSexualOutrasGroup = document.getElementById('violenciaSexualOutrasGroup');
        const updateViolenciaSexualOutras = () => {
          toggleGroup(violenciaSexualOutrasGroup, sexualOutrasCheckbox && sexualOutrasCheckbox.checked);
        };
        if (sexualOutrasCheckbox) {
          sexualOutrasCheckbox.addEventListener('change', updateViolenciaSexualOutras);
        }

        const localOutrosCheckbox = document.getElementById('localOutros');
        const localAgressaoOutrosGroup = document.getElementById('localAgressaoOutrosGroup');
        const updateLocalAgressaoOutros = () => {
          toggleGroup(localAgressaoOutrosGroup, localOutrosCheckbox && localOutrosCheckbox.checked);
        };
        if (localOutrosCheckbox) {
          localOutrosCheckbox.addEventListener('change', updateLocalAgressaoOutros);
        }

        const fatorOutrosCheckbox = document.getElementById('fatorOutros');
        const fatoresRelacionadosOutrosGroup = document.getElementById('fatoresRelacionadosOutrosGroup');
        const updateFatoresRelacionadosOutros = () => {
          toggleGroup(fatoresRelacionadosOutrosGroup, fatorOutrosCheckbox && fatorOutrosCheckbox.checked);
        };
        if (fatorOutrosCheckbox) {
          fatorOutrosCheckbox.addEventListener('change', updateFatoresRelacionadosOutros);
        }

        const conhecimentoRadios = document.querySelectorAll('input[name="conhecimentoAgressao"]');
        const conhecimentoExtras = document.getElementById('conhecimentoExtras');
        const updateConhecimentoAgressao = () => {
          toggleGroup(conhecimentoExtras, getCheckedValue('conhecimentoAgressao') === 'Sim');
        };
        conhecimentoRadios.forEach((radio) => radio.addEventListener('change', updateConhecimentoAgressao));

        const ciodsRadios = document.querySelectorAll('input[name="solicitarCiods"]');
        const ciodsCampos = document.getElementById('ciodsCampos');
        const updateSolicitarCiods = () => {
          toggleGroup(ciodsCampos, getCheckedValue('solicitarCiods') === 'Sim');
        };
        ciodsRadios.forEach((radio) => radio.addEventListener('change', updateSolicitarCiods));

        const relatoCasoField = document.getElementById('relatoCaso');
        const editarRelatoCheckbox = document.getElementById('editarRelato');
        const updateEditarRelato = () => {
          if (!relatoCasoField || !editarRelatoCheckbox) return;
          const podeEditar = editarRelatoCheckbox.checked;
          relatoCasoField.readOnly = !podeEditar;
          if (!podeEditar) {
            relatoCasoField.setAttribute('aria-disabled', 'true');
          } else {
            relatoCasoField.removeAttribute('aria-disabled');
          }
        };
        if (editarRelatoCheckbox) {
          editarRelatoCheckbox.addEventListener('change', updateEditarRelato);
        }

        updateViolenciaFisicaOutras();
        updateViolenciaPsicologicaOutras();
        updateViolenciaSexualOutras();
        updateLocalAgressaoOutros();
        updateFatoresRelacionadosOutros();
        updateConhecimentoAgressao();
        updateSolicitarCiods();
        updateEditarRelato();

        const registroOcorrenciaSelect = document.getElementById('registroOcorrencia');
        const numeroBoGroup = document.getElementById('numeroBoGroup');
        const origemProcedimentoSelect = document.getElementById('origemProcedimento');
        const numeroInqueritoGroup = document.getElementById('numeroInqueritoGroup');
        const exameCorpoDelitoSelect = document.getElementById('exameCorpoDelito');
        const orgaoEmitenteGroup = document.getElementById('orgaoEmitenteGroup');
        const fiancaSelect = document.getElementById('fianca');
        const valorFiancaGroup = document.getElementById('valorFiancaGroup');
        const medidaSolicitadaRadios = document.querySelectorAll('input[name="medidaSolicitada"]');
        const medidaUrgenciaDetalhes = document.getElementById('medidaUrgenciaDetalhes');
        const medidaDeferidaRadios = document.querySelectorAll('input[name="medidaDeferida"]');
        const medidasDeferidasWrapper = document.getElementById('medidasDeferidasWrapper');
        const descumprimentoRadios = document.querySelectorAll('input[name="descumprimento"]');
        const descumprimentoCampos = document.getElementById('descumprimentoCampos');
        const descumprimentoBoRadios = document.querySelectorAll('input[name="descumprimentoBo"]');
        const descumprimentoBoNumeroGroup = document.getElementById('descumprimentoBoNumeroGroup');
        const descumprimentoBoDataGroup = document.getElementById('descumprimentoBoDataGroup');
        const decisaoGravosaRadios = document.querySelectorAll('input[name="decisaoGravosa"]');
        const decisaoGravosaCampos = document.getElementById('decisaoGravosaCampos');
        const acaoPenalRadios = document.querySelectorAll('input[name="acaoPenal"]');
        const acaoPenalCampos = document.getElementById('acaoPenalCampos');
        const queixaCrimeRadios = document.querySelectorAll('input[name="queixaCrime"]');
        const queixaCrimeCampos = document.getElementById('queixaCrimeCampos');
        const abrigamentoRadios = document.querySelectorAll('input[name="abrigamento"]');
        const dataAbrigoGroup = document.getElementById('dataAbrigoGroup');
        const violenciaInstitucionalSelect = document.getElementById('violenciaInstitucional');
        const instituicaoViolenciaGroup = document.getElementById('instituicaoViolenciaGroup');
        const instituicaoViolenciaSelect = document.getElementById('instituicaoViolencia');
        const instituicaoViolenciaOutraGroup = document.getElementById('instituicaoViolenciaOutraGroup');
        const encaminhamentoCheckboxes = document.querySelectorAll('.encaminhamento-checkbox');

        const updateNumeroBoGroup = () => {
          const mostrar = registroOcorrenciaSelect && registroOcorrenciaSelect.value === 'Registrada';
          toggleGroup(numeroBoGroup, mostrar);
        };

        const updateOrigemProcedimento = () => {
          const mostrar = origemProcedimentoSelect && origemProcedimentoSelect.value !== '';
          toggleGroup(numeroInqueritoGroup, mostrar);
        };

        const updateExameCorpoDelito = () => {
          const mostrar = exameCorpoDelitoSelect && exameCorpoDelitoSelect.value === 'Sim';
          toggleGroup(orgaoEmitenteGroup, mostrar);
        };

        const updateFianca = () => {
          const mostrar = fiancaSelect && fiancaSelect.value === 'Sim';
          toggleGroup(valorFiancaGroup, mostrar);
        };

        const ensureRadioDefault = (selector) => {
          const radio = document.querySelector(selector);
          if (radio) {
            radio.checked = true;
          }
        };

        const updateMedidaDeferida = () => {
          const mostrar = getCheckedValue('medidaDeferida') === 'Sim';
          toggleGroup(medidasDeferidasWrapper, mostrar);
        };

        const updateMedidaSolicitada = () => {
          const mostrar = getCheckedValue('medidaSolicitada') === 'Sim';
          toggleGroup(medidaUrgenciaDetalhes, mostrar);
          if (!mostrar) {
            ensureRadioDefault('#medidaDeferidaNao');
            toggleGroup(medidasDeferidasWrapper, false);
          } else {
            if (!getCheckedValue('medidaDeferida')) {
              ensureRadioDefault('#medidaDeferidaNao');
            }
          }
          updateMedidaDeferida();
        };

        const updateDescumprimentoBo = () => {
          const mostrar = getCheckedValue('descumprimentoBo') === 'Sim';
          toggleGroup(descumprimentoBoNumeroGroup, mostrar);
          toggleGroup(descumprimentoBoDataGroup, mostrar);
        };

        const updateDescumprimento = () => {
          const mostrar = getCheckedValue('descumprimento') === 'Sim';
          toggleGroup(descumprimentoCampos, mostrar);
          if (!mostrar) {
            ensureRadioDefault('#descumprimentoBoNao');
            toggleGroup(descumprimentoBoNumeroGroup, false);
            toggleGroup(descumprimentoBoDataGroup, false);
          } else if (!getCheckedValue('descumprimentoBo')) {
            ensureRadioDefault('#descumprimentoBoNao');
          }
          updateDescumprimentoBo();
        };

        const updateDecisaoGravosa = () => {
          const mostrar = getCheckedValue('decisaoGravosa') === 'Sim';
          toggleGroup(decisaoGravosaCampos, mostrar);
        };

        const updateAcaoPenal = () => {
          const mostrar = getCheckedValue('acaoPenal') === 'Sim';
          toggleGroup(acaoPenalCampos, mostrar);
        };

        const updateQueixaCrime = () => {
          const mostrar = getCheckedValue('queixaCrime') === 'Sim';
          toggleGroup(queixaCrimeCampos, mostrar);
        };

        const updateAbrigamento = () => {
          const mostrar = getCheckedValue('abrigamento') === 'Sim';
          toggleGroup(dataAbrigoGroup, mostrar);
        };

        const updateInstituicaoViolencia = () => {
          const mostrarOutra = instituicaoViolenciaSelect && instituicaoViolenciaSelect.value === 'Outros';
          toggleGroup(instituicaoViolenciaOutraGroup, mostrarOutra);
        };

        const updateViolenciaInstitucional = () => {
          const mostrar = violenciaInstitucionalSelect && violenciaInstitucionalSelect.value === 'Sim';
          toggleGroup(instituicaoViolenciaGroup, mostrar);
          if (!mostrar) {
            toggleGroup(instituicaoViolenciaOutraGroup, false);
          }
          updateInstituicaoViolencia();
        };

        if (registroOcorrenciaSelect) {
          registroOcorrenciaSelect.addEventListener('change', updateNumeroBoGroup);
          updateNumeroBoGroup();
        }
        if (origemProcedimentoSelect) {
          origemProcedimentoSelect.addEventListener('change', updateOrigemProcedimento);
          updateOrigemProcedimento();
        }
        if (exameCorpoDelitoSelect) {
          exameCorpoDelitoSelect.addEventListener('change', updateExameCorpoDelito);
          updateExameCorpoDelito();
        }
        if (fiancaSelect) {
          fiancaSelect.addEventListener('change', updateFianca);
          updateFianca();
        }
        medidaSolicitadaRadios.forEach((radio) => radio.addEventListener('change', updateMedidaSolicitada));
        medidaDeferidaRadios.forEach((radio) => radio.addEventListener('change', updateMedidaDeferida));
        updateMedidaSolicitada();
        descumprimentoRadios.forEach((radio) => radio.addEventListener('change', updateDescumprimento));
        descumprimentoBoRadios.forEach((radio) => radio.addEventListener('change', updateDescumprimentoBo));
        updateDescumprimento();
        decisaoGravosaRadios.forEach((radio) => radio.addEventListener('change', updateDecisaoGravosa));
        updateDecisaoGravosa();
        acaoPenalRadios.forEach((radio) => radio.addEventListener('change', updateAcaoPenal));
        updateAcaoPenal();
        queixaCrimeRadios.forEach((radio) => radio.addEventListener('change', updateQueixaCrime));
        updateQueixaCrime();
        abrigamentoRadios.forEach((radio) => radio.addEventListener('change', updateAbrigamento));
        updateAbrigamento();
        if (violenciaInstitucionalSelect) {
          violenciaInstitucionalSelect.addEventListener('change', updateViolenciaInstitucional);
          updateViolenciaInstitucional();
        }
        if (instituicaoViolenciaSelect) {
          instituicaoViolenciaSelect.addEventListener('change', updateInstituicaoViolencia);
        }
        encaminhamentoCheckboxes.forEach((checkbox) => {
          const targetSelector = checkbox.getAttribute('data-complement-target');
          const target = targetSelector ? document.querySelector(targetSelector) : null;
          const toggle = () => {
            if (!target) return;
            const mostrar = checkbox.checked;
            target.classList.toggle('d-none', !mostrar);
            if (!mostrar) {
              clearGroupInputs(target);
            }
          };
          checkbox.addEventListener('change', toggle);
          toggle();
        });

        const escolaridadeSelect = document.getElementById('escolaridade');
        const situacaoOcupacionalSelect = document.getElementById('situacaoOcupacional');
        const detalhesTrabalho = document.getElementById('detalhesTrabalho');
        const situacaoTrabalhoSelect = document.getElementById('situacaoTrabalho');
        const situacaoTrabalhoGroup = document.getElementById('situacaoTrabalhoGroup');
        const profissaoInput = document.getElementById('profissao');
        const rendaIndividualInput = document.getElementById('rendaIndividual');
        const situacaoEscolarGroup = document.getElementById('situacaoEscolarGroup');
        const cursoFormacaoGroup = document.getElementById('cursoFormacaoGroup');
        const tipoPosGraduacaoGroup = document.getElementById('tipoPosGraduacaoGroup');
        const anoPeriodoGroup = document.getElementById('anoPeriodoGroup');
        const situacaoEscolarSelect = document.getElementById('situacaoEscolar');
        const cursoFormacaoInput = document.getElementById('cursoFormacao');
        const tipoPosGraduacaoSelect = document.getElementById('tipoPosGraduacao');
        const anoPeriodoInput = document.getElementById('anoPeriodo');

        const atualizarDetalhesEscolares = () => {
          if (!escolaridadeSelect) return;
          const valor = escolaridadeSelect.value;
          const mostrarSituacao = valor && valor !== 'Sem instru√ß√£o';
          if (situacaoEscolarGroup) {
            situacaoEscolarGroup.classList.toggle('d-none', !mostrarSituacao);
          }
          if (!mostrarSituacao && situacaoEscolarSelect) {
            situacaoEscolarSelect.value = '';
          }
          const cursosQueExigemDetalhe = [
            'Curso t√©cnico',
            'Tecn√≥logo',
            'Ensino superior',
            'P√≥s-gradua√ß√£o',
            'Mestrado',
            'Doutorado',
          ];
          const mostrarCurso = cursosQueExigemDetalhe.includes(valor);
          if (cursoFormacaoGroup) {
            cursoFormacaoGroup.classList.toggle('d-none', !mostrarCurso);
          }
          if (!mostrarCurso && cursoFormacaoInput) {
            cursoFormacaoInput.value = '';
          }
          const mostrarPosGraduacao = valor === 'P√≥s-gradua√ß√£o';
          if (tipoPosGraduacaoGroup) {
            tipoPosGraduacaoGroup.classList.toggle('d-none', !mostrarPosGraduacao);
          }
          if (!mostrarPosGraduacao && tipoPosGraduacaoSelect) {
            tipoPosGraduacaoSelect.value = '';
          }
          const mostrarAnoPeriodo = valor && valor !== 'Sem instru√ß√£o';
          if (anoPeriodoGroup) {
            anoPeriodoGroup.classList.toggle('d-none', !mostrarAnoPeriodo);
          }
          if (!mostrarAnoPeriodo && anoPeriodoInput) {
            anoPeriodoInput.value = '';
          }
        };

        const atualizarDetalhesTrabalho = () => {
          const mostrarTrabalho =
            (situacaoOcupacionalSelect && situacaoOcupacionalSelect.value !== '') ||
            (situacaoTrabalhoSelect && situacaoTrabalhoSelect.value !== '');
          if (detalhesTrabalho) {
            detalhesTrabalho.classList.toggle('d-none', !mostrarTrabalho);
          }
          if (situacaoTrabalhoGroup) {
            situacaoTrabalhoGroup.classList.toggle('d-none', !mostrarTrabalho);
          }
          if (!mostrarTrabalho) {
            if (profissaoInput) {
              profissaoInput.value = '';
            }
            if (situacaoTrabalhoSelect) {
              resetSelect(situacaoTrabalhoSelect);
            }
            if (rendaIndividualInput) {
              rendaIndividualInput.value = '';
            }
          }
        };

        const atualizarDetalhes = () => {
          atualizarDetalhesEscolares();
          atualizarDetalhesTrabalho();
        };

        if (escolaridadeSelect) {
          escolaridadeSelect.addEventListener('change', atualizarDetalhes);
        }
        if (situacaoOcupacionalSelect) {
          situacaoOcupacionalSelect.addEventListener('change', atualizarDetalhes);
        }
        if (situacaoTrabalhoSelect) {
          situacaoTrabalhoSelect.addEventListener('change', atualizarDetalhes);
        }
        atualizarDetalhes();

        const situacaoHabitacionalSelect = document.getElementById('situacaoHabitacional');
        const situacaoHabitacionalOutroGroup = document.getElementById('situacaoHabitacionalOutroGroup');
        const situacaoHabitacionalOutroInput = document.getElementById('situacaoHabitacionalOutro');
        const atualizarSituacaoHabitacionalOutro = () => {
          if (!situacaoHabitacionalSelect || !situacaoHabitacionalOutroGroup) return;
          const mostrarOutro = situacaoHabitacionalSelect.value === 'Outros';
          situacaoHabitacionalOutroGroup.classList.toggle('d-none', !mostrarOutro);
          if (!mostrarOutro && situacaoHabitacionalOutroInput) {
            situacaoHabitacionalOutroInput.value = '';
          }
        };
        if (situacaoHabitacionalSelect) {
          situacaoHabitacionalSelect.addEventListener('change', atualizarSituacaoHabitacionalOutro);
          atualizarSituacaoHabitacionalOutro();
        }

        const cursosWrapper = document.getElementById('cursosWrapper');
        const adicionarCursoBtn = document.getElementById('adicionarCurso');
        const cursosExtras = document.getElementById('cursosExtras');
        const cursoCapacitacao = document.getElementById('cursoCapacitacao');
        let cursosAdicionados = 1;
        const atualizarWrapperCursos = (mostrar) => {
          if (!cursosWrapper) return;
          cursosWrapper.classList.toggle('d-none', !mostrar);
          if (!mostrar) {
            cursosAdicionados = 1;
            if (cursoCapacitacao) {
              cursoCapacitacao.value = '';
            }
            if (cursosExtras) {
              cursosExtras.innerHTML = '';
            }
            if (adicionarCursoBtn) {
              adicionarCursoBtn.disabled = false;
            }
          }
        };
        const interesseRadios = document.querySelectorAll('input[name="interesseCapacitacao"]');
        interesseRadios.forEach((radio) => {
          radio.addEventListener('change', () => {
            atualizarWrapperCursos(radio.value === 'Sim');
          });
        });
        if (adicionarCursoBtn && cursosExtras) {
          adicionarCursoBtn.addEventListener('click', () => {
            if (cursosAdicionados >= 3) {
              adicionarCursoBtn.disabled = true;
              return;
            }
            cursosAdicionados += 1;
            const novoInput = document.createElement('input');
            novoInput.type = 'text';
            novoInput.className = 'form-control';
            novoInput.name = 'cursos[]';
            cursosExtras.appendChild(novoInput);
            if (cursosAdicionados >= 3) {
              adicionarCursoBtn.disabled = true;
            }
          });
        }

        const preencherCursos = (valores = []) => {
          if (!cursosWrapper) return;
          const lista = Array.isArray(valores) ? valores : [valores];
          const cursosLimpos = lista
            .map((item) => (item == null ? '' : String(item).trim()))
            .filter(Boolean)
            .slice(0, 3);
          const mostrar = cursosLimpos.length > 0;
          const radioSim = document.querySelector('input[name="interesseCapacitacao"][value="Sim"]');
          const radioNao = document.querySelector('input[name="interesseCapacitacao"][value="N√£o"]');
          if (radioSim && radioNao) {
            if (mostrar) {
              radioSim.checked = true;
              radioSim.dispatchEvent(new Event('change', { bubbles: true }));
              radioNao.checked = false;
            } else {
              radioNao.checked = true;
              radioNao.dispatchEvent(new Event('change', { bubbles: true }));
              radioSim.checked = false;
            }
          } else {
            atualizarWrapperCursos(mostrar);
          }
          atualizarWrapperCursos(mostrar);
          if (!mostrar) {
            return;
          }

          if (cursosExtras) {
            cursosExtras.innerHTML = '';
          }
          cursosAdicionados = 1;
          if (adicionarCursoBtn) {
            adicionarCursoBtn.disabled = false;
          }
          if (cursoCapacitacao) {
            cursoCapacitacao.value = cursosLimpos[0] || '';
            cursoCapacitacao.dispatchEvent(new Event('input', { bubbles: true }));
            cursoCapacitacao.dispatchEvent(new Event('change', { bubbles: true }));
          }
          for (let i = 1; i < cursosLimpos.length; i += 1) {
            const novoInput = document.createElement('input');
            novoInput.type = 'text';
            novoInput.className = 'form-control';
            novoInput.name = 'cursos[]';
            novoInput.value = cursosLimpos[i];
            cursosExtras.appendChild(novoInput);
            novoInput.dispatchEvent(new Event('input', { bubbles: true }));
            novoInput.dispatchEvent(new Event('change', { bubbles: true }));
            cursosAdicionados += 1;
          }
          if (adicionarCursoBtn && cursosAdicionados >= 3) {
            adicionarCursoBtn.disabled = true;
          }
        };

        const familiaTabelaBody = document.getElementById('familiaTabelaBody');
        const familiaHiddenInputs = document.getElementById('familiaHiddenInputs');
        const familiaModalElement = document.getElementById('familiaModal');
        const familiaModalForm = document.getElementById('familiaModalForm');
        let familiaModalInstance = null;

        const ensureFamiliaModal = () => {
          if (!familiaModalElement || typeof bootstrap === 'undefined' || !bootstrap.Modal) {
            return null;
          }
          familiaModalInstance = bootstrap.Modal.getOrCreateInstance(familiaModalElement);
          return familiaModalInstance;
        };

        const restaurarTabelaFamilia = () => {
          if (familiaTabelaBody) {
            familiaTabelaBody.innerHTML = '';
            const vazio = document.createElement('tr');
            vazio.id = 'familiaVazia';
            const celula = document.createElement('td');
            celula.colSpan = 4;
            celula.className = 'text-center text-muted';
            celula.textContent = 'Nenhum membro informado.';
            vazio.appendChild(celula);
            familiaTabelaBody.appendChild(vazio);
          }
          if (familiaHiddenInputs) {
            familiaHiddenInputs.innerHTML = '';
          }
        };

        if (familiaModalElement && familiaModalForm) {
          const familiaDataNascimentoInput = familiaModalForm.querySelector('#familiaDataNascimento');
          const familiaIdadeAnosInput = familiaModalForm.querySelector('#familiaIdadeAnos');
          const familiaIdadeMesesInput = familiaModalForm.querySelector('#familiaIdadeMeses');

          const atualizarIdadeFamilia = () => {
            if (!familiaDataNascimentoInput || !familiaIdadeAnosInput) return;
            const valor = familiaDataNascimentoInput.value;
            if (!valor) {
              familiaIdadeAnosInput.value = '';
              if (familiaIdadeMesesInput) familiaIdadeMesesInput.value = '';
              return;
            }
            const nascimento = dayjs(valor);
            if (!nascimento.isValid()) {
              familiaIdadeAnosInput.value = '';
              if (familiaIdadeMesesInput) familiaIdadeMesesInput.value = '';
              return;
            }
            const agora = dayjs();
            const anos = agora.diff(nascimento, 'year');
            const mesesTotais = agora.diff(nascimento, 'month');
            const mesesRestantes = mesesTotais - anos * 12;
            familiaIdadeAnosInput.value = Number.isFinite(anos) ? String(anos) : '';
            if (familiaIdadeMesesInput) {
              familiaIdadeMesesInput.value = Number.isFinite(mesesRestantes)
                ? String(Math.min(11, Math.max(0, mesesRestantes)))
                : '';
            }
          };

          if (familiaDataNascimentoInput) {
            familiaDataNascimentoInput.addEventListener('input', atualizarIdadeFamilia);
            familiaDataNascimentoInput.addEventListener('change', atualizarIdadeFamilia);
            familiaDataNascimentoInput.addEventListener('blur', atualizarIdadeFamilia);
          }

          familiaModalForm.addEventListener('reset', () => {
            setTimeout(() => {
              if (familiaIdadeAnosInput) familiaIdadeAnosInput.value = '';
              if (familiaIdadeMesesInput) familiaIdadeMesesInput.value = '';
            }, 0);
          });

          familiaModalElement.addEventListener('show.bs.modal', () => {
            ensureFamiliaModal();
            atualizarIdadeFamilia();
          });

          familiaModalElement.addEventListener('hidden.bs.modal', () => {
            familiaModalForm.reset();
          });

          familiaModalForm.addEventListener('submit', (event) => {
            event.preventDefault();
            if (!familiaModalForm.checkValidity()) {
              familiaModalForm.reportValidity();
              return;
            }

            atualizarIdadeFamilia();
            const formData = new FormData(familiaModalForm);
            const dados = {
              nome: (formData.get('familiaNome') || '').toString().trim(),
              dataNascimento: (formData.get('familiaDataNascimento') || '').toString(),
              parentesco: (formData.get('familiaParentesco') || '').toString(),
              idadeAnos: (formData.get('familiaIdadeAnos') || '').toString(),
              idadeMeses: (formData.get('familiaIdadeMeses') || '').toString(),
              escolaridade: (formData.get('familiaEscolaridade') || '').toString(),
              redeEnsino: (formData.get('familiaRedeEnsino') || '').toString(),
              deficienciaMotora: (formData.get('familiaDeficienciaMotora') || '').toString(),
              deficienciaAuditiva: (formData.get('familiaDeficienciaAuditiva') || '').toString(),
              deficienciaVisual: (formData.get('familiaDeficienciaVisual') || '').toString(),
              deficienciaMental: (formData.get('familiaDeficienciaMental') || '').toString(),
              beneficiarioPrograma: (formData.get('familiaBeneficiarioPrograma') || '').toString(),
              beneficiarioBpc: (formData.get('familiaBeneficiarioBpc') || '').toString(),
            };

            if (familiaTabelaBody) {
              const vazio = document.getElementById('familiaVazia');
              if (vazio) {
                vazio.remove();
              }
              const linha = document.createElement('tr');
              const criarCelula = (valor) => {
                const cel = document.createElement('td');
                cel.textContent = valor;
                return cel;
              };
              linha.appendChild(criarCelula(dados.nome));
              linha.appendChild(criarCelula(dados.parentesco));
              linha.appendChild(criarCelula(dados.idadeAnos));
              linha.appendChild(criarCelula(dados.idadeMeses || '0'));
              familiaTabelaBody.appendChild(linha);
            }

            if (familiaHiddenInputs) {
              const wrapper = document.createElement('div');
              wrapper.className = 'familia-hidden-set';
              const adicionarHidden = (chave, valor) => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = `familia[${chave}][]`;
                input.value = valor || '';
                wrapper.appendChild(input);
              };
              adicionarHidden('nome', dados.nome);
              adicionarHidden('dataNascimento', dados.dataNascimento);
              adicionarHidden('parentesco', dados.parentesco);
              adicionarHidden('idadeAnos', dados.idadeAnos);
              adicionarHidden('idadeMeses', dados.idadeMeses || '0');
              adicionarHidden('escolaridade', dados.escolaridade);
              adicionarHidden('redeEnsino', dados.redeEnsino);
              adicionarHidden('deficienciaMotora', dados.deficienciaMotora);
              adicionarHidden('deficienciaAuditiva', dados.deficienciaAuditiva);
              adicionarHidden('deficienciaVisual', dados.deficienciaVisual);
              adicionarHidden('deficienciaMental', dados.deficienciaMental);
              adicionarHidden('beneficiarioPrograma', dados.beneficiarioPrograma);
              adicionarHidden('beneficiarioBpc', dados.beneficiarioBpc);
              familiaHiddenInputs.appendChild(wrapper);
            }

            const modalInstance = ensureFamiliaModal();
            if (modalInstance) {
              modalInstance.hide();
            }
            familiaModalForm.reset();
          });
        }

        const autorTabelaBody = document.getElementById('autorTabelaBody');
        const autorHiddenInputs = document.getElementById('autorHiddenInputs');
        const autorModalElement = document.getElementById('autorModal');
        const autorModalForm = document.getElementById('autorModalForm');
        let autorModalInstance = null;

        const ensureAutorModal = () => {
          if (!autorModalElement || typeof bootstrap === 'undefined' || !bootstrap.Modal) {
            return null;
          }
          autorModalInstance = bootstrap.Modal.getOrCreateInstance(autorModalElement);
          return autorModalInstance;
        };

        const restaurarTabelaAutores = () => {
          if (autorTabelaBody) {
            autorTabelaBody.innerHTML = '';
            const vazio = document.createElement('tr');
            vazio.id = 'autorVazio';
            const celula = document.createElement('td');
            celula.colSpan = 3;
            celula.className = 'text-center text-muted';
            celula.textContent = 'Nenhum autor(a) informado.';
            vazio.appendChild(celula);
            autorTabelaBody.appendChild(vazio);
          }
          if (autorHiddenInputs) {
            autorHiddenInputs.innerHTML = '';
          }
        };

        const atualizarCamposIdentidadeGeneroAutor = () => {
          const generoSelect = autorModalForm ? autorModalForm.querySelector('#autorGenero') : null;
          const identidadeGroup = autorModalForm ? autorModalForm.querySelector('#autorIdentidadeGeneroGroup') : null;
          const identidadeSelect = autorModalForm ? autorModalForm.querySelector('#autorIdentidadeGenero') : null;
          if (!generoSelect || !identidadeGroup) return;
          const mostrar = generoSelect.value === 'Outro' || generoSelect.value === 'Prefiro n√£o informar';
          identidadeGroup.classList.toggle('d-none', !mostrar);
          if (identidadeSelect) {
            identidadeSelect.toggleAttribute('required', mostrar);
            if (!mostrar) {
              resetSelect(identidadeSelect);
            }
          }
        };

        const atualizarCamposConjugeAutor = () => {
          const estadoCivilSelect = autorModalForm ? autorModalForm.querySelector('#autorEstadoCivil') : null;
          const conjugeGroup = autorModalForm ? autorModalForm.querySelector('#autorConjugeGroup') : null;
          const conjugeInput = autorModalForm ? autorModalForm.querySelector('#autorConjuge') : null;
          if (!estadoCivilSelect || !conjugeGroup) return;
          const valor = estadoCivilSelect.value;
          const mostrar = valor === 'Casado(a)' || valor === 'Uni√£o est√°vel';
          conjugeGroup.classList.toggle('d-none', !mostrar);
          if (conjugeInput) {
            conjugeInput.toggleAttribute('required', mostrar);
            if (!mostrar) {
              conjugeInput.value = '';
            }
          }
        };

        const atualizarCamposRgAutor = () => {
          if (!autorModalForm) return;
          const rgInput = autorModalForm.querySelector('#autorRg');
          const rgGroups = autorModalForm.querySelectorAll('.autor-rg-group');
          const mostrar = !!(rgInput && rgInput.value.trim());
          rgGroups.forEach((group) => {
            group.classList.toggle('d-none', !mostrar);
            const inputs = group.querySelectorAll('input, select');
            inputs.forEach((input) => {
              if (input instanceof HTMLSelectElement) {
                input.toggleAttribute('required', mostrar);
                if (!mostrar) {
                  resetSelect(input);
                }
              } else {
                input.toggleAttribute('required', mostrar);
                if (!mostrar) {
                  input.value = '';
                }
              }
            });
          });
        };

        const atualizarCamposNascimentoAutor = () => {
          if (!autorModalForm) return;
          const nacionalidadeSelect = autorModalForm.querySelector('#autorNacionalidade');
          const ufGroup = autorModalForm.querySelector('#autorUfNascimentoGroup');
          const cidadeGroup = autorModalForm.querySelector('#autorCidadeNascimentoGroup');
          const ufSelect = autorModalForm.querySelector('#autorUfNascimento');
          const cidadeSelect = autorModalForm.querySelector('#autorCidadeNascimento');
          const mostrar = nacionalidadeSelect && nacionalidadeSelect.value === 'Brasileiro(a)';
          if (ufGroup) ufGroup.classList.toggle('d-none', !mostrar);
          if (cidadeGroup) cidadeGroup.classList.toggle('d-none', !mostrar);
          if (ufSelect) ufSelect.toggleAttribute('required', mostrar);
          if (cidadeSelect) cidadeSelect.toggleAttribute('required', mostrar);
          if (!mostrar) {
            if (ufSelect) resetSelect(ufSelect);
            if (cidadeSelect) resetSelect(cidadeSelect);
          }
        };

        const atualizarCamposEscolaresAutor = () => {
          if (!autorModalForm) return;
          const grauSelect = autorModalForm.querySelector('#autorGrauEscolar');
          const situacaoGroup = autorModalForm.querySelector('#autorSituacaoEscolarGroup');
          const situacaoSelect = autorModalForm.querySelector('#autorSituacaoEscolar');
          const cursoGroup = autorModalForm.querySelector('#autorCursoFormacaoGroup');
          const cursoInput = autorModalForm.querySelector('#autorCursoFormacao');
          const posGroup = autorModalForm.querySelector('#autorTipoPosGraduacaoGroup');
          const posSelect = autorModalForm.querySelector('#autorTipoPosGraduacao');
          const anoGroup = autorModalForm.querySelector('#autorAnoPeriodoGroup');
          const anoInput = autorModalForm.querySelector('#autorAnoPeriodo');
          const valor = grauSelect ? grauSelect.value : '';
          const mostrarSituacao = valor && valor !== 'Sem instru√ß√£o';
          if (situacaoGroup) situacaoGroup.classList.toggle('d-none', !mostrarSituacao);
          if (situacaoSelect) {
            situacaoSelect.toggleAttribute('required', mostrarSituacao);
            if (!mostrarSituacao) resetSelect(situacaoSelect);
          }
          const cursosDetalhados = [
            'Curso t√©cnico',
            'Tecn√≥logo',
            'Ensino superior',
            'P√≥s-gradua√ß√£o',
            'Mestrado',
            'Doutorado',
          ];
          const mostrarCurso = cursosDetalhados.includes(valor);
          if (cursoGroup) cursoGroup.classList.toggle('d-none', !mostrarCurso);
          if (cursoInput) {
            cursoInput.toggleAttribute('required', mostrarCurso);
            if (!mostrarCurso) {
              cursoInput.value = '';
            }
          }
          const mostrarPos = valor === 'P√≥s-gradua√ß√£o';
          if (posGroup) posGroup.classList.toggle('d-none', !mostrarPos);
          if (posSelect) {
            posSelect.toggleAttribute('required', mostrarPos);
            if (!mostrarPos) {
              resetSelect(posSelect);
            }
          }
          const mostrarAno = mostrarSituacao;
          if (anoGroup) anoGroup.classList.toggle('d-none', !mostrarAno);
          if (anoInput) {
            anoInput.toggleAttribute('required', mostrarAno);
            if (!mostrarAno) {
              anoInput.value = '';
            }
          }
        };

        const atualizarCamposOcupacaoAutor = () => {
          if (!autorModalForm) return;
          const situacaoSelect = autorModalForm.querySelector('#autorSituacaoOcupacao');
          const ocupacaoGroup = autorModalForm.querySelector('#autorOcupacaoGroup');
          const ocupacaoInput = autorModalForm.querySelector('#autorOcupacao');
          const valor = situacaoSelect ? situacaoSelect.value : '';
          const exibirOcupacao = ['Empregado(a) com carteira', 'Empregado(a) sem carteira', 'Servidor(a) p√∫blico(a)', 'Aut√¥nomo(a)'].includes(valor);
          if (ocupacaoGroup) ocupacaoGroup.classList.toggle('d-none', !exibirOcupacao);
          if (ocupacaoInput) {
            ocupacaoInput.toggleAttribute('required', exibirOcupacao);
            if (!exibirOcupacao) {
              ocupacaoInput.value = '';
            }
          }
        };

        const atualizarCamposSegurancaAutor = () => {
          if (!autorModalForm) return;
          const radios = autorModalForm.querySelectorAll('input[name="autorSegurancaPublica"]');
          const detalhesGroup = autorModalForm.querySelector('#autorSegurancaDetalhes');
          const campos = detalhesGroup ? detalhesGroup.querySelectorAll('input') : [];
          const valor = Array.from(radios).find((radio) => radio.checked)?.value;
          const mostrar = valor === 'Sim';
          if (detalhesGroup) detalhesGroup.classList.toggle('d-none', !mostrar);
          campos.forEach((campo) => {
            campo.toggleAttribute('required', mostrar);
            if (!mostrar) {
              campo.value = '';
            }
          });
        };

        const atualizarCamposDrogasAutor = () => {
          if (!autorModalForm) return;
          const licitasOutraGroup = autorModalForm.querySelector('#autorDrogasLicitasOutraGroup');
          if (licitasOutraGroup) {
            const mostrarLicita = autorModalForm.querySelector('#autorDrogaLicitaOutra')?.checked;
            licitasOutraGroup.classList.toggle('d-none', !mostrarLicita);
            const input = autorModalForm.querySelector('#autorDrogasLicitasOutra');
            if (input) {
              input.toggleAttribute('required', mostrarLicita);
              if (!mostrarLicita) input.value = '';
            }
          }
          const ilicitasOutraGroup = autorModalForm.querySelector('#autorDrogasIlicitasOutraGroup');
          if (ilicitasOutraGroup) {
            const mostrarIlicita = autorModalForm.querySelector('#autorDrogaIlicitaOutra')?.checked;
            ilicitasOutraGroup.classList.toggle('d-none', !mostrarIlicita);
            const input = autorModalForm.querySelector('#autorDrogasIlicitasOutra');
            if (input) {
              input.toggleAttribute('required', mostrarIlicita);
              if (!mostrarIlicita) input.value = '';
            }
          }
        };

        const atualizarCamposArmaAutor = () => {
          if (!autorModalForm) return;
          const radios = autorModalForm.querySelectorAll('input[name="autorPossuiArma"]');
          const grupo = autorModalForm.querySelector('#autorTipoArmaGroup');
          const input = autorModalForm.querySelector('#autorTipoArma');
          const valor = Array.from(radios).find((radio) => radio.checked)?.value;
          const mostrar = valor === 'Sim';
          if (grupo) grupo.classList.toggle('d-none', !mostrar);
          if (input) {
            input.toggleAttribute('required', mostrar);
            if (!mostrar) input.value = '';
          }
        };

        const atualizarCamposCriminalidadeAutor = () => {
          if (!autorModalForm) return;
          const radios = autorModalForm.querySelectorAll('input[name="autorCriminalidade"]');
          const grupo = autorModalForm.querySelector('#autorCriminalidadeQualGroup');
          const input = autorModalForm.querySelector('#autorCriminalidadeQual');
          const valor = Array.from(radios).find((radio) => radio.checked)?.value;
          const mostrar = valor === 'Sim';
          if (grupo) grupo.classList.toggle('d-none', !mostrar);
          if (input) {
            input.toggleAttribute('required', mostrar);
            if (!mostrar) input.value = '';
          }
        };

        const atualizarCamposPassagemAutor = () => {
          if (!autorModalForm) return;
          const radios = autorModalForm.querySelectorAll('input[name="autorPassagemPolicia"]');
          const grupo = autorModalForm.querySelector('#autorPassagemDetalhes');
          const inputs = grupo ? grupo.querySelectorAll('input') : [];
          const valor = Array.from(radios).find((radio) => radio.checked)?.value;
          const mostrar = valor === 'Sim';
          if (grupo) grupo.classList.toggle('d-none', !mostrar);
          inputs.forEach((input) => {
            input.toggleAttribute('required', mostrar);
            if (!mostrar) input.value = '';
          });
        };

        const atualizarIdadeAutor = () => {
          if (!autorModalForm || !window.dayjs) return;
          const dataInput = autorModalForm.querySelector('#autorDataNascimento');
          const idadeInputAutor = autorModalForm.querySelector('#autorIdade');
          if (!dataInput || !idadeInputAutor) return;
          const valor = dataInput.value;
          if (!valor) {
            idadeInputAutor.value = '';
            return;
          }
          const data = dayjs(valor);
          if (!data.isValid()) {
            idadeInputAutor.value = '';
            return;
          }
          const idade = dayjs().diff(data, 'year');
          idadeInputAutor.value = Number.isFinite(idade) ? `${idade} anos` : '';
        };

        const copiarEnderecoPrincipalParaAutor = () => {
          if (!autorModalForm) return;
          const pares = [
            ['cep', 'autorCep'],
            ['logradouro', 'autorLogradouro'],
            ['numeroEndereco', 'autorNumero'],
            ['complementoEndereco', 'autorComplemento'],
            ['bairro', 'autorBairro'],
            ['cidade', 'autorCidade'],
            ['pontoReferencia', 'autorPontoReferencia'],
          ];
          pares.forEach(([origemId, destinoId]) => {
            const origem = document.getElementById(origemId);
            const destino = autorModalForm.querySelector(`#${destinoId}`);
            if (!origem || !destino) return;
            if (destino instanceof HTMLInputElement || destino instanceof HTMLTextAreaElement) {
              destino.value = origem.value || '';
            }
          });
          const telefonePrincipal = document.getElementById('telefone');
          const telefoneAlternativo = document.getElementById('telefoneSecundario');
          const autorCelular = autorModalForm.querySelector('#autorTelefoneCelular');
          const autorFixo = autorModalForm.querySelector('#autorTelefoneFixo');
          const emailPrincipal = document.getElementById('email');
          const autorEmail = autorModalForm.querySelector('#autorEmail');
          if (telefonePrincipal && autorCelular) {
            autorCelular.value = telefonePrincipal.value || '';
          }
          if (telefoneAlternativo && autorFixo) {
            autorFixo.value = telefoneAlternativo.value || '';
          }
          if (emailPrincipal && autorEmail) {
            autorEmail.value = emailPrincipal.value || '';
          }
          const ufOrigem = document.getElementById('uf');
          const ufDestino = autorModalForm.querySelector('#autorUf');
          if (ufOrigem && ufDestino instanceof HTMLSelectElement) {
            setSelectValue(ufDestino, ufOrigem.value || '');
          }
        };

        const atualizarEnderecoAutor = () => {
          if (!autorModalForm) return;
          const mesmoEndereco = autorModalForm.querySelector('#autorEnderecoIgual');
          const camposEndereco = autorModalForm.querySelector('#autorEnderecoCampos');
          const sincronizado = !!(mesmoEndereco && mesmoEndereco.checked);
          if (sincronizado) {
            copiarEnderecoPrincipalParaAutor();
          }
          if (camposEndereco) {
            camposEndereco.classList.toggle('is-synchronized', sincronizado);
          }
          const autorSemCepCheck = autorModalForm.querySelector('#autorSemCep');
          if (autorSemCepCheck) {
            if (sincronizado) {
              autorSemCepCheck.checked = false;
            }
            autorSemCepCheck.toggleAttribute('disabled', sincronizado);
          }
          if (sincronizado && enderecoAutor) {
            enderecoAutor.atualizarAjuda?.('');
          }
        };

        sincronizarEnderecoAutorSeMarcado = () => {
          if (!autorModalForm) return;
          const mesmoEndereco = autorModalForm.querySelector('#autorEnderecoIgual');
          if (mesmoEndereco && mesmoEndereco.checked) {
            copiarEnderecoPrincipalParaAutor();
          }
        };

        const atualizarCepAutor = () => {
          if (!autorModalForm) return;
          const naoSei = autorModalForm.querySelector('#autorSemCep');
          const cepInput = autorModalForm.querySelector('#autorCep');
          const logradouro = autorModalForm.querySelector('#autorLogradouro');
          const bairro = autorModalForm.querySelector('#autorBairro');
          const cidade = autorModalForm.querySelector('#autorCidade');
          const uf = autorModalForm.querySelector('#autorUf');
          const desabilitar = !!(naoSei && naoSei.checked);
          if (cepInput) {
            cepInput.toggleAttribute('disabled', desabilitar);
            if (desabilitar) {
              cepInput.value = '';
            }
          }
          if (desabilitar) {
            if (logradouro) logradouro.value = '';
            if (bairro) bairro.value = '';
            if (cidade) cidade.value = '';
            if (uf) resetSelect(uf);
            if (enderecoAutor) {
              enderecoAutor.atualizarAjuda?.('');
            }
          }
        };

        if (autorModalElement && autorModalForm) {
          autorModalElement.addEventListener('show.bs.modal', () => {
            ensureAutorModal();
            atualizarCamposRgAutor();
            atualizarCamposConjugeAutor();
            atualizarCamposIdentidadeGeneroAutor();
            atualizarCamposNascimentoAutor();
            atualizarCamposEscolaresAutor();
            atualizarCamposOcupacaoAutor();
            atualizarCamposSegurancaAutor();
            atualizarCamposDrogasAutor();
            atualizarCamposArmaAutor();
            atualizarCamposCriminalidadeAutor();
            atualizarCamposPassagemAutor();
            atualizarEnderecoAutor();
            atualizarCepAutor();
            atualizarIdadeAutor();
          });

          autorModalElement.addEventListener('hidden.bs.modal', () => {
            autorModalForm.reset();
            const selects = autorModalForm.querySelectorAll('select');
            selects.forEach((select) => resetSelect(select));
            atualizarCamposRgAutor();
            atualizarCamposConjugeAutor();
            atualizarCamposIdentidadeGeneroAutor();
            atualizarCamposNascimentoAutor();
            atualizarCamposEscolaresAutor();
            atualizarCamposOcupacaoAutor();
            atualizarCamposSegurancaAutor();
            atualizarCamposDrogasAutor();
            atualizarCamposArmaAutor();
            atualizarCamposCriminalidadeAutor();
            atualizarCamposPassagemAutor();
            atualizarEnderecoAutor();
            atualizarCepAutor();
            atualizarIdadeAutor();
          });

          autorModalForm.addEventListener('input', (event) => {
            const target = event.target;
            if (!(target instanceof HTMLElement)) return;
            if (target.id === 'autorRg') {
              atualizarCamposRgAutor();
            }
            if (target.id === 'autorDataNascimento') {
              atualizarIdadeAutor();
            }
          });

          const nacionalidadeSelect = autorModalForm.querySelector('#autorNacionalidade');
          if (nacionalidadeSelect) {
            nacionalidadeSelect.addEventListener('change', atualizarCamposNascimentoAutor);
          }
          const generoSelect = autorModalForm.querySelector('#autorGenero');
          if (generoSelect) {
            generoSelect.addEventListener('change', atualizarCamposIdentidadeGeneroAutor);
          }
          const estadoCivilSelect = autorModalForm.querySelector('#autorEstadoCivil');
          if (estadoCivilSelect) {
            estadoCivilSelect.addEventListener('change', atualizarCamposConjugeAutor);
          }
          const grauSelect = autorModalForm.querySelector('#autorGrauEscolar');
          if (grauSelect) {
            grauSelect.addEventListener('change', atualizarCamposEscolaresAutor);
          }
          const situacaoSelect = autorModalForm.querySelector('#autorSituacaoOcupacao');
          if (situacaoSelect) {
            situacaoSelect.addEventListener('change', atualizarCamposOcupacaoAutor);
          }
          autorModalForm.querySelectorAll('input[name="autorSegurancaPublica"]').forEach((radio) => {
            radio.addEventListener('change', atualizarCamposSegurancaAutor);
          });
          autorModalForm.querySelectorAll('#autorDrogasLicitasGroup input[type="checkbox"]').forEach((checkbox) => {
            checkbox.addEventListener('change', atualizarCamposDrogasAutor);
          });
          autorModalForm.querySelectorAll('#autorDrogasIlicitasGroup input[type="checkbox"]').forEach((checkbox) => {
            checkbox.addEventListener('change', atualizarCamposDrogasAutor);
          });
          autorModalForm.querySelectorAll('input[name="autorPossuiArma"]').forEach((radio) => {
            radio.addEventListener('change', atualizarCamposArmaAutor);
          });
          autorModalForm.querySelectorAll('input[name="autorCriminalidade"]').forEach((radio) => {
            radio.addEventListener('change', atualizarCamposCriminalidadeAutor);
          });
          autorModalForm.querySelectorAll('input[name="autorPassagemPolicia"]').forEach((radio) => {
            radio.addEventListener('change', atualizarCamposPassagemAutor);
          });
          const enderecoIgualCheck = autorModalForm.querySelector('#autorEnderecoIgual');
          if (enderecoIgualCheck) {
            enderecoIgualCheck.addEventListener('change', () => {
              atualizarEnderecoAutor();
              atualizarCepAutor();
            });
          }
          const autorSemCepCheck = autorModalForm.querySelector('#autorSemCep');
          if (autorSemCepCheck) {
            autorSemCepCheck.addEventListener('change', atualizarCepAutor);
          }
          const camposEnderecoPrincipal = [
            'cep',
            'logradouro',
            'numeroEndereco',
            'complementoEndereco',
            'bairro',
            'cidade',
            'pontoReferencia',
            'telefone',
            'telefoneSecundario',
            'email',
            'uf',
          ];
          camposEnderecoPrincipal.forEach((id) => {
            const campo = document.getElementById(id);
            if (!campo) return;
            campo.addEventListener('input', sincronizarEnderecoAutorSeMarcado);
            campo.addEventListener('change', sincronizarEnderecoAutorSeMarcado);
          });
          const autorDataNascimentoInput = autorModalForm.querySelector('#autorDataNascimento');
          if (autorDataNascimentoInput) {
            autorDataNascimentoInput.addEventListener('change', atualizarIdadeAutor);
            autorDataNascimentoInput.addEventListener('blur', atualizarIdadeAutor);
          }

          autorModalForm.addEventListener('submit', (event) => {
            event.preventDefault();
            if (!autorModalForm.checkValidity()) {
              autorModalForm.reportValidity();
              return;
            }

            atualizarIdadeAutor();
            const formData = new FormData(autorModalForm);
            const dados = Object.fromEntries(formData.entries());
            dados.drogasLicitas = formData.getAll('autorDrogasLicitas[]');
            dados.drogasIlicitas = formData.getAll('autorDrogasIlicitas[]');

            if (autorTabelaBody) {
              const vazio = document.getElementById('autorVazio');
              if (vazio) {
                vazio.remove();
              }
              const linha = document.createElement('tr');
              const criarCelula = (valor) => {
                const cel = document.createElement('td');
                cel.textContent = valor || '';
                return cel;
              };
              linha.appendChild(criarCelula(dados.autorCpf || ''));
              linha.appendChild(criarCelula(dados.autorNome || ''));
              linha.appendChild(criarCelula(dados.autorParentesco || ''));
              autorTabelaBody.appendChild(linha);
            }

            if (autorHiddenInputs) {
              const wrapper = document.createElement('div');
              wrapper.className = 'autor-hidden-set';
              const adicionarHidden = (chave, valor) => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = `autores[${chave}][]`;
                input.value = Array.isArray(valor) ? valor.join(', ') : valor || '';
                wrapper.appendChild(input);
              };
              Object.keys(dados).forEach((chave) => {
                adicionarHidden(chave, dados[chave]);
              });
              adicionarHidden('drogasLicitas', dados.drogasLicitas || []);
              adicionarHidden('drogasIlicitas', dados.drogasIlicitas || []);
              autorHiddenInputs.appendChild(wrapper);
            }

            const modalInstance = ensureAutorModal();
            if (modalInstance) {
              modalInstance.hide();
            }
          });
        }

        const evolucaoTabelaBody = document.getElementById('evolucaoTabelaBody');
        const evolucaoHiddenInputs = document.getElementById('evolucaoHiddenInputs');
        const evolucaoModalElement = document.getElementById('evolucaoModal');
        const evolucaoModalForm = document.getElementById('evolucaoModalForm');
        const evolucaoProfissionalPadrao = 'Equipe t√©cnica do CRCL';
        const evolucaoSetorPadrao = 'Centro de Refer√™ncia Clarice Lispector';
        let evolucoesProntuarioAtual = '';
        let evolucoesDadosAtuais = [];
        let evolucoesDadosOriginais = [];
        let evolucaoRequestToken = 0;

        const cloneEvolucoesLista = (lista = []) => lista.map((item) => ({ ...item }));

        const normalizarEvolucaoItem = (item = {}) => {
          const fonte = typeof item === 'object' && item !== null ? item : {};
          return {
            prontuario: fonte.prontuario || '',
            data: fonte.data || fonte.data_evolucao || fonte.dataEvolucao || '',
            setor: fonte.setor || fonte.unidade || fonte.unidade_atendimento || '',
            registro: fonte.registro || fonte.descricao || '',
            profissional: fonte.profissional || fonte.responsavel || '',
            identificador: fonte.identificador || fonte.id || '',
          };
        };

        const formatarDataEvolucao = (valor) => {
          if (!valor) return '';
          if (/^\d{4}-\d{2}-\d{2}$/.test(valor)) {
            return `${valor.slice(8, 10)}/${valor.slice(5, 7)}/${valor.slice(0, 4)}`;
          }
          if (/^\d{2}\/\d{2}\/\d{4}$/.test(valor)) {
            return valor;
          }
          if (window.dayjs) {
            const parsed = dayjs(valor);
            if (parsed.isValid()) {
              return parsed.format('DD/MM/YYYY');
            }
          }
          return valor;
        };

        const exibirMensagemEvolucoes = (mensagem, classe = 'text-muted') => {
          if (!evolucaoTabelaBody) return;
          evolucaoTabelaBody.innerHTML = '';
          const linha = document.createElement('tr');
          const celula = document.createElement('td');
          celula.colSpan = 5;
          celula.className = `text-center py-4 ${classe}`;
          celula.textContent = mensagem;
          linha.appendChild(celula);
          evolucaoTabelaBody.appendChild(linha);
        };

        const atualizarHiddenEvolucoes = (lista) => {
          if (!evolucaoHiddenInputs) return;
          evolucaoHiddenInputs.innerHTML = '';
          if (!lista.length) return;
          const fragment = document.createDocumentFragment();
          lista.forEach((item) => {
            const wrapper = document.createElement('div');
            const adicionarHidden = (name, value) => {
              const input = document.createElement('input');
              input.type = 'hidden';
              input.name = name;
              input.value = value;
              wrapper.appendChild(input);
            };
            adicionarHidden('evolucoes[data][]', item.data || '');
            adicionarHidden('evolucoes[setor][]', item.setor || '');
            adicionarHidden('evolucoes[descricao][]', item.registro || '');
            adicionarHidden('evolucoes[profissional][]', item.profissional || evolucaoProfissionalPadrao);
            adicionarHidden('evolucoes[identificador][]', item.identificador || '');
            fragment.appendChild(wrapper);
          });
          evolucaoHiddenInputs.appendChild(fragment);
        };

        const renderizarEvolucoesTabela = (lista) => {
          if (evolucaoTabelaBody) {
            evolucaoTabelaBody.innerHTML = '';
            if (!lista.length) {
              const vazio = document.createElement('tr');
              vazio.id = 'evolucaoVazia';
              const celula = document.createElement('td');
              celula.colSpan = 5;
              celula.className = 'text-center text-muted py-4';
              celula.textContent = 'Nenhuma evolu√ß√£o registrada.';
              vazio.appendChild(celula);
              evolucaoTabelaBody.appendChild(vazio);
            } else {
              const fragmento = document.createDocumentFragment();
              lista.forEach((item) => {
                const linha = document.createElement('tr');

                const dataCell = document.createElement('td');
                dataCell.textContent = formatarDataEvolucao(item.data);
                linha.appendChild(dataCell);

                const setorCell = document.createElement('td');
                setorCell.textContent = item.setor || '‚Äî';
                linha.appendChild(setorCell);

                const registroCell = document.createElement('td');
                registroCell.classList.add('text-pre-wrap');
                registroCell.textContent = item.registro || '';
                linha.appendChild(registroCell);

                const profissionalCell = document.createElement('td');
                profissionalCell.textContent = item.profissional || evolucaoProfissionalPadrao;
                linha.appendChild(profissionalCell);

                const identificadorCell = document.createElement('td');
                identificadorCell.classList.add('d-none');
                identificadorCell.textContent = item.identificador || '';
                linha.appendChild(identificadorCell);

                fragmento.appendChild(linha);
              });
              evolucaoTabelaBody.appendChild(fragmento);
            }
          }
          atualizarHiddenEvolucoes(lista);
        };

        const setEvolucoesDados = (lista, prontuario, { setOriginal = false } = {}) => {
          const normalizados = Array.isArray(lista) ? lista.map(normalizarEvolucaoItem) : [];
          evolucoesProntuarioAtual = prontuario || '';
          evolucoesDadosAtuais = cloneEvolucoesLista(normalizados);
          if (setOriginal) {
            evolucoesDadosOriginais = cloneEvolucoesLista(normalizados);
          }
          renderizarEvolucoesTabela(evolucoesDadosAtuais);
        };

        const restaurarTabelaEvolucoes = () => {
          renderizarEvolucoesTabela(evolucoesDadosAtuais);
        };

        const carregarEvolucoesDoProntuario = async (prontuario) => {
          if (!prontuario) {
            setEvolucoesDados([], '', { setOriginal: true });
            return [];
          }
          const requestId = ++evolucaoRequestToken;
          exibirMensagemEvolucoes('Carregando evolu√ß√µes...', 'text-muted');
          try {
            const resposta = await fetch('https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/evolucoes', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ prontuario }),
            });
            if (!resposta.ok) {
              throw new Error('Falha ao buscar evolu√ß√µes.');
            }
            const dados = await resposta.json();
            if (requestId !== evolucaoRequestToken) {
              return [];
            }
            const lista = Array.isArray(dados) ? dados : [];
            setEvolucoesDados(lista, prontuario, { setOriginal: true });
            return lista;
          } catch (error) {
            console.error(error);
            if (requestId !== evolucaoRequestToken) {
              return [];
            }
            setEvolucoesDados([], prontuario, { setOriginal: true });
            exibirMensagemEvolucoes('N√£o foi poss√≠vel carregar as evolu√ß√µes.', 'text-danger');
            return [];
          }
        };

        if (evolucaoModalElement && evolucaoModalForm) {
          const evolucaoDataInput = evolucaoModalForm.querySelector('#evolucaoData');
          const evolucaoDescricaoInput = evolucaoModalForm.querySelector('#evolucaoDescricao');
          const obterModal = () =>
            typeof bootstrap !== 'undefined' ? bootstrap.Modal.getOrCreateInstance(evolucaoModalElement) : null;
          const atualizarDataEvolucao = () => {
            if (!evolucaoDataInput) return;
            if (window.dayjs) {
              evolucaoDataInput.value = dayjs().format('YYYY-MM-DD');
            } else {
              const hoje = new Date();
              const pad = (num) => String(num).padStart(2, '0');
              evolucaoDataInput.value = `${hoje.getFullYear()}-${pad(hoje.getMonth() + 1)}-${pad(hoje.getDate())}`;
            }
          };

          evolucaoModalElement.addEventListener('show.bs.modal', () => {
            atualizarDataEvolucao();
            if (evolucaoDescricaoInput) {
              setTimeout(() => evolucaoDescricaoInput.focus({ preventScroll: true }), 150);
            }
          });

          evolucaoModalElement.addEventListener('hidden.bs.modal', () => {
            evolucaoModalForm.reset();
          });

          evolucaoModalForm.addEventListener('submit', (event) => {
            event.preventDefault();
            if (!evolucaoModalForm.checkValidity()) {
              evolucaoModalForm.reportValidity();
              return;
            }
            atualizarDataEvolucao();
            const dataValor = evolucaoDataInput ? evolucaoDataInput.value : '';
            const descricaoValor = evolucaoDescricaoInput ? evolucaoDescricaoInput.value.trim() : '';
            if (!descricaoValor) {
              evolucaoModalForm.reportValidity();
              return;
            }

            const novaLista = cloneEvolucoesLista(evolucoesDadosAtuais);
            novaLista.push({
              prontuario: evolucoesProntuarioAtual,
              data: dataValor,
              setor: evolucaoSetorPadrao,
              registro: descricaoValor,
              profissional: evolucaoProfissionalPadrao,
              identificador: '',
            });
            setEvolucoesDados(novaLista, evolucoesProntuarioAtual);
            updateDirtyState();

            const modal = obterModal();
            if (modal) {
              modal.hide();
            }
          });
        }

        const anexoTabelaBody = document.getElementById('anexoTabelaBody');
        const anexoHiddenInputs = document.getElementById('anexoHiddenInputs');
        const anexoModalElement = document.getElementById('anexoModal');
        const anexoModalForm = document.getElementById('anexoModalForm');
        const anexoModalFeedback = document.getElementById('anexoModalFeedback');
        const visualizarAnexoModalElement = document.getElementById('visualizarAnexoModal');
        const visualizarAnexoDescricao = document.getElementById('visualizarAnexoDescricao');
        const visualizarAnexoFrame = document.getElementById('visualizarAnexoFrame');
        const visualizarAnexoSemPreview = document.getElementById('visualizarAnexoSemPreview');
        const downloadAnexoBtn = document.getElementById('downloadAnexoBtn');
        const anexosRegistros = [];
        let anexosDadosAtuais = [];
        let anexosDadosOriginais = [];
        let anexosProntuarioAtual = '';
        let anexoRequestToken = 0;

        const limparAnexosRegistros = () => {
          while (anexosRegistros.length) {
            const registro = anexosRegistros.pop();
            if (registro && registro.url && typeof URL !== 'undefined' && typeof URL.revokeObjectURL === 'function') {
              URL.revokeObjectURL(registro.url);
            }
          }
        };

        const cloneAnexosLista = (lista) =>
          Array.isArray(lista)
            ? lista.map((item) =>
                item && typeof item === 'object'
                  ? {
                      ...item,
                    }
                  : null,
              ).filter(Boolean)
            : [];

        const normalizarAnexoItem = (item, index = 0) => {
          if (!item || typeof item !== 'object') {
            return null;
          }
          const dataValor =
            item.data || item.dataArquivo || item.data_arquivo || item.data_envio || item.created_at || item.criadoEm || '';
          const descricaoValor =
            item.descricao || item.description || item.nome || item.nomeArquivo || item.nome_arquivo || `Anexo ${index + 1}`;
          const extensao = item.extensao || item.extension || '';
          let nomeValor =
            item.nome || item.nomeArquivo || item.nome_arquivo || item.filename || item.file_name || item.originalname || '';
          let contentType = item.contentType || item.content_type || item.mimetype || item.mimeType || '';
          const arquivoBruto = item.arquivo || item.file || item.binario || item.binary || item.payload || item.conteudo;
          let blob = item.blob instanceof Blob ? item.blob : null;
          let url = typeof item.url === 'string' ? item.url : '';

          if (!nomeValor) {
            const baseDescricao = (descricaoValor || '').toString().replace(/[\r\n]+/g, ' ').trim();
            const base = baseDescricao ? baseDescricao.replace(/[^\p{L}\p{N}\-_. ]/gu, '').replace(/\s+/g, '-') : '';
            const fallbackBase = base || `anexo-${index + 1}`;
            const fallbackExtensao = extensao ? extensao.replace(/^\./, '') : '';
            nomeValor = fallbackExtensao ? `${fallbackBase}.${fallbackExtensao}` : `${fallbackBase}.bin`;
          }

          if (!url) {
            if (arquivoBruto instanceof Blob) {
              blob = arquivoBruto;
              if (!contentType && arquivoBruto.type) {
                contentType = arquivoBruto.type;
              }
            } else if (typeof arquivoBruto === 'string' && arquivoBruto.trim()) {
              let base64 = arquivoBruto.trim();
              let mimeFromDataUrl = '';
              const dataUrlMatch = base64.match(/^data:(.+?);base64,(.+)$/);
              if (dataUrlMatch) {
                mimeFromDataUrl = dataUrlMatch[1];
                base64 = dataUrlMatch[2];
              }
              base64 = base64.replace(/\s/g, '');
              try {
                const byteString = atob(base64);
                const byteArray = new Uint8Array(byteString.length);
                for (let i = 0; i < byteString.length; i += 1) {
                  byteArray[i] = byteString.charCodeAt(i);
                }
                const tipo = mimeFromDataUrl || contentType || 'application/octet-stream';
                blob = new Blob([byteArray], { type: tipo });
                contentType = tipo;
              } catch (error) {
                console.error('Falha ao decodificar o anexo recebido.', error);
              }
            }
          }

          return {
            data: dataValor || '',
            descricao: descricaoValor || '',
            nome: nomeValor || `anexo-${index + 1}.bin`,
            blob,
            url,
            contentType: contentType || (blob && blob.type) || '',
            prontuario: item.prontuario || '',
          };
        };

        const formatarDataAnexo = (valor) => {
          if (!valor) return '‚Äî';
          if (window.dayjs) {
            const data = dayjs(valor);
            if (data.isValid()) {
              return data.format('DD/MM/YYYY');
            }
          }
          const isoMatch = valor.match(/^(\d{4})-(\d{2})-(\d{2})$/);
          if (isoMatch) {
            return `${isoMatch[3]}/${isoMatch[2]}/${isoMatch[1]}`;
          }
          return valor;
        };

        const ensureAnexoUrl = (registro) => {
          if (!registro) return '';
          if (registro.url && typeof registro.url === 'string') {
            return registro.url;
          }
          if (registro.blob && typeof URL !== 'undefined' && typeof URL.createObjectURL === 'function') {
            registro.url = URL.createObjectURL(registro.blob);
            return registro.url;
          }
          return '';
        };

        const renderizarTabelaAnexos = (lista) => {
          limparAnexosRegistros();
          if (anexoTabelaBody) {
            anexoTabelaBody.innerHTML = '';
          }
          if (anexoHiddenInputs) {
            anexoHiddenInputs.innerHTML = '';
          }
          const dados = Array.isArray(lista) ? lista : [];
          if (!dados.length) {
            if (anexoTabelaBody) {
              const vazio = document.createElement('tr');
              vazio.id = 'anexoVazio';
              const celula = document.createElement('td');
              celula.colSpan = 4;
              celula.className = 'text-center text-muted';
              celula.textContent = 'Nenhum arquivo anexado.';
              vazio.appendChild(celula);
              anexoTabelaBody.appendChild(vazio);
            }
            return;
          }

          const fragLinhas = document.createDocumentFragment();
          const fragHidden = document.createDocumentFragment();
          dados.forEach((item, index) => {
            const registro = item && typeof item === 'object' ? { ...item } : null;
            if (!registro) return;
            ensureAnexoUrl(registro);
            const registroIndex = anexosRegistros.push(registro) - 1;

            const linha = document.createElement('tr');

            const dataTd = document.createElement('td');
            dataTd.textContent = formatarDataAnexo(registro.data);
            linha.appendChild(dataTd);

            const descricaoTd = document.createElement('td');
            descricaoTd.textContent = registro.descricao || '';
            linha.appendChild(descricaoTd);

            const arquivoTd = document.createElement('td');
            arquivoTd.textContent = registro.nome || '';
            linha.appendChild(arquivoTd);

            const acoesTd = document.createElement('td');
            acoesTd.className = 'text-center';
            const botao = document.createElement('button');
            botao.type = 'button';
            botao.className = 'btn btn-sm btn-outline-primary';
            botao.setAttribute('data-visualizar-anexo', String(registroIndex));
            botao.title = 'Visualizar anexo';
            const icone = document.createElement('i');
            icone.className = 'bi bi-eye';
            botao.appendChild(icone);
            const srText = document.createElement('span');
            srText.className = 'visually-hidden';
            srText.textContent = `Visualizar ${registro.nome || 'anexo'}`;
            botao.appendChild(srText);
            acoesTd.appendChild(botao);
            linha.appendChild(acoesTd);

            fragLinhas.appendChild(linha);

            if (anexoHiddenInputs) {
              const wrapper = document.createElement('div');
              const adicionarHidden = (name, value) => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = name;
                input.value = value;
                wrapper.appendChild(input);
              };
              adicionarHidden('anexos[data][]', registro.data || '');
              adicionarHidden('anexos[descricao][]', registro.descricao || '');
              adicionarHidden('anexos[arquivo][]', registro.nome || '');
              fragHidden.appendChild(wrapper);
            }
          });

          if (anexoTabelaBody) {
            anexoTabelaBody.appendChild(fragLinhas);
          }
          if (anexoHiddenInputs) {
            anexoHiddenInputs.appendChild(fragHidden);
          }
        };

        const setAnexosDados = (lista, prontuario, { setOriginal = false } = {}) => {
          const normalizados = Array.isArray(lista)
            ? lista
                .map((item, index) => normalizarAnexoItem(item, index))
                .filter((item) => item)
            : [];
          anexosProntuarioAtual = prontuario || '';
          anexosDadosAtuais = cloneAnexosLista(normalizados);
          if (setOriginal) {
            anexosDadosOriginais = cloneAnexosLista(normalizados);
          }
          renderizarTabelaAnexos(anexosDadosAtuais);
        };

        const restaurarTabelaAnexos = () => {
          renderizarTabelaAnexos(anexosDadosAtuais);
        };

        const carregarAnexosDoProntuario = async (prontuario) => {
          const codigo = typeof prontuario === 'string' ? prontuario.trim() : prontuario;
          if (!codigo) {
            setAnexosDados([], '', { setOriginal: true });
            return [];
          }
          const requestId = ++anexoRequestToken;
          try {
            const resposta = await fetch(
              'https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/recupera-arquivos',
              {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prontuario: codigo }),
              },
            );
            if (!resposta.ok) {
              throw new Error('Falha ao recuperar anexos.');
            }
            const dados = await resposta.json();
            if (requestId !== anexoRequestToken) {
              return [];
            }
            let lista = [];
            if (Array.isArray(dados)) {
              lista = dados;
            } else if (dados && typeof dados === 'object') {
              if (Array.isArray(dados.data)) {
                lista = dados.data;
              } else if (Array.isArray(dados.arquivos)) {
                lista = dados.arquivos;
              } else if (Array.isArray(dados.registros)) {
                lista = dados.registros;
              }
            }
            setAnexosDados(lista, codigo, { setOriginal: true });
            return lista;
          } catch (error) {
            console.error(error);
            if (requestId !== anexoRequestToken) {
              return [];
            }
            setAnexosDados([], codigo, { setOriginal: true });
            return [];
          }
        };

        const setAnexoModalFeedback = (message = '', type = 'info') => {
          if (!anexoModalFeedback) return;
          if (!message) {
            anexoModalFeedback.textContent = '';
            anexoModalFeedback.className = 'alert d-none mb-3';
            return;
          }
          anexoModalFeedback.textContent = message;
          anexoModalFeedback.className = `alert alert-${type} mb-3`;
        };

        if (anexoModalElement && anexoModalForm) {
          const anexoDataInput = anexoModalForm.querySelector('#anexoData');
          const anexoDescricaoInput = anexoModalForm.querySelector('#anexoDescricao');
          const anexoArquivoInput = anexoModalForm.querySelector('#anexoArquivo');
          const obterAnexoModal = () =>
            typeof bootstrap !== 'undefined' ? bootstrap.Modal.getOrCreateInstance(anexoModalElement) : null;
          const atualizarDataAnexo = () => {
            if (!anexoDataInput) return;
            if (window.dayjs) {
              anexoDataInput.value = dayjs().format('YYYY-MM-DD');
            } else {
              const hoje = new Date();
              const pad = (num) => String(num).padStart(2, '0');
              anexoDataInput.value = `${hoje.getFullYear()}-${pad(hoje.getMonth() + 1)}-${pad(hoje.getDate())}`;
            }
          };

          anexoModalElement.addEventListener('show.bs.modal', () => {
            atualizarDataAnexo();
            setAnexoModalFeedback();
            if (anexoDescricaoInput) {
              setTimeout(() => anexoDescricaoInput.focus({ preventScroll: true }), 150);
            }
          });

          anexoModalElement.addEventListener('hidden.bs.modal', () => {
            anexoModalForm.reset();
            setAnexoModalFeedback();
          });

          anexoModalForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            if (!anexoModalForm.checkValidity()) {
              anexoModalForm.reportValidity();
              return;
            }
            atualizarDataAnexo();
            const dataValor = anexoDataInput ? anexoDataInput.value : '';
            const descricaoValor = anexoDescricaoInput ? anexoDescricaoInput.value.trim() : '';
            const arquivo = anexoArquivoInput && anexoArquivoInput.files ? anexoArquivoInput.files[0] : null;
            const nomeArquivo = arquivo ? arquivo.name : '';
            if (!nomeArquivo) {
              anexoModalForm.reportValidity();
              return;
            }
            const prontuarioInputEl =
              numeroProntuarioInput || document.getElementById('numeroProntuario');
            const prontuarioDisplayEl =
              numeroProntuarioDisplay || document.getElementById('numeroProntuarioDisplay');
            const displayValor =
              prontuarioDisplayEl && prontuarioDisplayEl.textContent
                ? prontuarioDisplayEl.textContent.trim()
                : '';
            const prontuarioAtual =
              (prontuarioInputEl && prontuarioInputEl.value.trim()) ||
              (displayValor && displayValor !== '‚Äî' ? displayValor : '') ||
              anexosProntuarioAtual;
            if (!prontuarioAtual) {
              setAnexoModalFeedback('Informe o n√∫mero do prontu√°rio antes de enviar um anexo.', 'warning');
              return;
            }
            const submitBtn = anexoModalForm.querySelector('button[type="submit"]');
            const originalSubmitHtml = submitBtn ? submitBtn.innerHTML : '';
            const toggleSubmitting = (submitting) => {
              if (!submitBtn) return;
              submitBtn.disabled = submitting;
              submitBtn.innerHTML = submitting
                ? '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Enviando...'
                : originalSubmitHtml;
            };
            toggleSubmitting(true);
            setAnexoModalFeedback('Enviando anexo...', 'info');
            const uploadData = new FormData();
            uploadData.append('prontuario', prontuarioAtual);
            uploadData.append('descricao', descricaoValor);
            if (arquivo) {
              uploadData.append('file', arquivo);
            }
            try {
              const resposta = await fetch(
                'https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/recebe-arquivo',
                {
                  method: 'POST',
                  body: uploadData,
                },
              );
              if (!resposta.ok) {
                throw new Error(`Falha ao enviar anexo: ${resposta.status}`);
              }
            } catch (error) {
              console.error(error);
              setAnexoModalFeedback('N√£o foi poss√≠vel enviar o anexo. Tente novamente.', 'danger');
              toggleSubmitting(false);
              return;
            }
            toggleSubmitting(false);
            setAnexoModalFeedback();
            const novoRegistro = normalizarAnexoItem(
              {
                data: dataValor,
                descricao: descricaoValor,
                arquivo,
                nome: nomeArquivo,
                contentType: arquivo ? arquivo.type : '',
                prontuario: prontuarioAtual,
              },
              anexosDadosAtuais.length,
            );
            if (novoRegistro) {
              const novaLista = cloneAnexosLista(anexosDadosAtuais);
              novaLista.push(novoRegistro);
              setAnexosDados(novaLista, prontuarioAtual);
            }
            if (anexoArquivoInput) {
              anexoArquivoInput.value = '';
            }
            const modal = obterAnexoModal();
            if (modal) {
              modal.hide();
            }
          });
        }

        const obterVisualizarAnexoModal = () =>
          visualizarAnexoModalElement && typeof bootstrap !== 'undefined'
            ? bootstrap.Modal.getOrCreateInstance(visualizarAnexoModalElement)
            : null;

        if (visualizarAnexoModalElement) {
          visualizarAnexoModalElement.addEventListener('hidden.bs.modal', () => {
            if (visualizarAnexoFrame) {
              visualizarAnexoFrame.classList.add('d-none');
              visualizarAnexoFrame.src = '';
            }
            if (visualizarAnexoSemPreview) {
              visualizarAnexoSemPreview.classList.remove('d-none');
              visualizarAnexoSemPreview.textContent =
                'Pr√©-visualiza√ß√£o n√£o dispon√≠vel para este arquivo. Utilize o download para acessar o conte√∫do.';
            }
            if (visualizarAnexoDescricao) {
              visualizarAnexoDescricao.textContent = '';
            }
            if (downloadAnexoBtn) {
              downloadAnexoBtn.href = '#';
              downloadAnexoBtn.removeAttribute('download');
              downloadAnexoBtn.classList.add('disabled');
              downloadAnexoBtn.setAttribute('aria-disabled', 'true');
            }
          });
        }

        if (anexoTabelaBody) {
          anexoTabelaBody.addEventListener('click', (event) => {
            const target = event.target instanceof HTMLElement ? event.target.closest('[data-visualizar-anexo]') : null;
            if (!target) return;
            event.preventDefault();
            const indice = Number.parseInt(target.getAttribute('data-visualizar-anexo') || '', 10);
            const registro = Number.isNaN(indice) ? null : anexosRegistros[indice];
            if (!registro) return;
            const modal = obterVisualizarAnexoModal();
            const descricaoTexto = registro.descricao || registro.nome || 'Anexo';
            if (visualizarAnexoDescricao) {
              visualizarAnexoDescricao.textContent = descricaoTexto;
            }
            let temPreview = false;
            if (visualizarAnexoFrame) {
              if (registro.url) {
                visualizarAnexoFrame.src = registro.url;
                visualizarAnexoFrame.classList.remove('d-none');
                temPreview = true;
              } else {
                visualizarAnexoFrame.classList.add('d-none');
                visualizarAnexoFrame.src = '';
              }
            }
            if (visualizarAnexoSemPreview) {
              visualizarAnexoSemPreview.classList.toggle('d-none', temPreview);
              if (!temPreview) {
                const nome = registro.nome ? ` ${registro.nome}` : '';
                visualizarAnexoSemPreview.textContent = `Pr√©-visualiza√ß√£o n√£o dispon√≠vel. Baixe o arquivo${nome}.`;
              } else {
                visualizarAnexoSemPreview.textContent =
                  'Pr√©-visualiza√ß√£o n√£o dispon√≠vel para este arquivo. Utilize o download para acessar o conte√∫do.';
              }
            }
            if (downloadAnexoBtn) {
              if (registro.url) {
                downloadAnexoBtn.href = registro.url;
                downloadAnexoBtn.download = registro.nome || '';
                downloadAnexoBtn.classList.remove('disabled');
                downloadAnexoBtn.removeAttribute('aria-disabled');
              } else {
                downloadAnexoBtn.href = '#';
                downloadAnexoBtn.removeAttribute('download');
                downloadAnexoBtn.classList.add('disabled');
                downloadAnexoBtn.setAttribute('aria-disabled', 'true');
              }
            }
            if (modal) {
              if (
                window.modalStackManager &&
                typeof window.modalStackManager.prepareForNestedModal === 'function'
              ) {
                window.modalStackManager.prepareForNestedModal(target, visualizarAnexoModalElement);
              }
              modal.show(target);
            }
          });
        }

        restaurarTabelaEvolucoes();
        restaurarTabelaAnexos();

        const numeroProntuarioInput = document.getElementById('numeroProntuario');
        const numeroProntuarioDisplay = document.getElementById('numeroProntuarioDisplay');
        const dataAtendimentoInput = document.getElementById('dataAtendimento');
        const horaAtendimentoInput = document.getElementById('horaAtendimento');
        const setCurrentDateTime = () => {
          const agora = new Date();
          const pad = (num) => String(num).padStart(2, '0');
          const dataValor = `${pad(agora.getDate())}/${pad(agora.getMonth() + 1)}/${agora.getFullYear()}`;
          const horaValor = `${pad(agora.getHours())}:${pad(agora.getMinutes())}`;
          if (numeroProntuarioInput) {
            const dataStamp = `${agora.getFullYear()}${pad(agora.getMonth() + 1)}${pad(agora.getDate())}`;
            const horaStamp = `${pad(agora.getHours())}${pad(agora.getMinutes())}`;
            numeroProntuarioInput.value = `PR-${dataStamp}-${horaStamp}`;
            if (numeroProntuarioDisplay) {
              numeroProntuarioDisplay.textContent = numeroProntuarioInput.value;
            }
          } else if (numeroProntuarioDisplay) {
            numeroProntuarioDisplay.textContent = '‚Äî';
          }
          if (dataAtendimentoInput) {
            dataAtendimentoInput.value = dataValor;
          }
          if (horaAtendimentoInput) {
            horaAtendimentoInput.value = horaValor;
          }
        };

        const maskConfig = [
          { selector: '#cpfUsuario', mask: '000.000.000-00' },
          { selector: '#autorCpf', mask: '000.000.000-00' },
          { selector: '#cep', mask: '00000-000' },
          { selector: '#autorCep', mask: '00000-000' },
          { selector: '#telefone', mask: '(00) 00000-0000' },
          { selector: '#telefoneSecundario', mask: '(00) 00000-0000' },
          { selector: '#conhecimentoTelefone', mask: '(00) 00000-0000' },
          { selector: '#autorTelefoneFixo', mask: '(00) 0000-0000' },
          { selector: '#autorTelefoneCelular', mask: '(00) 00000-0000' },
          { selector: '#autorTelefoneTrabalho', mask: '(00) 0000-0000' },
          { selector: '#dataAtendimento', mask: '00/00/0000' },
          { selector: '#horaAtendimento', mask: '00:00' },
          { selector: '#dataNascimento', mask: '00/00/0000' },
          { selector: '#dataOcorrencia', mask: '00/00/0000' },
        ];

        maskConfig.forEach(({ selector, mask }) => {
          const element = document.querySelector(selector);
          if (element && window.IMask) {
            IMask(element, { mask });
          }
        });

        const rendaField = document.getElementById('rendaIndividual');
        if (rendaField && window.IMask) {
          IMask(rendaField, {
            mask: Number,
            scale: 2,
            thousandsSeparator: '.',
            padFractionalZeros: true,
            radix: ',',
            mapToRadix: ['.'],
            min: 0,
          });
        }

        const valorFiancaField = document.getElementById('valorFianca');
        if (valorFiancaField && window.IMask) {
          IMask(valorFiancaField, {
            mask: Number,
            scale: 2,
            thousandsSeparator: '.',
            padFractionalZeros: true,
            radix: ',',
            mapToRadix: ['.'],
            min: 0,
          });
        }

        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.forEach((tooltipTriggerEl) => {
          new bootstrap.Tooltip(tooltipTriggerEl);
        });

        if (window.JustValidate) {
          const validator = new JustValidate('#registroForm', {
            errorFieldCssClass: 'is-invalid',
            focusInvalidField: true,
            lockForm: true,
            tooltip: {
              position: 'top',
            },
          });

          validator
            .addField('#numeroProntuario', [{ rule: 'required', errorMessage: 'Informe o n√∫mero do prontu√°rio.' }])
            .addField('#unidadeAtendimento', [{ rule: 'required', errorMessage: 'Selecione a unidade.' }])
            .addField('#dataAtendimento', [{ rule: 'required', errorMessage: 'Informe a data do atendimento.' }])
            .addField('#horaAtendimento', [{ rule: 'required', errorMessage: 'Informe a hora do atendimento.' }])
            .addField('#nomeUsuario', [{ rule: 'required', errorMessage: 'Informe o nome completo.' }])
            .addField('#cpfUsuario', [{ rule: 'required', errorMessage: 'Informe o CPF.' }])
            .addField('#dataNascimento', [{ rule: 'required', errorMessage: 'Informe a data de nascimento.' }])
            .addField('#cep', [{ rule: 'required', errorMessage: 'Informe o CEP.' }])
            .addField('#logradouro', [{ rule: 'required', errorMessage: 'Informe o logradouro.' }])
            .addField('#bairro', [{ rule: 'required', errorMessage: 'Informe o bairro.' }])
            .addField('#cidade', [{ rule: 'required', errorMessage: 'Informe a cidade.' }])
            .addField('#uf', [{ rule: 'required', errorMessage: 'Informe a UF.' }])
            .addRequiredGroup('input[name="deficienciaSindrome"]', 'Informe se h√° defici√™ncia ou s√≠ndrome.')
            .addField('#deficienciaQual', [
              {
                rule: 'function',
                errorMessage: 'Selecione a defici√™ncia.',
                validator: () => {
                  if (getCheckedValue('deficienciaSindrome') !== 'Sim') return true;
                  const select = document.getElementById('deficienciaQual');
                  return select ? select.value.trim().length > 0 : true;
                },
              },
            ])
            .addField('#deficienciaViolenciaSim', [
              {
                rule: 'function',
                errorMessage: 'Informe se a defici√™ncia decorre da viol√™ncia.',
                validator: () => {
                  if (getCheckedValue('deficienciaSindrome') !== 'Sim') return true;
                  return document.querySelector('input[name="deficienciaViolencia"]:checked') !== null;
                },
              },
            ])
            .addRequiredGroup('input[name="problemaSaude"]', 'Informe se apresenta problema de sa√∫de.')
            .addField('#problemaSaudeQual', [
              {
                rule: 'function',
                errorMessage: 'Descreva o problema de sa√∫de.',
                validator: () => {
                  if (getCheckedValue('problemaSaude') !== 'Sim') return true;
                  const input = document.getElementById('problemaSaudeQual');
                  return input ? input.value.trim().length > 0 : true;
                },
              },
            ])
            .addRequiredGroup('input[name="atendimentoPsicologo"]', 'Informe se houve atendimento psicol√≥gico.')
            .addField('#tempoPsicologo', [
              {
                rule: 'function',
                errorMessage: 'Detalhe o tempo de atendimento psicol√≥gico.',
                validator: () => {
                  if (getCheckedValue('atendimentoPsicologo') !== 'Sim') return true;
                  const input = document.getElementById('tempoPsicologo');
                  return input ? input.value.trim().length > 0 : true;
                },
              },
            ])
            .addRequiredGroup('input[name="atendimentoPsiquiatra"]', 'Informe se houve atendimento psiqui√°trico.')
            .addField('#tempoPsiquiatra', [
              {
                rule: 'function',
                errorMessage: 'Detalhe o tempo de atendimento psiqui√°trico.',
                validator: () => {
                  if (getCheckedValue('atendimentoPsiquiatra') !== 'Sim') return true;
                  const input = document.getElementById('tempoPsiquiatra');
                  return input ? input.value.trim().length > 0 : true;
                },
              },
            ])
            .addRequiredGroup('input[name="usoMedicamento"]', 'Informe se faz uso de medicamentos.')
            .addField('#medicamentosQuais', [
              {
                rule: 'function',
                errorMessage: 'Liste os medicamentos em uso.',
                validator: () => {
                  if (getCheckedValue('usoMedicamento') !== 'Sim') return true;
                  const input = document.getElementById('medicamentosQuais');
                  return input ? input.value.trim().length > 0 : true;
                },
              },
            ])
            .addRequiredGroup('input[name="usoDrogasLicitas"]', 'Informe o uso de drogas l√≠citas.')
            .addField('#drogaLicitaTabaco', [
              {
                rule: 'function',
                errorMessage: 'Selecione ao menos uma droga l√≠cita.',
                validator: () => {
                  if (getCheckedValue('usoDrogasLicitas') !== 'Sim') return true;
                  return (
                    Array.from(document.querySelectorAll('input[name="drogasLicitas[]"]:checked')).length > 0
                  );
                },
              },
            ])
            .addField('#drogasLicitasOutrasTexto', [
              {
                rule: 'function',
                errorMessage: 'Detalhe as outras drogas l√≠citas.',
                validator: () => {
                  if (!drogaLicitaOutrasCheckbox || !drogaLicitaOutrasCheckbox.checked) return true;
                  const input = document.getElementById('drogasLicitasOutrasTexto');
                  return input ? input.value.trim().length > 0 : true;
                },
              },
            ])
            .addRequiredGroup('input[name="usoDrogasIlicitas"]', 'Informe o uso de drogas il√≠citas.')
            .addField('#drogaIlicitaCocaina', [
              {
                rule: 'function',
                errorMessage: 'Selecione ao menos uma droga il√≠cita.',
                validator: () => {
                  if (getCheckedValue('usoDrogasIlicitas') !== 'Sim') return true;
                  return (
                    Array.from(document.querySelectorAll('input[name="drogasIlicitas[]"]:checked')).length > 0
                  );
                },
              },
            ])
            .addField('#drogasIlicitasOutrasTexto', [
              {
                rule: 'function',
                errorMessage: 'Detalhe as outras drogas il√≠citas.',
                validator: () => {
                  if (!drogaIlicitaOutrasCheckbox || !drogaIlicitaOutrasCheckbox.checked) return true;
                  const input = document.getElementById('drogasIlicitasOutrasTexto');
                  return input ? input.value.trim().length > 0 : true;
                },
              },
            ])
            .addRequiredGroup('input[name="gestante"]', 'Informe se est√° gestante.')
            .addField('#tempoGestacao', [
              {
                rule: 'function',
                errorMessage: 'Informe o tempo de gesta√ß√£o.',
                validator: () => {
                  if (getCheckedValue('gestante') !== 'Sim') return true;
                  const select = document.getElementById('tempoGestacao');
                  return select ? select.value.trim().length > 0 : true;
                },
              },
            ])
            .addRequiredGroup('input[name="abortoViolencia"]', 'Informe se houve aborto decorrente da viol√™ncia.')
            .addField('#preventivoColoSim', [
              {
                rule: 'function',
                errorMessage: 'Informe se realizou preventivo.',
                validator: () => {
                  if (!preventivoGroup || preventivoGroup.classList.contains('d-none')) return true;
                  return document.querySelector('input[name="preventivoColo"]:checked') !== null;
                },
              },
            ])
            .addField('#preventivoAno', [
              {
                rule: 'function',
                errorMessage: 'Informe o ano do preventivo.',
                validator: () => {
                  if (getCheckedValue('preventivoColo') !== 'Sim') return true;
                  const input = document.getElementById('preventivoAno');
                  return input ? input.value.trim().length > 0 : true;
                },
              },
            ])
            .addField('#mamografiaSim', [
              {
                rule: 'function',
                errorMessage: 'Informe se realizou mamografia.',
                validator: () => {
                  if (!mamografiaGroup || mamografiaGroup.classList.contains('d-none')) return true;
                  return document.querySelector('input[name="mamografia"]:checked') !== null;
                },
              },
            ])
            .addField('#mamografiaAno', [
              {
                rule: 'function',
                errorMessage: 'Informe o ano da mamografia.',
                validator: () => {
                  if (getCheckedValue('mamografia') !== 'Sim') return true;
                  const input = document.getElementById('mamografiaAno');
                  return input ? input.value.trim().length > 0 : true;
                },
              },
            ])
            .addRequiredGroup('input[name="exameHiv"]', 'Informe se realizou exame de HIV.')
            .addField('#resultadoHivNegativo', [
              {
                rule: 'function',
                errorMessage: 'Informe o resultado do exame de HIV.',
                validator: () => {
                  if (getCheckedValue('exameHiv') !== 'Sim') return true;
                  return document.querySelector('input[name="resultadoHiv"]:checked') !== null;
                },
              },
            ])
            .addField('#contraiuAgressorSim', [
              {
                rule: 'function',
                errorMessage: 'Informe se contraiu com o agressor.',
                validator: () => {
                  if (getCheckedValue('resultadoHiv') !== 'Positivo') return true;
                  return document.querySelector('input[name="contraiuAgressor"]:checked') !== null;
                },
              },
            ])
            .addRequiredGroup('input[name="acompanhamentoSaudeContinuo"]', 'Informe se faz acompanhamento.')
            .addField('#tempoAcompanhamento', [
              {
                rule: 'function',
                errorMessage: 'Informe h√° quanto tempo realiza o tratamento.',
                validator: () => {
                  if (getCheckedValue('acompanhamentoSaudeContinuo') !== 'Sim') return true;
                  const select = document.getElementById('tempoAcompanhamento');
                  return select ? select.value.trim().length > 0 : true;
                },
              },
            ])
            .addField('#tipoViolencia', [{ rule: 'required', errorMessage: 'Selecione o tipo de viol√™ncia.' }])
            .addField('#localViolencia', [{ rule: 'required', errorMessage: 'Informe o local principal.' }])
            .addField('#escolaridade', [{ rule: 'required', errorMessage: 'Informe a escolaridade.' }])
            .addField('#tipoRelacionamento', [
              { rule: 'required', errorMessage: 'Selecione o tipo de relacionamento.' },
            ])
            .addField('#violenciaFisicaOutrasTexto', [
              {
                rule: 'function',
                errorMessage: 'Detalhe outras viol√™ncias f√≠sicas.',
                validator: () => {
                  if (!fisicaOutrasCheckbox || !fisicaOutrasCheckbox.checked) return true;
                  const input = document.getElementById('violenciaFisicaOutrasTexto');
                  return input ? input.value.trim().length > 0 : true;
                },
              },
            ])
            .addField('#violenciaPsicologicaOutrasTexto', [
              {
                rule: 'function',
                errorMessage: 'Detalhe outras viol√™ncias psicol√≥gicas.',
                validator: () => {
                  if (!psicologicaOutrasCheckbox || !psicologicaOutrasCheckbox.checked) return true;
                  const input = document.getElementById('violenciaPsicologicaOutrasTexto');
                  return input ? input.value.trim().length > 0 : true;
                },
              },
            ])
            .addField('#violenciaSexualOutrasTexto', [
              {
                rule: 'function',
                errorMessage: 'Detalhe outras viol√™ncias sexuais.',
                validator: () => {
                  if (!sexualOutrasCheckbox || !sexualOutrasCheckbox.checked) return true;
                  const input = document.getElementById('violenciaSexualOutrasTexto');
                  return input ? input.value.trim().length > 0 : true;
                },
              },
            ])
            .addField('#localAgressaoOutrosTexto', [
              {
                rule: 'function',
                errorMessage: 'Detalhe outros locais da agress√£o.',
                validator: () => {
                  if (!localOutrosCheckbox || !localOutrosCheckbox.checked) return true;
                  const input = document.getElementById('localAgressaoOutrosTexto');
                  return input ? input.value.trim().length > 0 : true;
                },
              },
            ])
            .addField('#fatoresRelacionadosOutrosTexto', [
              {
                rule: 'function',
                errorMessage: 'Detalhe outros fatores relacionados.',
                validator: () => {
                  if (!fatorOutrosCheckbox || !fatorOutrosCheckbox.checked) return true;
                  const input = document.getElementById('fatoresRelacionadosOutrosTexto');
                  return input ? input.value.trim().length > 0 : true;
                },
              },
            ])
            .addRequiredGroup('input[name="horarioOcorrido"]', 'Informe o hor√°rio do ocorrido.')
            .addRequiredGroup('input[name="conhecimentoAgressao"]', 'Informe se terceiros t√™m conhecimento das agress√µes.')
            .addField('#conhecimentoContato', [
              {
                rule: 'function',
                errorMessage: 'Informe o contato de refer√™ncia.',
                validator: () => {
                  if (getCheckedValue('conhecimentoAgressao') !== 'Sim') return true;
                  const input = document.getElementById('conhecimentoContato');
                  return input ? input.value.trim().length > 0 : true;
                },
              },
            ])
            .addField('#conhecimentoTelefone', [
              {
                rule: 'function',
                errorMessage: 'Informe o telefone de contato.',
                validator: () => {
                  if (getCheckedValue('conhecimentoAgressao') !== 'Sim') return true;
                  const input = document.getElementById('conhecimentoTelefone');
                  if (!input) return true;
                  const digits = input.value.replace(/\D/g, '');
                  return digits.length >= 10;
                },
              },
            ])
            .addField('#conhecimentoGrau', [
              {
                rule: 'function',
                errorMessage: 'Informe o grau de relacionamento.',
                validator: () => {
                  if (getCheckedValue('conhecimentoAgressao') !== 'Sim') return true;
                  const select = document.getElementById('conhecimentoGrau');
                  return select ? select.value.trim().length > 0 : true;
                },
              },
            ])
            .addRequiredGroup('input[name="solicitarCiods"]', 'Informe se solicitar√° senha CIODS.')
            .addField('#corpoEmailCiods', [
              {
                rule: 'function',
                errorMessage: 'Descreva o corpo do e-mail para o CIODS.',
                validator: () => {
                  if (getCheckedValue('solicitarCiods') !== 'Sim') return true;
                  const textarea = document.getElementById('corpoEmailCiods');
                  return textarea ? textarea.value.trim().length > 0 : true;
                },
              },
            ])
            .addField('#relatoCaso', [{ rule: 'required', errorMessage: 'Descreva o relato do caso.' }])
            .addRequiredGroup('input[name="avaliacaoInicial"]', 'Selecione a avalia√ß√£o inicial.')
            .addField('#cursoFormacao', [
              {
                rule: 'function',
                errorMessage: 'Informe o curso.',
                validator: () => {
                  if (!cursoFormacaoGroup || cursoFormacaoGroup.classList.contains('d-none')) {
                    return true;
                  }
                  return cursoFormacaoInput ? cursoFormacaoInput.value.trim().length > 0 : true;
                },
              },
            ])
            .addField('#emailConfirmacao', [
              {
                rule: 'function',
                errorMessage: 'O e-mail deve coincidir.',
                validator: () => {
                  const emailField = document.getElementById('email');
                  const confirmField = document.getElementById('emailConfirmacao');
                  if (!emailField || !confirmField) return true;
                  if (!emailField.value && !confirmField.value) return true;
                  return emailField.value === confirmField.value;
                },
              },
            ])
            .addField('#situacaoHabitacionalOutro', [
              {
                rule: 'function',
                errorMessage: 'Detalhe a situa√ß√£o habitacional.',
                validator: () => {
                  const select = document.getElementById('situacaoHabitacional');
                  const outro = document.getElementById('situacaoHabitacionalOutro');
                  if (!select || !outro) return true;
                  if (select.value !== 'Outros') return true;
                  return outro.value.trim().length > 0;
                },
              },
            ])
            .addField('#cursoCapacitacao', [
              {
                rule: 'function',
                errorMessage: 'Informe ao menos um curso.',
                validator: () => {
                  if (!cursosWrapper || cursosWrapper.classList.contains('d-none')) {
                    return true;
                  }
                  return !!cursoCapacitacao && cursoCapacitacao.value.trim().length > 0;
                },
              },
            ])
            .onSuccess((event) => {
              event.preventDefault();
              const form = event.target;
              const mode = form.dataset.mode || 'create';
              const formData = new FormData(form);
              const payload = {};
              formData.forEach((value, key) => {
                if (payload[key]) {
                  if (!Array.isArray(payload[key])) {
                    payload[key] = [payload[key]];
                  }
                  payload[key].push(value);
                } else {
                  payload[key] = value;
                }
              });

              console.log('Registro submetido:', JSON.stringify(payload, null, 2));

              const toastEl = document.getElementById('successToast');
              if (toastEl) {
                const toast = new bootstrap.Toast(toastEl);
                toast.show();
              }

              const limparEstados = () => {
                const invalidEls = form.querySelectorAll('.is-invalid');
                invalidEls.forEach((el) => el.classList.remove('is-invalid'));
                atualizarWrapperCursos(false);
                atualizarDetalhes();
                atualizarEncaminhamentos();
                atualizarSituacaoHabitacionalOutro();
                restaurarTabelaFamilia();
                restaurarTabelaAutores();
                updateDeficiencia();
                updateProblemaSaude();
                updatePsicologo();
                updatePsiquiatra();
                updateMedicamentos();
                updateDrogasLicitas();
                updateDrogasIlicitas();
                updateGestante();
                if (identidadeGeneroSelect) {
                  atualizarExamesFemininos();
                }
                updatePreventivoAno();
                updateMamografiaAno();
                updateResultadoHiv();
                updateContraiuAgressor();
                updateAcompanhamento();
                updateViolenciaFisicaOutras();
                updateViolenciaPsicologicaOutras();
                updateViolenciaSexualOutras();
                updateLocalAgressaoOutros();
                updateFatoresRelacionadosOutros();
                updateConhecimentoAgressao();
                updateSolicitarCiods();
                updateEditarRelato();
                if (cidadeNascimentoSelect) {
                  cidadeNascimentoSelect.innerHTML = '';
                  const option = document.createElement('option');
                  option.value = '';
                  option.textContent = 'Selecione a UF primeiro';
                  cidadeNascimentoSelect.appendChild(option);
                }
              };

              if (mode === 'create') {
                form.reset();
                setFormMode('create');
                toggleIdentificacaoReadOnly('create');
                setEvolucoesDados([], '', { setOriginal: true });
                updateNumeroProntuarioDisplay('');
                updateFormStatus('create', '');
                setCurrentDateTime();
                lastLoadedPayload = null;
                lastLoadedMode = 'create';
                lastLoadedProntuario = '';
                limparEstados();
              } else {
                lastLoadedMode = mode;
                limparEstados();
              }

              setTimeout(() => {
                refreshFormInteractions();
                markFormClean();
              }, 0);

              closeRegistroModal({ skipPrompt: true });

              if (window.prontuarioConsulta && typeof window.prontuarioConsulta.refresh === 'function') {
                window.prontuarioConsulta.refresh();
              }
            });

        }

        const refreshFormInteractions = () => {
          restaurarTabelaFamilia();
          restaurarTabelaAutores();
          restaurarTabelaEvolucoes();
          restaurarTabelaAnexos();
          updateViolenciaFisicaOutras();
          updateViolenciaPsicologicaOutras();
          updateViolenciaSexualOutras();
          updateLocalAgressaoOutros();
          updateFatoresRelacionadosOutros();
          updateConhecimentoAgressao();
          updateSolicitarCiods();
          updateEditarRelato();
          updateNumeroBoGroup();
          updateOrigemProcedimento();
          updateExameCorpoDelito();
          updateFianca();
          updateMedidaSolicitada();
          updateDescumprimento();
          updateDescumprimentoBo();
          updateDecisaoGravosa();
          updateAcaoPenal();
          updateQueixaCrime();
          updateAbrigamento();
          updateViolenciaInstitucional();
        };

        const registroForm = document.getElementById('registroForm');
        const formWrapper = document.getElementById('formularioWrapper');
        const formStatus = document.getElementById('formularioStatus');
        const registroFieldset = document.getElementById('registroFieldset');
        const novoRegistroBtn = document.getElementById('novoRegistroBtn');
        const registroModalEl = document.getElementById('registroModal');
        const registroModalBody = document.getElementById('registroModalBody');
        const registroModalTitle = document.getElementById('registroModalLabel');
        const registroModalSalvarBtn = document.getElementById('registroModalSalvarBtn');
        const registroModalCancelarBtn = document.getElementById('registroModalCancelarBtn');
        const registroModalFecharBtn = document.getElementById('registroModalFecharBtn');
        const registroModalFooter = document.getElementById('registroModalFooter');
        let formSnapshot = '';
        let isFormDirty = false;
        const UNSAVED_CHANGES_MESSAGE = 'As altera√ß√µes ser√£o perdidas. Deseja continuar?';
        const unsavedModalEl = document.getElementById('unsavedChangesModal');
        const unsavedModalInstance =
          unsavedModalEl && window.bootstrap ? bootstrap.Modal.getOrCreateInstance(unsavedModalEl, { backdrop: 'static', keyboard: false }) : null;
        const unsavedMessageEl = unsavedModalEl ? unsavedModalEl.querySelector('[data-unsaved-message]') : null;
        let pendingUnsavedResolve = null;
        let pendingUnsavedResult = false;
        let lastLoadedPayload = null;
        let lastLoadedMode = 'create';
        let lastLoadedProntuario = '';

        const promptUnsavedChanges = (triggerEl = null) => {
          if (!unsavedModalInstance) {
            return Promise.resolve(window.confirm(UNSAVED_CHANGES_MESSAGE));
          }
          if (unsavedMessageEl) {
            unsavedMessageEl.textContent = UNSAVED_CHANGES_MESSAGE;
          }
          pendingUnsavedResult = false;
          const opener =
            triggerEl instanceof HTMLElement
              ? triggerEl
              : document.activeElement instanceof HTMLElement
              ? document.activeElement
              : registroModalEl;
          if (
            window.modalStackManager &&
            typeof window.modalStackManager.prepareForNestedModal === 'function'
          ) {
            window.modalStackManager.prepareForNestedModal(opener, unsavedModalEl);
          }
          unsavedModalInstance.show(opener instanceof HTMLElement ? opener : undefined);
          return new Promise((resolve) => {
            pendingUnsavedResolve = resolve;
          });
        };

        if (unsavedModalEl) {
          unsavedModalEl.addEventListener('click', (event) => {
            const button = event.target instanceof HTMLElement ? event.target.closest('[data-confirm-result]') : null;
            if (!button) return;
            pendingUnsavedResult = button.getAttribute('data-confirm-result') === 'true';
          });
          unsavedModalEl.addEventListener('hidden.bs.modal', () => {
            if (pendingUnsavedResolve) {
              const resolver = pendingUnsavedResolve;
              pendingUnsavedResolve = null;
              resolver(pendingUnsavedResult);
            }
          });
        }

        const serializeForm = () => {
          if (!registroForm) return '';
          const formData = new FormData(registroForm);
          const entries = [];
          for (const [key, value] of formData.entries()) {
            entries.push(`${key}=${value}`);
          }
          entries.sort();
          return entries.join('&');
        };

        const updateDirtyState = () => {
          if (!registroForm || registroForm.dataset.mode === 'view') {
            isFormDirty = false;
            return;
          }
          isFormDirty = serializeForm() !== formSnapshot;
        };

        const markFormClean = () => {
          formSnapshot = serializeForm();
          isFormDirty = false;
          evolucoesDadosOriginais = cloneEvolucoesLista(evolucoesDadosAtuais);
          anexosDadosOriginais = cloneAnexosLista(anexosDadosAtuais);
        };

        const focusModalContext = () => {
          if (!registroForm) return;
          const mode = registroForm.dataset.mode || 'create';
          if (mode === 'view') {
            if (registroModalTitle) {
              registroModalTitle.focus({ preventScroll: true });
            }
            return;
          }
          const focusable = registroForm.querySelector(
            'input:not([type="hidden"]):not([disabled]):not([readonly]), select:not([disabled]), textarea:not([disabled])'
          );
          if (focusable) {
            focusable.focus({ preventScroll: true });
          }
        };

        const updateModalModeUI = (mode) => {
          if (!registroModalFooter) return;
          const normalized = mode === 'edit' ? 'edit' : mode === 'view' ? 'view' : 'create';
          const isView = normalized === 'view';
          if (registroModalSalvarBtn) {
            registroModalSalvarBtn.classList.toggle('d-none', isView);
            registroModalSalvarBtn.disabled = isView;
          }
          if (registroModalCancelarBtn) {
            registroModalCancelarBtn.classList.toggle('d-none', isView);
            registroModalCancelarBtn.disabled = isView;
          }
          if (registroModalFecharBtn) {
            const showFechar = normalized !== 'edit';
            registroModalFecharBtn.classList.toggle('d-none', !showFechar);
            registroModalFecharBtn.disabled = !showFechar;
          }
          if (registroModalTitle) {
            registroModalTitle.textContent =
              normalized === 'edit' ? 'Editar prontu√°rio' : normalized === 'view' ? 'Visualizar prontu√°rio' : 'Novo registro';
          }
        };

        const showRegistroModal = (mode) => {
          if (formWrapper) {
            formWrapper.classList.remove('d-none');
          }
          updateModalModeUI(mode || (registroForm ? registroForm.dataset.mode : 'create'));
          if (registroModalBody) {
            registroModalBody.scrollTop = 0;
          }
          if (registroModalEl) {
            registroModalEl.classList.remove('d-none');
            registroModalEl.setAttribute('aria-hidden', 'false');
            requestAnimationFrame(() => {
              focusModalContext();
            });
          }
        };

        const closeRegistroModal = (options = {}) => {
          if (!registroModalEl) return;
          if (options && options.skipPrompt !== true && registroForm && registroForm.dataset.mode !== 'view') {
            updateDirtyState();
            if (isFormDirty) {
              return;
            }
          }
          registroModalEl.classList.add('d-none');
          registroModalEl.setAttribute('aria-hidden', 'true');
          if (registroForm) {
            registroForm.classList.remove('was-validated');
          }
        };

        window.portalRegistroModal = window.portalRegistroModal || {};
        window.portalRegistroModal.show = showRegistroModal;
        window.portalRegistroModal.close = closeRegistroModal;
        window.showRegistroModal = showRegistroModal;
        window.closeRegistroModal = closeRegistroModal;

        if (registroModalEl) {
          registroModalEl.setAttribute('aria-hidden', 'true');
        }

        if (registroForm) {
          registroForm.addEventListener(
            'input',
            () => {
              updateDirtyState();
            },
            true
          );
          registroForm.addEventListener(
            'change',
            () => {
              updateDirtyState();
            },
            true
          );
        }

        if (registroForm) {
          registroForm.addEventListener('reset', () => {
            preencherCursos([]);
            toggleIdentificacaoReadOnly('create');
            setEvolucoesDados([], '', { setOriginal: true });
            setAnexosDados([], '', { setOriginal: true });
            setTimeout(() => {
              refreshFormInteractions();
              if (registroForm.dataset.mode === 'create') {
                setCurrentDateTime();
              }
              markFormClean();
            }, 0);
          });
        }

        if (registroModalSalvarBtn && registroForm) {
          registroModalSalvarBtn.addEventListener('click', () => {
            registroForm.requestSubmit();
          });
        }

        if (registroModalCancelarBtn) {
          registroModalCancelarBtn.addEventListener('click', async () => {
            if (!registroForm) {
              closeRegistroModal({ skipPrompt: true });
              return;
            }
            const mode = registroForm.dataset.mode || 'create';
            if (mode === 'view') {
              closeRegistroModal({ skipPrompt: true });
              return;
            }
            const confirmar = await promptUnsavedChanges(registroModalCancelarBtn);
            if (!confirmar) {
              return;
            }
            if (mode === 'edit' && lastLoadedPayload) {
              registroForm.reset();
              setFormMode('edit');
              populateFormWithData(lastLoadedPayload);
              toggleIdentificacaoReadOnly('edit');
              setEvolucoesDados(evolucoesDadosOriginais, lastLoadedProntuario, { setOriginal: true });
              setAnexosDados(anexosDadosOriginais, lastLoadedProntuario, { setOriginal: true });
              updateFormStatus('edit', lastLoadedProntuario);
              lastLoadedMode = 'edit';
            } else {
              registroForm.reset();
              setFormMode('create');
              toggleIdentificacaoReadOnly('create');
              setEvolucoesDados([], '', { setOriginal: true });
              setAnexosDados([], '', { setOriginal: true });
              updateNumeroProntuarioDisplay('');
              updateFormStatus('create', '');
              setCurrentDateTime();
              lastLoadedPayload = null;
              lastLoadedMode = 'create';
              lastLoadedProntuario = '';
            }
            setTimeout(() => {
              refreshFormInteractions();
              markFormClean();
            }, 0);
            closeRegistroModal({ skipPrompt: true });
          });
        }

        if (registroModalFecharBtn) {
          registroModalFecharBtn.addEventListener('click', () => {
            closeRegistroModal({ skipPrompt: true });
          });
        }

        const cssEscape = (value) => {
          if (window.CSS && typeof window.CSS.escape === 'function') {
            return window.CSS.escape(value);
          }
          return (value || '').toString().replace(/([!"#$%&'()*+,./:;<=>?@[\]^`{|}~])/g, '\$1');
        };

        const updateNumeroProntuarioDisplay = (valor) => {
          if (!numeroProntuarioDisplay) return;
          const texto = valor && valor.toString().trim();
          numeroProntuarioDisplay.textContent = texto && texto.length ? texto : '‚Äî';
        };

        const findElementsForKey = (key) => {
          if (!registroForm || key == null) return [];
          const normalizedKey = key.toString().trim();
          if (!normalizedKey) return [];
          const selectors = new Set();
          selectors.add(`[name="${normalizedKey}"]`);
          selectors.add(`#${cssEscape(normalizedKey)}`);
          if (normalizedKey.includes('_') || normalizedKey.includes(' ')) {
            const camel = normalizedKey.replace(/[_\s]+(.)?/g, (_, chr) => (chr ? chr.toUpperCase() : ''));
            selectors.add(`[name="${camel}"]`);
            selectors.add(`#${cssEscape(camel)}`);
            const kebab = normalizedKey.replace(/[_\s]+/g, '-');
            selectors.add(`[name="${kebab}"]`);
            selectors.add(`#${cssEscape(kebab)}`);
          }
          const elements = [];
          selectors.forEach((selector) => {
            if (selector.startsWith('#')) {
              try {
                const element = registroForm.querySelector(selector);
                if (element && !elements.includes(element)) {
                  elements.push(element);
                }
              } catch (error) {
                /* invalid selector */
              }
            } else {
              registroForm.querySelectorAll(selector).forEach((element) => {
                if (!elements.includes(element)) {
                  elements.push(element);
                }
              });
            }
          });
          return elements;
        };

        const assignValueToElements = (elements, value) => {
          if (!elements || !elements.length) return;
          const normalizedArray = Array.isArray(value)
            ? value.map((item) => (item != null ? item.toString() : ''))
            : typeof value === 'string'
            ? value
                .split(/[,;]+/)
                .map((item) => item.trim())
                .filter(Boolean)
            : value != null
            ? [value.toString()]
            : [''];
          elements.forEach((element) => {
            if (element.type === 'checkbox') {
              element.checked = normalizedArray.includes(element.value);
              element.dispatchEvent(new Event('change', { bubbles: true }));
            } else if (element.type === 'radio') {
              element.checked = normalizedArray.length ? element.value === normalizedArray[0] : false;
              if (element.checked) {
                element.dispatchEvent(new Event('change', { bubbles: true }));
              }
            } else if (element.tagName === 'SELECT') {
              setSelectValue(element, normalizedArray.length ? normalizedArray[0] : '');
              element.dispatchEvent(new Event('change', { bubbles: true }));
            } else if (element instanceof HTMLInputElement || element instanceof HTMLTextAreaElement) {
              element.value = normalizedArray.length ? normalizedArray[0] : '';
              element.dispatchEvent(new Event('input', { bubbles: true }));
              element.dispatchEvent(new Event('change', { bubbles: true }));
            }
          });
        };

        const formatCpfForInput = (value) => {
          const digits = String(value || '')
            .replace(/\D/g, '')
            .slice(0, 11);
          if (digits.length !== 11) return digits;
          return digits.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
        };

        const normalizeDigits = (value) => String(value || '').replace(/\D/g, '');

        const pickTelefonePrincipal = (value, dataObj) => {
          const preferencial = normalizeDigits(value);
          if (preferencial) {
            return preferencial;
          }
          if (dataObj && Object.prototype.hasOwnProperty.call(dataObj, 'celular')) {
            return normalizeDigits(dataObj.celular);
          }
          return '';
        };

        const formatDateToBR = (value) => {
          if (!value && value !== 0) return '';
          const raw = String(value).trim();
          if (!raw) return '';
          if (/^\d{2}\/\d{2}\/\d{4}$/.test(raw)) return raw;
          if (window.dayjs) {
            const parsed = dayjs(raw);
            if (parsed.isValid()) {
              return parsed.format('DD/MM/YYYY');
            }
          }
          const isoMatch = raw.match(/^(\d{4})-(\d{2})-(\d{2})/);
          if (isoMatch) {
            return `${isoMatch[3]}/${isoMatch[2]}/${isoMatch[1]}`;
          }
          return raw;
        };

        const formatTimeFromDateTime = (value) => {
          if (!value && value !== 0) return '';
          const raw = String(value).trim();
          if (!raw) return '';
          if (/^\d{2}:\d{2}$/.test(raw)) return raw;
          const match = raw.match(/(\d{2}):(\d{2})(?::\d{2})?/);
          if (match) return `${match[1]}:${match[2]}`;
          if (window.dayjs) {
            const parsed = dayjs(raw);
            if (parsed.isValid()) {
              return parsed.format('HH:mm');
            }
          }
          return raw;
        };

        const splitMultiValue = (value) => {
          if (Array.isArray(value)) {
            return value.filter((item) => item != null && String(item).trim() !== '').map((item) => String(item).trim());
          }
          if (!value && value !== 0) return [];
          const raw = String(value).trim();
          if (!raw) return [];
          if (/^\[.*\]$/.test(raw)) {
            try {
              const parsed = JSON.parse(raw);
              if (Array.isArray(parsed)) {
                return splitMultiValue(parsed);
              }
            } catch (error) {
              /* ignore json parse errors */
            }
          }
          return raw
            .split(/[;,|]/)
            .map((item) => item.trim())
            .filter(Boolean);
        };

        const payloadKeyMapping = [
          ['prontuario', { targets: ['numeroProntuario'] }],
          ['nome', { targets: ['nomeUsuario'] }],
          ['nome_social', { targets: ['nomeSocial'] }],
          ['cpf', { targets: ['cpfUsuario'], transform: formatCpfForInput }],
          ['demandante', 'demandante'],
          ['unidade_atendimento', 'unidadeAtendimento'],
          ['data_pri_atendimento', { targets: ['dataAtendimento'], transform: formatDateToBR }],
          ['data_update', { targets: ['horaAtendimento'], transform: formatTimeFromDateTime }],
          ['telefone', { targets: ['telefone'], transform: pickTelefonePrincipal }],
          ['email', { targets: ['email', 'emailConfirmacao'] }],
          ['cep', { targets: ['cep'], transform: normalizeDigits }],
          ['logradouro', 'logradouro'],
          ['numero', 'numeroEndereco'],
          ['complemento', 'complementoEndereco'],
          ['bairro', 'bairro'],
          ['rpa', 'rpa'],
          ['cidade', 'cidade'],
          ['uf', 'uf'],
          ['ponto_ref', 'pontoReferencia'],
          ['nascimento', { targets: ['dataNascimento'], transform: formatDateToBR }],
          ['idade', 'idade'],
          ['mae_vitima', 'nomeMae'],
          ['pai_vitima', 'nomePai'],
          ['nacionalidade', 'nacionalidade'],
          ['uf_nascimento', 'ufNascimento'],
          ['cidade_nascimento', 'cidadeNascimento'],
          ['estadocivil_vitima', 'estadoCivil'],
          ['conjuge', 'conjuge'],
          ['rg', 'rgUsuario'],
          ['expedicao', 'orgaoExpedidor'],
          ['uf_rg', 'ufExpedicao'],
          ['orientacao_vitima', 'orientacaoSexual'],
          ['genero_vitima', 'identidadeGenero'],
          ['racacor_vitima', 'corRaca'],
          ['religiao_vitima', 'religiao'],
          ['situacao_ocupacional', 'situacaoOcupacional'],
          ['ocupacao', 'profissao'],
          ['situacao_trabalhista', 'situacaoTrabalho'],
          ['interesse_capacitacao', 'interesseCapacitacao'],
          ['rendavitima', 'rendaIndividual'],
          ['rendafamiliar', 'rendaFamiliar'],
          ['total_filhos', 'totalFilhos'],
          ['situacao_habitacional', 'situacaoHabitacional'],
          ['outras_drogas_licitas', 'drogasLicitasOutrasTexto'],
          ['outras_drogas_ilicitas', 'drogasIlicitasOutrasTexto'],
          ['soube_servico', { targets: ['origemServico[]'], transform: splitMultiValue }],
          ['atendimento', { targets: ['atendimento[]'], transform: splitMultiValue }],
          ['tipo_violencia', 'tipoViolencia'],
          ['outras_viol_fisicas', 'violenciaFisicaOutrasTexto'],
          ['outras_viol_psicologicas', 'violenciaPsicologicaOutrasTexto'],
          ['outras_viol_sexuais', 'violenciaSexualOutrasTexto'],
          ['outro_local_agressao', 'localAgressaoOutrosTexto'],
          ['tempo_convivencia', 'tempoConvivencia'],
          ['curso', 'cursoFormacao'],
          ['escolaridavitim', 'escolaridade'],
          ['sitescolvitima', 'situacaoEscolar'],
          ['posgradvitima', 'tipoPosGraduacao'],
          ['ano_periodo', 'anoPeriodo'],
          ['quais_medicamentos', 'medicamentosQuais'],
          ['qual_prob_saude', 'problemaSaudeQual'],
          ['tempo_psico', 'tempoPsicologo'],
          ['tempo_psiquiatra', 'tempoPsiquiatra'],
          ['tempo_gestacao', 'tempoGestacao'],
          ['ano_prev_cancer', 'preventivoAno'],
          ['ano_mamografia', 'mamografiaAno'],
          ['tmpacomphiv', 'tempoAcompanhamento'],
          ['relato', { targets: ['relato', 'relatoCaso'] }],
          ['breve_relato', { targets: ['relato', 'relatoCaso'], preferIfEmpty: true }],
          ['discriminar_bens', 'discriminarBens'],
          ['outros_fatores_violencia', 'fatoresRelacionadosOutrosTexto'],
          ['contato_ref', 'conhecimentoContato'],
          ['telefone_ref', { targets: ['telefoneSecundario'], transform: normalizeDigits }],
          ['telefone_ref', { targets: ['conhecimentoTelefone'], transform: normalizeDigits }],
          ['parentescotest', 'conhecimentoGrau'],
          ['temdeficencia', 'deficienciaSindrome'],
          ['tipo_deficiencia', 'deficienciaQual'],
          ['catao_sus', 'numeroSus'],
          ['encaminhamentos', { targets: ['encaminhamentosExternos[]'], transform: splitMultiValue }],
          ['encaminhamento', { targets: ['encaminhamentosExternos[]'], transform: splitMultiValue }],
          ['observacoes', 'observacoesJuridicas'],
          ['obs_oferta_abrigo', 'observacoesMpu'],
          ['outros_beneficios', 'beneficios']
        ];

        const normalizeRegistroPayload = (payload) => {
          if (!payload && payload !== 0) return {};
          if (typeof payload === 'string') {
            try {
              return normalizeRegistroPayload(JSON.parse(payload));
            } catch (error) {
              return {};
            }
          }
          if (Array.isArray(payload)) {
            if (!payload.length) return {};
            return normalizeRegistroPayload(payload[0]);
          }
          if (typeof payload === 'object') {
            if (Array.isArray(payload.data) && payload.data.length) {
              return normalizeRegistroPayload(payload.data[0]);
            }
            if (Array.isArray(payload.resultado) && payload.resultado.length) {
              return normalizeRegistroPayload(payload.resultado[0]);
            }
            if (Array.isArray(payload.records) && payload.records.length) {
              return normalizeRegistroPayload(payload.records[0]);
            }
            return payload;
          }
          return {};
        };

        const mapPayloadFields = (dataObj = {}) => {
          if (!dataObj || typeof dataObj !== 'object') return dataObj;
          const mapped = { ...dataObj };
          const applyMapping = (sourceKey, config) => {
            if (!Object.prototype.hasOwnProperty.call(dataObj, sourceKey)) return;
            const raw = dataObj[sourceKey];
            if (raw == null || (typeof raw === 'string' && raw.trim() === '')) return;
            const normalizedConfig = typeof config === 'string' ? { targets: [config] } : config;
            const targets = normalizedConfig.targets || [];
            const value = normalizedConfig.transform ? normalizedConfig.transform(raw, dataObj) : raw;
            targets.forEach((target) => {
              if (!target) return;
              if (normalizedConfig.override === false && Object.prototype.hasOwnProperty.call(mapped, target)) {
                return;
              }
              if (
                normalizedConfig.preferIfEmpty === true &&
                Object.prototype.hasOwnProperty.call(mapped, target) &&
                mapped[target] != null &&
                String(mapped[target]).trim() !== ''
              ) {
                return;
              }
              mapped[target] = value;
            });
          };
          payloadKeyMapping.forEach(([sourceKey, config]) => applyMapping(sourceKey, config));

          if ((!mapped.telefone || !String(mapped.telefone).trim()) && dataObj && dataObj.celular) {
            const telefoneFallback = normalizeDigits(dataObj.celular);
            if (telefoneFallback) {
              mapped.telefone = telefoneFallback;
            }
          }

          if (mapped.email && (!mapped.emailConfirmacao || !String(mapped.emailConfirmacao).trim())) {
            mapped.emailConfirmacao = mapped.email;
          }

          const cursosColetados = [];
          ['capacitacao1', 'capacitacao2', 'capacitacao3'].forEach((campo) => {
            if (!Object.prototype.hasOwnProperty.call(dataObj, campo)) return;
            const bruto = dataObj[campo];
            if (bruto == null || (typeof bruto === 'string' && bruto.trim() === '')) return;
            const valores = Array.isArray(bruto) ? bruto : splitMultiValue(bruto);
            valores.forEach((item) => {
              const texto = item == null ? '' : String(item).trim();
              if (texto) {
                cursosColetados.push(texto);
              }
            });
          });
          const cursosUnicos = [...new Set(cursosColetados)];
          if (cursosUnicos.length) {
            mapped['cursos[]'] = cursosUnicos.slice(0, 3);
            mapped.interesseCapacitacao = 'Sim';
          } else if (!mapped.interesseCapacitacao) {
            mapped.interesseCapacitacao = 'N√£o';
          }

          return mapped;
        };

        const populateFormWithData = (dataObj = {}) => {
          if (!registroForm || !dataObj || typeof dataObj !== 'object') return;
          const processEntry = (key, value) => {
            if (key === 'cursos[]') {
              const lista = Array.isArray(value) ? value : [value];
              preencherCursos(lista);
              return;
            }
            if (value == null) return;
            if (Array.isArray(value)) {
              const elements = findElementsForKey(key);
              if (elements.length && (elements[0].type === 'checkbox' || elements[0].type === 'radio' || elements[0].tagName === 'SELECT')) {
                assignValueToElements(elements, value);
              } else {
                value.forEach((item) => {
                  if (item && typeof item === 'object' && !Array.isArray(item)) {
                    Object.entries(item).forEach(([childKey, childValue]) => processEntry(childKey, childValue));
                  }
                });
              }
              return;
            }
            if (typeof value === 'object') {
              Object.entries(value).forEach(([childKey, childValue]) => processEntry(childKey, childValue));
              return;
            }
            const elements = findElementsForKey(key);
            if (elements.length) {
              assignValueToElements(elements, value);
            }
          };
          Object.entries(dataObj).forEach(([key, value]) => processEntry(key, value));
          updateNumeroProntuarioDisplay(numeroProntuarioInput ? numeroProntuarioInput.value : '');
        };

        const buildStatusMessage = (prefix, prontuario) => {
          if (!prefix) return '';
          const valor = prontuario && prontuario.toString().trim();
          return valor && valor.length ? `${prefix} ${valor}.` : `${prefix}.`;
        };

        const statusConfig = {
          create: { alertClass: 'alert-primary', icon: 'bi-plus-circle', prefix: 'Novo registro em edi√ß√£o' },
          edit: { alertClass: 'alert-warning', icon: 'bi-pencil-square', prefix: 'Editando prontu√°rio' },
          view: { alertClass: 'alert-info', icon: 'bi-eye', prefix: 'Visualizando prontu√°rio' },
        };

        const setFormMode = (mode) => {
          if (registroForm) {
            registroForm.dataset.mode = mode;
          }
          const isViewMode = mode === 'view';
          if (registroFieldset) {
            registroFieldset.disabled = isViewMode;
          }
          if (registroForm) {
            registroForm.classList.toggle('form-readonly', isViewMode);
          }
          updateModalModeUI(mode);
        };

        const ensureFormVisible = (mode) => {
          showRegistroModal(mode);
        };

        const scrollToForm = () => {
          if (registroModalBody) {
            registroModalBody.scrollTop = 0;
          }
          if (registroModalEl && typeof registroModalEl.scrollIntoView === 'function') {
            registroModalEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        };

        const updateFormStatus = (mode, prontuario) => {
          if (!formStatus) return;
          const config = statusConfig[mode] || statusConfig.view;
          const message = buildStatusMessage(config.prefix, prontuario);
          formStatus.className = `alert ${config.alertClass} align-items-center gap-2 mb-4`;
          formStatus.innerHTML = `<i class="bi ${config.icon}"></i><span>${message}</span>`;
          formStatus.classList.remove('d-none');
        };

        const startNovoRegistro = () => {
          if (!registroForm) return;
          registroForm.reset();
          setFormMode('create');
          toggleIdentificacaoReadOnly('create');
          setEvolucoesDados([], '', { setOriginal: true });
          setAnexosDados([], '', { setOriginal: true });
          lastLoadedPayload = null;
          lastLoadedMode = 'create';
          lastLoadedProntuario = '';
          if (numeroProntuarioInput) {
            numeroProntuarioInput.value = '';
          }
          updateNumeroProntuarioDisplay('');
          setCurrentDateTime();
          updateFormStatus('create', '');
          ensureFormVisible('create');
          scrollToForm();
          setTimeout(() => {
            refreshFormInteractions();
            markFormClean();
          }, 0);
        };

        const openExistingProntuario = (payload, mode = 'view', fallbackProntuario = '') => {
          if (!registroForm) return;
          const normalizedMode = mode === 'edit' ? 'edit' : 'view';
          registroForm.reset();
          setFormMode(normalizedMode);
          const normalizedPayload = normalizeRegistroPayload(payload);
          const mappedPayload = mapPayloadFields(normalizedPayload);
          populateFormWithData(mappedPayload);
          toggleIdentificacaoReadOnly(normalizedMode);
          const candidatos = ['numeroProntuario', 'prontuario', 'numero_prontuario', 'numero'];
          let prontuarioValor = '';
          for (const chave of candidatos) {
            if (mappedPayload && mappedPayload[chave]) {
              prontuarioValor = mappedPayload[chave];
              break;
            }
            const elementos = findElementsForKey(chave);
            if (elementos.length) {
              const referencia = elementos[0];
              const valor = referencia.value || referencia.textContent;
              if (valor) {
                prontuarioValor = valor;
                break;
              }
            }
          }
          if (!prontuarioValor) {
            prontuarioValor = fallbackProntuario;
          }
          if (numeroProntuarioInput && prontuarioValor) {
            numeroProntuarioInput.value = prontuarioValor;
          }
          updateNumeroProntuarioDisplay(prontuarioValor);
          updateFormStatus(normalizedMode, prontuarioValor);
          lastLoadedPayload = mappedPayload;
          lastLoadedMode = normalizedMode;
          lastLoadedProntuario = prontuarioValor || '';
          ensureFormVisible(normalizedMode);
          scrollToForm();
          if (normalizedMode !== 'create') {
            setEvolucoesDados([], prontuarioValor, { setOriginal: true });
            setAnexosDados([], prontuarioValor, { setOriginal: true });
          }
          setTimeout(() => {
            refreshFormInteractions();
            markFormClean();
            if (normalizedMode !== 'create' && prontuarioValor) {
              Promise.all([
                carregarEvolucoesDoProntuario(prontuarioValor),
                carregarAnexosDoProntuario(prontuarioValor),
              ]).then(() => {
                if (!isFormDirty) {
                  markFormClean();
                }
              });
            }
          }, 0);
        };

        const openBlankForm = (mode = 'view') => {
          if (!registroForm) return;
          const normalizedMode = mode === 'edit' ? 'edit' : mode === 'create' ? 'create' : 'view';
          if (normalizedMode === 'create') {
            startNovoRegistro();
            return;
          }

          registroForm.reset();
          setFormMode(normalizedMode);
          toggleIdentificacaoReadOnly(normalizedMode);
          setEvolucoesDados([], '', { setOriginal: true });
          setAnexosDados([], '', { setOriginal: true });
          lastLoadedPayload = null;
          lastLoadedMode = normalizedMode;
          lastLoadedProntuario = '';
          if (numeroProntuarioInput) {
            numeroProntuarioInput.value = '';
          }
          updateNumeroProntuarioDisplay('');
          updateFormStatus(normalizedMode, '');
          ensureFormVisible(normalizedMode);
          scrollToForm();
          setTimeout(() => {
            refreshFormInteractions();
            markFormClean();
          }, 0);
        };

        const prontuarioFormManager = {
          startNovoRegistro,
          openExistingProntuario,
          openBlankForm,
          loadEvolucoes: carregarEvolucoesDoProntuario,
          loadAnexos: carregarAnexosDoProntuario,
        };

        window.prontuarioFormManager = prontuarioFormManager;
        document.dispatchEvent(new CustomEvent('prontuarioFormManagerReady', { detail: prontuarioFormManager }));

        if (novoRegistroBtn && !novoRegistroBtn.dataset.boundNovoRegistro) {
          novoRegistroBtn.addEventListener('click', () => {
            startNovoRegistro();
          });
          novoRegistroBtn.dataset.boundNovoRegistro = 'true';
        }
        setCurrentDateTime();
        };

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initPortal, { once: true });
        } else {
          initPortal();
        }
      })();
    </script>
    <script>
      (function () {
        const form = document.querySelector('#consultaProntuariosForm');
        const input = document.querySelector('#busca-prontuario');
        const btn = document.querySelector('#btn-buscar-prontuarios');
        const clearBtn = document.querySelector('#btn-limpar-prontuarios');
        const exportBtn = document.querySelector('#btn-exportar-prontuarios');
        const tbody = document.querySelector('#tbody-prontuarios');
        const stateAlert = document.querySelector('#consultaProntuariosEstado');
        const tabelaResultados = document.querySelector('#consultaProntuariosResultados table');
        let prontuarioManager = window.prontuarioFormManager || null;
        const pendingProntuarioLoads = [];
        let lastTerm = '';

        if (!input || !btn || !tbody) return;

        function formatCPF(v) {
          const s = String(v || '').replace(/\D/g, '').slice(0, 11).padStart(11, '0');
          return s.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
        }

        function emptyRow(message) {
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 5;
          td.classList.add('text-center', 'text-muted', 'py-4');
          td.textContent = message;
          tr.appendChild(td);
          return tr;
        }

        function showState(message, type = 'info') {
          if (!stateAlert) return;
          stateAlert.classList.add('d-none');
          stateAlert.classList.remove('alert-info', 'alert-success', 'alert-danger', 'alert-warning');
          if (!message) {
            stateAlert.textContent = '';
            return;
          }
          stateAlert.textContent = message;
          stateAlert.classList.remove('d-none');
          stateAlert.classList.add(`alert-${type}`);
        }

        function hasFormManager() {
          if (
            !prontuarioManager &&
            window.prontuarioFormManager &&
            typeof window.prontuarioFormManager.openExistingProntuario === 'function'
          ) {
            prontuarioManager = window.prontuarioFormManager;
            if (pendingProntuarioLoads.length) {
              setTimeout(() => flushPendingProntuarios(), 0);
            }
          }
          return prontuarioManager && typeof prontuarioManager.openExistingProntuario === 'function';
        }

        function abrirProntuarioNoFormulario(payload, modo, prontuario) {
          if (!hasFormManager()) {
            return false;
          }
          try {
            prontuarioManager.openExistingProntuario(payload, modo, prontuario);
            showState(`Prontu√°rio ${prontuario} carregado.`, 'success');
          } catch (error) {
            console.error(error);
            showState('Falha ao exibir o prontu√°rio carregado.', 'danger');
          }
          return true;
        }

        function flushPendingProntuarios() {
          if (!hasFormManager() || !pendingProntuarioLoads.length) return;
          while (pendingProntuarioLoads.length) {
            const { payload, modo, prontuario } = pendingProntuarioLoads.shift();
            abrirProntuarioNoFormulario(payload, modo, prontuario);
          }
        }

        function solicitarAberturaNoFormulario(payload, modo, prontuario) {
          if (window.portalRegistroModal && typeof window.portalRegistroModal.show === 'function') {
            window.portalRegistroModal.show(modo);
          } else if (typeof window.showRegistroModal === 'function') {
            window.showRegistroModal(modo);
          } else {
            const wrapper = document.getElementById('formularioWrapper');
            if (wrapper) {
              wrapper.classList.remove('d-none');
            }
            const container = document.getElementById('registroModal');
            if (container) {
              container.classList.remove('d-none');
              container.setAttribute('aria-hidden', 'false');
              if (typeof container.scrollIntoView === 'function') {
                container.scrollIntoView({ behavior: 'smooth', block: 'start' });
              }
            }
          }
          if (!abrirProntuarioNoFormulario(payload, modo, prontuario)) {
            pendingProntuarioLoads.push({ payload, modo, prontuario });
            showState(`Prontu√°rio ${prontuario} carregado. Preparando formul√°rio...`, 'info');
          }
        }

        document.addEventListener('prontuarioFormManagerReady', (event) => {
          prontuarioManager = event.detail;
          flushPendingProntuarios();
        });

        hasFormManager();
        flushPendingProntuarios();

        function resetResultados() {
          tbody.innerHTML = '';
          tbody.appendChild(emptyRow('Nenhum resultado para exibir.'));
          lastTerm = '';
        }

        function renderProntuarios(items) {
          tbody.innerHTML = '';
          const data = Array.isArray(items) ? items : [];

          if (!data.length) {
            tbody.appendChild(emptyRow('Nenhum registro encontrado'));
            showState('Nenhum registro encontrado.', 'info');
            return;
          }

          const frag = document.createDocumentFragment();
          for (const item of data) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
        <td>${item.prontuario || ''}</td>
        <td>${item.nome || ''}</td>
        <td>${formatCPF(item.cpf)}</td>
        <td>${item.mae || ''}</td>
        <td class="text-end">
          <button class="btn btn-link p-0 me-2 prontuario-acao" type="button" title="Visualizar" data-acao="visualizar" data-prontuario="${item.prontuario || ''}">
            <i class="bi bi-eye"></i>
          </button>
          <button class="btn btn-link p-0 prontuario-acao" type="button" title="Editar" data-acao="editar" data-prontuario="${item.prontuario || ''}">
            <i class="bi bi-pencil-square"></i>
          </button>
        </td>
      `;
            frag.appendChild(tr);
          }
          tbody.appendChild(frag);
          showState(`Exibindo ${data.length} registro(s).`, 'success');
        }

        function coletarDadosTabela() {
          if (!tabelaResultados) return { headers: [], rows: [] };
          const cabecalhos = Array.from(tabelaResultados.querySelectorAll('thead th'))
            .slice(0, 4)
            .map((th) => th.textContent.trim());

          const linhas = Array.from(tabelaResultados.querySelectorAll('tbody tr'))
            .map((tr) => Array.from(tr.querySelectorAll('td')))
            .filter((cols) => cols.length >= 4 && !(cols.length === 1 && cols[0].colSpan > 1))
            .map((cols) => cols.slice(0, 4).map((td) => td.textContent.trim()));

          return { headers: cabecalhos, rows: linhas };
        }

        function exportarTabelaPDF() {
          const { headers, rows } = coletarDadosTabela();
          if (!rows.length) {
            showState('N√£o h√° dados para exportar.', 'warning');
            return;
          }

          if (!window.jspdf || !window.jspdf.jsPDF || typeof window.jspdf.jsPDF !== 'function') {
            showState('Recurso de PDF indispon√≠vel no momento.', 'danger');
            return;
          }

          const doc = new window.jspdf.jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });
          const titulo = 'Resultados da consulta de prontu√°rios';
          doc.setFontSize(16);
          doc.text(titulo, 40, 40);

          if (typeof doc.autoTable !== 'function') {
            showState('Recurso de PDF indispon√≠vel no momento.', 'danger');
            return;
          }

          doc.autoTable({
            head: [headers],
            body: rows,
            startY: 60,
            theme: 'grid',
            styles: {
              fontSize: 10,
              cellPadding: { top: 6, right: 8, bottom: 6, left: 8 },
            },
            headStyles: {
              fillColor: [0, 83, 164],
              textColor: 255,
              fontStyle: 'bold',
            },
            columnStyles: {
              0: { cellWidth: 110 },
              1: { cellWidth: 250 },
              2: { cellWidth: 130 },
              3: { cellWidth: 250 },
            },
          });

          doc.save('prontuarios.pdf');
          showState('PDF gerado com sucesso.', 'success');
        }

        async function carregarProntuario(prontuario, acao) {
          if (!prontuario) return;
          const modo = acao === 'edit' ? 'edit' : 'view';
          showState(`Carregando prontu√°rio ${prontuario}...`, 'info');

          try {
            const resposta = await fetch('https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/buscar-prontuario', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ prontuario }),
            });

            if (!resposta.ok) {
              throw new Error('Falha ao buscar prontu√°rio.');
            }

            const payload = await resposta.json();
            solicitarAberturaNoFormulario(payload, modo, prontuario);
          } catch (error) {
            console.error(error);
            showState('Falha ao carregar o prontu√°rio selecionado.', 'danger');
          }
        }

        async function handleBuscar(forcedTerm) {
          const termo = typeof forcedTerm === 'string' ? forcedTerm.trim() : input.value.trim();
          if (!termo) {
            showState('Informe um termo para busca.', 'warning');
            return;
          }

          const original = btn.innerHTML;
          btn.disabled = true;
          btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Buscando...';

          showState();
          tbody.innerHTML = '';
          tbody.appendChild(emptyRow('Buscando registros...'));

          try {
            const resp = await fetch('https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/listar-prontuarios', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ termo }),
            });

            if (!resp.ok) throw new Error('Erro na requisi√ß√£o');
            const data = await resp.json();
            let registros = [];
            if (Array.isArray(data)) {
              registros = data;
            } else if (data && typeof data === 'object') {
              if (Array.isArray(data.data)) {
                registros = data.data;
              } else if (Array.isArray(data.resultado)) {
                registros = data.resultado;
              } else if (Array.isArray(data.records)) {
                registros = data.records;
              }
            }
            lastTerm = termo;
            input.value = termo;
            renderProntuarios(registros);
          } catch (err) {
            console.error(err);
            tbody.innerHTML = '';
            tbody.appendChild(emptyRow('Falha ao buscar. Tente novamente.'));
            showState('Falha ao buscar. Tente novamente.', 'danger');
            lastTerm = '';
          } finally {
            btn.disabled = false;
            btn.innerHTML = original;
          }
        }

        btn.addEventListener('click', () => handleBuscar());
        if (form) {
          form.addEventListener('submit', (event) => {
            event.preventDefault();
            handleBuscar();
          });
        }

        if (clearBtn) {
          clearBtn.addEventListener('click', () => {
            input.value = '';
            resetResultados();
            showState('Busca limpa.', 'info');
            input.focus();
            lastTerm = '';
          });
        }

        if (exportBtn) {
          exportBtn.addEventListener('click', exportarTabelaPDF);
        }

        tbody.addEventListener('click', (event) => {
          const botao = event.target instanceof HTMLElement ? event.target.closest('button.prontuario-acao') : null;
          if (!botao) return;
          const prontuario = botao.dataset.prontuario;
          const acao = botao.dataset.acao === 'editar' ? 'edit' : 'view';
          carregarProntuario(prontuario, acao);
        });

        window.prontuarioConsulta = window.prontuarioConsulta || {};
        window.prontuarioConsulta.refresh = () => {
          if (lastTerm) {
            handleBuscar(lastTerm);
          } else {
            resetResultados();
            showState('Tabela atualizada.', 'info');
          }
        };
      })();
    </script>
    <script>
      (function () {
        const novoRegistroBtn = document.getElementById('novoRegistroBtn');
        if (!novoRegistroBtn || novoRegistroBtn.dataset.boundNovoRegistro === 'true') {
          return;
        }

        const fallbackOpenForm = () => {
          if (window.prontuarioFormManager) {
            if (typeof window.prontuarioFormManager.openBlankForm === 'function') {
              window.prontuarioFormManager.openBlankForm('create');
              return;
            }
            if (typeof window.prontuarioFormManager.startNovoRegistro === 'function') {
              window.prontuarioFormManager.startNovoRegistro();
              return;
            }
          }

          const wrapper = document.getElementById('formularioWrapper');
          if (wrapper) {
            wrapper.classList.remove('d-none');
          }
          const modalEl = document.getElementById('registroModal');
          if (modalEl) {
            modalEl.classList.remove('d-none');
            modalEl.setAttribute('aria-hidden', 'false');
            if (typeof modalEl.scrollIntoView === 'function') {
              modalEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
          }
        };

        novoRegistroBtn.addEventListener('click', fallbackOpenForm);
        novoRegistroBtn.dataset.boundNovoRegistro = 'true';
      })();
    </script>
  </body>
</html>
